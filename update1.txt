=== START: index.txt ===
<?php
require_once __DIR__ . '/includes/functions.php';
requireLogin();
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
    <p class="text-gray-600">Welcome back, <?php echo $_SESSION['username']; ?>!</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-users text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Total Patients</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $result = getAllPatients();
                    echo $result->num_rows;
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-calendar-check text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Today's Visits</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $today = date('Y-m-d');
                    $query = "SELECT COUNT(*) as count FROM visits WHERE visit_date = '$today'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo $row['count'];
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                <i class="fas fa-ticket-alt text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Pending Tokens</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $query = "SELECT COUNT(*) as count FROM tokens WHERE status = 'waiting'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo $row['count'];
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-file-invoice-dollar text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Today's Revenue</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $today = date('Y-m-d');
                    $query = "SELECT SUM(paid_amount) as total FROM billing WHERE DATE(created_at) = '$today' AND status = 'paid'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo formatCurrency($row['total'] ?: 0);
                    ?>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Patients</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php
                    $result = getAllPatients();
                    if ($result->num_rows > 0) {
                        while ($row = $result->fetch_assoc()) {
                            echo "<tr>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['age'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['contact'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . date('d M Y', strtotime($row['created_at'])) . "</td>";
                            echo "</tr>";
                        }
                    } else {
                        echo "<tr><td colspan='4' class='px-6 py-4 text-center text-gray-500'>No patients found</td></tr>";
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Visits</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php
                    $result = getAllVisits();
                    if ($result->num_rows > 0) {
                        while ($row = $result->fetch_assoc()) {
                            echo "<tr>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['patient_name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['doctor_name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . date('d M Y', strtotime($row['visit_date'])) . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'><span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800'>Completed</span></td>";
                            echo "</tr>";
                        }
                    } else {
                        echo "<tr><td colspan='4' class='px-6 py-4 text-center text-gray-500'>No visits found</td></tr>";
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<?php include __DIR__ . '/includes/footer.php'; ?>
=== END: index.txt ===

=== START: login.txt ===
<?php
require_once __DIR__ . '/includes/functions.php';
require_once __DIR__ . '/includes/db.php';

// If already logged in, redirect to dashboard
if (isLoggedIn()) {
    header('Location: /lch/index.php');
    exit;
}

// Process login
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];
    
    $query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
    $result = $conn->query($query);
    
    if ($result->num_rows === 1) {
        $user = $result->fetch_assoc();
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['role'] = $user['role'];
        
        header('Location: /lch/index.php');
        exit;
    } else {
        $error = "Invalid username or password";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hospital Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <div class="text-center mb-8">
            <i class="fas fa-hospital text-blue-600 text-5xl mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">Hospital Management System</h1>
            <p class="text-gray-600">Please login to continue</p>
        </div>
        
        <?php if (isset($error)): ?>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <?php echo $error; ?>
        </div>
        <?php endif; ?>
        
        <form method="post" action="/lch/login.php">
            <div class="mb-4">
                <label for="username" class="block text-gray-700 font-medium mb-2">Username</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <input type="text" id="username" name="username" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input type="password" id="password" name="password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <input type="checkbox" id="remember" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="remember" class="ml-2 block text-sm text-gray-700">Remember me</label>
                </div>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</a>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                Login
            </button>
        </form>
        
        <div class="mt-6 text-center text-sm text-gray-600">
            <p>Default credentials:</p>
            <p>Admin: admin / admin123</p>
            <p>Reception: reception / reception123</p>
            <p>Doctor: doctor / doctor123</p>
            <p>Lab: lab / lab123</p>
        </div>
    </div>
</body>
</html>
=== END: login.txt ===

=== START: logout.txt ===
<?php
require_once 'includes/functions.php';

// Destroy session
session_destroy();

// Redirect to login page
header('Location: /lch/login.php');
exit;
?>
=== END: logout.txt ===

=== START: megacode.txt ===
=== START: index.txt ===
<?php
require_once __DIR__ . '/includes/functions.php';
requireLogin();
?>

<?php include __DIR__ . '/includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
    <p class="text-gray-600">Welcome back, <?php echo $_SESSION['username']; ?>!</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-users text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Total Patients</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $result = getAllPatients();
                    echo $result->num_rows;
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-calendar-check text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Today's Visits</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $today = date('Y-m-d');
                    $query = "SELECT COUNT(*) as count FROM visits WHERE visit_date = '$today'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo $row['count'];
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                <i class="fas fa-ticket-alt text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Pending Tokens</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $query = "SELECT COUNT(*) as count FROM tokens WHERE status = 'waiting'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo $row['count'];
                    ?>
                </p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-file-invoice-dollar text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Today's Revenue</h2>
                <p class="text-2xl font-bold">
                    <?php 
                    $today = date('Y-m-d');
                    $query = "SELECT SUM(paid_amount) as total FROM billing WHERE DATE(created_at) = '$today' AND status = 'paid'";
                    $result = $conn->query($query);
                    $row = $result->fetch_assoc();
                    echo formatCurrency($row['total'] ?: 0);
                    ?>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Patients</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php
                    $result = getAllPatients();
                    if ($result->num_rows > 0) {
                        while ($row = $result->fetch_assoc()) {
                            echo "<tr>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['age'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['contact'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . date('d M Y', strtotime($row['created_at'])) . "</td>";
                            echo "</tr>";
                        }
                    } else {
                        echo "<tr><td colspan='4' class='px-6 py-4 text-center text-gray-500'>No patients found</td></tr>";
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Visits</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php
                    $result = getAllVisits();
                    if ($result->num_rows > 0) {
                        while ($row = $result->fetch_assoc()) {
                            echo "<tr>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['patient_name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['doctor_name'] . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'>" . date('d M Y', strtotime($row['visit_date'])) . "</td>";
                            echo "<td class='px-6 py-4 whitespace-nowrap'><span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800'>Completed</span></td>";
                            echo "</tr>";
                        }
                    } else {
                        echo "<tr><td colspan='4' class='px-6 py-4 text-center text-gray-500'>No visits found</td></tr>";
                    }
                    ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<?php include __DIR__ . '/includes/footer.php'; ?>
=== END: index.txt ===

=== START: login.txt ===
<?php
require_once __DIR__ . '/includes/functions.php';
require_once __DIR__ . '/includes/db.php';

// If already logged in, redirect to dashboard
if (isLoggedIn()) {
    header('Location: /lch/index.php');
    exit;
}

// Process login
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];
    
    $query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
    $result = $conn->query($query);
    
    if ($result->num_rows === 1) {
        $user = $result->fetch_assoc();
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];
        $_SESSION['role'] = $user['role'];
        
        header('Location: /lch/index.php');
        exit;
    } else {
        $error = "Invalid username or password";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Hospital Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md">
        <div class="text-center mb-8">
            <i class="fas fa-hospital text-blue-600 text-5xl mb-4"></i>
            <h1 class="text-2xl font-bold text-gray-800">Hospital Management System</h1>
            <p class="text-gray-600">Please login to continue</p>
        </div>
        
        <?php if (isset($error)): ?>
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
            <?php echo $error; ?>
        </div>
        <?php endif; ?>
        
        <form method="post" action="/lch/login.php">
            <div class="mb-4">
                <label for="username" class="block text-gray-700 font-medium mb-2">Username</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <input type="text" id="username" name="username" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-medium mb-2">Password</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-lock text-gray-400"></i>
                    </div>
                    <input type="password" id="password" name="password" class="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
            
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <input type="checkbox" id="remember" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="remember" class="ml-2 block text-sm text-gray-700">Remember me</label>
                </div>
                <a href="#" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</a>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                Login
            </button>
        </form>
        
        <div class="mt-6 text-center text-sm text-gray-600">
            <p>Default credentials:</p>
            <p>Admin: admin / admin123</p>
            <p>Reception: reception / reception123</p>
            <p>Doctor: doctor / doctor123</p>
            <p>Lab: lab / lab123</p>
        </div>
    </div>
</body>
</html>
=== END: megacode.txt ===

=== START: update1.txt ===
git add .
git commit -m "updated token.php and update1.txt"
git push origin main

=== END: update1.txt ===

=== START: db.txt ===
<?php
// Database connection
$host = 'localhost';
$user = 'root';
$pass = '';
$dbname = 'hospital_system';

$conn = new mysqli($host, $user, $pass, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}
?>
=== END: db.txt ===

=== START: footer.txt ===
</div>
        </div>
    </div>

    <script>
        // Toggle sidebar
        document.getElementById('toggle-sidebar').addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        });
        
        // Toggle submenu
        function toggleSubmenu(id) {
            const submenu = document.getElementById(id);
            submenu.classList.toggle('hidden');
        }
        
        // Auto-hide notifications after 5 seconds
        setTimeout(function() {
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(function(notification) {
                notification.style.display = 'none';
            });
        }, 5000);

        // Prevent sidebar toggle when clicking on content area
        document.getElementById('content').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Prevent sidebar toggle when clicking buttons
        document.querySelectorAll('button, a').forEach(function(element) {
            element.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        });
    </script>
</body>
</html>
=== END: footer.txt ===

=== START: functions.txt ===
<?php
// Start session if not already started
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// Database connection
$host = 'localhost';
$user = 'root';
$pass = '';
$dbname = 'hospital_system';

$conn = new mysqli($host, $user, $pass, $dbname);

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Check if user is logged in
function isLoggedIn() {
    return isset($_SESSION['user_id']) && isset($_SESSION['username']);
}

// Check user role
function hasRole($role) {
    if (!isLoggedIn()) return false;
    return $_SESSION['role'] === $role;
}

// Redirect if not logged in
function requireLogin() {
    if (!isLoggedIn()) {
        header('Location: /lch/login.php');
        exit;
    }
}

// NEW: Simple admin check
function isAdmin() {
    return isLoggedIn() && $_SESSION['role'] === 'admin';
}

// FIXED: Redirect if not authorized - EXPLICIT admin handling
function requireRole($role) {
    requireLogin();
    
    // Admin can access EVERYTHING - no restrictions
    if (isAdmin()) {
        return; // Allow access
    }
    
    // For non-admin users, check specific role
    if ($_SESSION['role'] !== $role) {
        header('Location: /lch/index.php?error=access_denied&required=' . $role . '&current=' . $_SESSION['role']);
        exit;
    }
}

// Alternative function for explicit access control
function requireAnyRole($roles) {
    requireLogin();
    
    // Admin can access everything
    if (isAdmin()) {
        return;
    }
    
    // Check if user has any of the specified roles
    if (is_array($roles)) {
        foreach ($roles as $role) {
            if ($_SESSION['role'] === $role) {
                return;
            }
        }
    } else {
        if ($_SESSION['role'] === $roles) {
            return;
        }
    }
    
    header('Location: /lch/index.php?error=access_denied');
    exit;
}

// Generate unique token number
function generateToken($type) {
    global $conn;
    
    $prefix = ($type === 'doctor') ? 'D' : 'L';
    $date = date('Ymd');
    
    $query = "SELECT token_no FROM tokens WHERE token_no LIKE '$prefix$date%' ORDER BY id DESC LIMIT 1";
    $result = $conn->query($query);
    
    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $lastToken = $row['token_no'];
        $lastNumber = intval(substr($lastToken, -3));
        $newNumber = $lastNumber + 1;
    } else {
        $newNumber = 1;
    }
    
    return $prefix . $date . str_pad($newNumber, 3, '0', STR_PAD_LEFT);
}

// Format currency
function formatCurrency($amount) {
    return 'PKR ' . number_format($amount, 2);
}

// Get patient by ID
function getPatient($id) {
    global $conn;
    $query = "SELECT * FROM patients WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get user by ID
function getUser($id) {
    global $conn;
    $query = "SELECT * FROM users WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get staff by ID
function getStaff($id) {
    global $conn;
    $query = "SELECT * FROM staff WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get test by ID
function getTest($id) {
    global $conn;
    $query = "SELECT * FROM tests WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get room by ID
function getRoom($id) {
    global $conn;
    $query = "SELECT * FROM rooms WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get all patients
function getAllPatients() {
    global $conn;
    $query = "SELECT * FROM patients ORDER BY created_at DESC";
    return $conn->query($query);
}

// Get all users
function getAllUsers() {
    global $conn;
    $query = "SELECT * FROM users ORDER BY id";
    return $conn->query($query);
}

// Get all staff
function getAllStaff() {
    global $conn;
    $query = "SELECT * FROM staff ORDER BY id";
    return $conn->query($query);
}

// Get all tests
function getAllTests() {
    global $conn;
    $query = "SELECT * FROM tests ORDER BY id";
    return $conn->query($query);
}

// Get all rooms
function getAllRooms() {
    global $conn;
    $query = "SELECT * FROM rooms ORDER BY id";
    return $conn->query($query);
}

// Get all bills
function getAllBills() {
    global $conn;
    $query = "SELECT b.*, p.name as patient_name FROM billing b JOIN patients p ON b.patient_id = p.id ORDER BY b.created_at DESC";
    return $conn->query($query);
}

// Get all tokens
function getAllTokens() {
    global $conn;
    $query = "SELECT t.*, p.name as patient_name FROM tokens t JOIN patients p ON t.patient_id = p.id ORDER BY t.created_at DESC";
    return $conn->query($query);
}

// Get all lab reports
function getAllLabReports() {
    global $conn;
    $query = "SELECT lr.*, p.name as patient_name FROM lab_reports lr JOIN patients p ON lr.patient_id = p.id ORDER BY lr.created_at DESC";
    return $conn->query($query);
}

// Get all visits
function getAllVisits() {
    global $conn;
    $query = "SELECT v.*, p.name as patient_name, s.name as doctor_name FROM visits v JOIN patients p ON v.patient_id = p.id JOIN staff s ON v.doctor_id = s.id ORDER BY v.visit_date DESC";
    return $conn->query($query);
}

// Get doctor tokens
function getDoctorTokens() {
    global $conn;
    $query = "SELECT t.*, p.name as patient_name FROM tokens t JOIN patients p ON t.patient_id = p.id WHERE t.type = 'doctor' AND t.status = 'waiting' ORDER BY t.created_at ASC";
    return $conn->query($query);
}

// Get lab tokens
function getLabTokens() {
    global $conn;
    $query = "SELECT t.*, p.name as patient_name FROM tokens t JOIN patients p ON t.patient_id = p.id WHERE t.type = 'lab' AND t.status = 'waiting' ORDER BY t.created_at ASC";
    return $conn->query($query);
}

// Get patient visits
function getPatientVisits($patient_id) {
    global $conn;
    $query = "SELECT v.*, s.name as doctor_name FROM visits v JOIN staff s ON v.doctor_id = s.id WHERE v.patient_id = $patient_id ORDER BY v.visit_date DESC";
    return $conn->query($query);
}

// Get patient bills
function getPatientBills($patient_id) {
    global $conn;
    $query = "SELECT * FROM billing WHERE patient_id = $patient_id ORDER BY created_at DESC";
    return $conn->query($query);
}

// Get patient lab reports
function getPatientLabReports($patient_id) {
    global $conn;
    $query = "SELECT * FROM lab_reports WHERE patient_id = $patient_id ORDER BY created_at DESC";
    return $conn->query($query);
}

// Get patient tokens
function getPatientTokens($patient_id) {
    global $conn;
    $query = "SELECT * FROM tokens WHERE patient_id = $patient_id ORDER BY created_at DESC";
    return $conn->query($query);
}

// Get available rooms
function getAvailableRooms() {
    global $conn;
    $query = "SELECT * FROM rooms WHERE status = 'available' ORDER BY id";
    return $conn->query($query);
}

// Get occupied rooms
function getOccupiedRooms() {
    global $conn;
    $query = "SELECT * FROM rooms WHERE status = 'occupied' ORDER BY id";
    return $conn->query($query);
}

// Get revenue report
function getRevenueReport($start_date, $end_date) {
    global $conn;
    $query = "SELECT 
                SUM(CASE WHEN status = 'paid' THEN paid_amount ELSE 0 END) as total_paid,
                SUM(CASE WHEN status = 'unpaid' THEN amount - paid_amount ELSE 0 END) as total_unpaid,
                SUM(CASE WHEN status = 'refund' THEN paid_amount ELSE 0 END) as total_refund
              FROM billing 
              WHERE DATE(created_at) BETWEEN '$start_date' AND '$end_date'";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get patient statistics
function getPatientStatistics($start_date, $end_date) {
    global $conn;
    $query = "SELECT 
                COUNT(DISTINCT patient_id) as unique_patients,
                COUNT(*) as total_visits
              FROM visits 
              WHERE visit_date BETWEEN '$start_date' AND '$end_date'";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

// Get service statistics
function getServiceStatistics($start_date, $end_date) {
    global $conn;
    $query = "SELECT 
                service_name,
                COUNT(*) as count,
                SUM(amount) as total_amount
              FROM billing 
              WHERE DATE(created_at) BETWEEN '$start_date' AND '$end_date'
              GROUP BY service_name
              ORDER BY count DESC";
    return $conn->query($query);
}

// ==================== BIRTH & DEATH RECORDS FUNCTIONS ====================

// Birth Records Functions
function getAllBirthRecords() {
    global $conn;
    $query = "SELECT br.*, p.name as mother_patient_name, s.name as doctor_name 
              FROM birth_records br 
              LEFT JOIN patients p ON br.patient_id = p.id 
              LEFT JOIN staff s ON br.doctor_id = s.id 
              ORDER BY br.created_at DESC";
    return $conn->query($query);
}

function getBirthRecord($id) {
    global $conn;
    $query = "SELECT br.*, p.name as mother_patient_name, p.contact as mother_contact, s.name as doctor_name 
              FROM birth_records br 
              LEFT JOIN patients p ON br.patient_id = p.id 
              LEFT JOIN staff s ON br.doctor_id = s.id 
              WHERE br.id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

function getBirthRecordsByDateRange($start_date, $end_date) {
    global $conn;
    $query = "SELECT br.*, p.name as mother_patient_name, s.name as doctor_name 
              FROM birth_records br 
              LEFT JOIN patients p ON br.patient_id = p.id 
              LEFT JOIN staff s ON br.doctor_id = s.id 
              WHERE DATE(br.date_of_birth) BETWEEN '$start_date' AND '$end_date' 
              ORDER BY br.date_of_birth DESC";
    return $conn->query($query);
}

// Death Records Functions
function getAllDeathRecords() {
    global $conn;
    $query = "SELECT dr.*, p.name as patient_name, s.name as doctor_name 
              FROM death_records dr 
              LEFT JOIN patients p ON dr.patient_id = p.id 
              LEFT JOIN staff s ON dr.doctor_id = s.id 
              ORDER BY dr.created_at DESC";
    return $conn->query($query);
}

function getDeathRecord($id) {
    global $conn;
    $query = "SELECT dr.*, p.name as patient_name, p.contact as patient_contact, s.name as doctor_name 
              FROM death_records dr 
              LEFT JOIN patients p ON dr.patient_id = p.id 
              LEFT JOIN staff s ON dr.doctor_id = s.id 
              WHERE dr.id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

function getDeathRecordsByDateRange($start_date, $end_date) {
    global $conn;
    $query = "SELECT dr.*, p.name as patient_name, s.name as doctor_name 
              FROM death_records dr 
              LEFT JOIN patients p ON dr.patient_id = p.id 
              LEFT JOIN staff s ON dr.doctor_id = s.id 
              WHERE DATE(dr.date_of_death) BETWEEN '$start_date' AND '$end_date' 
              ORDER BY dr.date_of_death DESC";
    return $conn->query($query);
}

// Generate Certificate Numbers
function generateBirthCertificateNumber() {
    global $conn;
    $year = date('Y');
    $query = "SELECT certificate_number FROM birth_records WHERE certificate_number LIKE 'BC$year%' ORDER BY id DESC LIMIT 1";
    $result = $conn->query($query);
    
    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $lastNumber = intval(substr($row['certificate_number'], -4));
        $newNumber = $lastNumber + 1;
    } else {
        $newNumber = 1;
    }
    
    return 'BC' . $year . str_pad($newNumber, 4, '0', STR_PAD_LEFT);
}

function generateDeathCertificateNumber() {
    global $conn;
    $year = date('Y');
    $query = "SELECT certificate_number FROM death_records WHERE certificate_number LIKE 'DC$year%' ORDER BY id DESC LIMIT 1";
    $result = $conn->query($query);
    
    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        $lastNumber = intval(substr($row['certificate_number'], -4));
        $newNumber = $lastNumber + 1;
    } else {
        $newNumber = 1;
    }
    
    return 'DC' . $year . str_pad($newNumber, 4, '0', STR_PAD_LEFT);
}

// Statistics Functions
function getBirthStatistics($start_date, $end_date) {
    global $conn;
    $query = "SELECT 
                COUNT(*) as total_births,
                SUM(CASE WHEN gender = 'Male' THEN 1 ELSE 0 END) as male_births,
                SUM(CASE WHEN gender = 'Female' THEN 1 ELSE 0 END) as female_births,
                SUM(CASE WHEN delivery_type = 'Normal' THEN 1 ELSE 0 END) as normal_deliveries,
                SUM(CASE WHEN delivery_type = 'C-Section' THEN 1 ELSE 0 END) as c_section_deliveries,
                AVG(weight) as avg_weight,
                AVG(length) as avg_length
              FROM birth_records 
              WHERE DATE(date_of_birth) BETWEEN '$start_date' AND '$end_date'";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

function getDeathStatistics($start_date, $end_date) {
    global $conn;
    $query = "SELECT 
                COUNT(*) as total_deaths,
                AVG(age_at_death) as avg_age_at_death,
                SUM(CASE WHEN autopsy_required = 1 THEN 1 ELSE 0 END) as autopsy_cases
              FROM death_records 
              WHERE DATE(date_of_death) BETWEEN '$start_date' AND '$end_date'";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}







//this is code is for prciing updates




// Custom Services Functions
function getAllCustomServices() {
    global $conn;
    $query = "SELECT * FROM custom_services ORDER BY service_type, service_name";
    return $conn->query($query);
}

function getCustomService($id) {
    global $conn;
    $query = "SELECT * FROM custom_services WHERE id = $id";
    $result = $conn->query($query);
    return $result->fetch_assoc();
}

function getActiveCustomServices() {
    global $conn;
    $query = "SELECT * FROM custom_services WHERE status = 'active' ORDER BY service_type, service_name";
    return $conn->query($query);
}

function getCustomServicesByType($type) {
    global $conn;
    $query = "SELECT * FROM custom_services WHERE service_type = '$type' AND status = 'active' ORDER BY service_name";
    return $conn->query($query);
}

function addCustomService($service_name, $service_type, $price, $description = '') {
    global $conn;
    $service_name = mysqli_real_escape_string($conn, $service_name);
    $description = mysqli_real_escape_string($conn, $description);
    
    $query = "INSERT INTO custom_services (service_name, service_type, price, description) 
              VALUES ('$service_name', '$service_type', $price, '$description')";
    
    return $conn->query($query);
}

function updateCustomService($id, $service_name, $service_type, $price, $description = '', $status = 'active') {
    global $conn;
    $service_name = mysqli_real_escape_string($conn, $service_name);
    $description = mysqli_real_escape_string($conn, $description);
    
    $query = "UPDATE custom_services SET 
              service_name = '$service_name', 
              service_type = '$service_type', 
              price = $price, 
              description = '$description',
              status = '$status'
              WHERE id = $id";
    
    return $conn->query($query);
}

function deleteCustomService($id) {
    global $conn;
    $query = "DELETE FROM custom_services WHERE id = $id";
    return $conn->query($query);
}

function toggleCustomServiceStatus($id) {
    global $conn;
    $query = "UPDATE custom_services SET 
              status = CASE WHEN status = 'active' THEN 'inactive' ELSE 'active' END 
              WHERE id = $id";
    return $conn->query($query);
}


// Add these new functions to your existing functions.php file----------------

/**
 * Check if username already exists in the database
 * @param string $username The username to check
 * @param int $exclude_id Optional user ID to exclude from check (for updates)
 * @return bool True if username exists, false otherwise
 */
function isUsernameExists($username, $exclude_id = null) {
    global $conn;
    
    $username = mysqli_real_escape_string($conn, $username);
    $query = "SELECT id FROM users WHERE username = '$username'";
    
    // If excluding a specific user ID (for updates)
    if ($exclude_id !== null) {
        $query .= " AND id != " . intval($exclude_id);
    }
    
    $result = $conn->query($query);
    return $result->num_rows > 0;
}

/**
 * Validate username - checks for duplicates and format
 * @param string $username The username to validate
 * @param int $exclude_id Optional user ID to exclude from check (for updates)
 * @return array Array with 'valid' (bool) and 'message' (string)
 */
function validateUsername($username, $exclude_id = null) {
    // Check if username is empty
    if (empty(trim($username))) {
        return ['valid' => false, 'message' => 'Username cannot be empty'];
    }
    
    // Check minimum length
    if (strlen($username) < 3) {
        return ['valid' => false, 'message' => 'Username must be at least 3 characters long'];
    }
    
    // Check maximum length
    if (strlen($username) > 50) {
        return ['valid' => false, 'message' => 'Username cannot be longer than 50 characters'];
    }
    
    // Check for valid characters (alphanumeric, underscore, hyphen only)
    if (!preg_match('/^[a-zA-Z0-9_-]+$/', $username)) {
        return ['valid' => false, 'message' => 'Username can only contain letters, numbers, underscore, and hyphen'];
    }
    
    // Check if username already exists
    if (isUsernameExists($username, $exclude_id)) {
        return ['valid' => false, 'message' => 'Username already exists. Please choose a different username'];
    }
    
    return ['valid' => true, 'message' => 'Username is valid'];
}

/**
 * Safe user creation with validation
 * @param string $username
 * @param string $password
 * @param string $role
 * @param int $staff_id
 * @return array Result array with 'success' (bool) and 'message' (string)
 */
function createUser($username, $password, $role, $staff_id = null) {
    global $conn;
    
    // Validate username
    $validation = validateUsername($username);
    if (!$validation['valid']) {
        return ['success' => false, 'message' => $validation['message']];
    }
    
    // Validate password
    if (empty(trim($password))) {
        return ['success' => false, 'message' => 'Password cannot be empty'];
    }
    
    if (strlen($password) < 6) {
        return ['success' => false, 'message' => 'Password must be at least 6 characters long'];
    }
    
    // Validate role
    $valid_roles = ['admin', 'reception', 'doctor', 'lab'];
    if (!in_array($role, $valid_roles)) {
        return ['success' => false, 'message' => 'Invalid role selected'];
    }
    
    // Sanitize inputs
    $username = mysqli_real_escape_string($conn, $username);
    $password = mysqli_real_escape_string($conn, $password);
    $role = mysqli_real_escape_string($conn, $role);
    
    // Prepare query
    $query = "INSERT INTO users (username, password, role, staff_id) VALUES ('$username', '$password', '$role', " . 
             ($staff_id ? "'" . intval($staff_id) . "'" : "NULL") . ")";
    
    if ($conn->query($query) === TRUE) {
        return ['success' => true, 'message' => 'User created successfully'];
    } else {
        return ['success' => false, 'message' => 'Error creating user: ' . $conn->error];
    }
}

/**
 * Safe user update with validation
 * @param int $user_id
 * @param string $username
 * @param string $password
 * @param string $role
 * @param int $staff_id
 * @return array Result array with 'success' (bool) and 'message' (string)
 */
function updateUser($user_id, $username, $password, $role, $staff_id = null) {
    global $conn;
    
    // Validate user ID
    $user_id = intval($user_id);
    if ($user_id <= 0) {
        return ['success' => false, 'message' => 'Invalid user ID'];
    }
    
    // Validate username (excluding current user)
    $validation = validateUsername($username, $user_id);
    if (!$validation['valid']) {
        return ['success' => false, 'message' => $validation['message']];
    }
    
    // Validate password
    if (empty(trim($password))) {
        return ['success' => false, 'message' => 'Password cannot be empty'];
    }
    
    if (strlen($password) < 6) {
        return ['success' => false, 'message' => 'Password must be at least 6 characters long'];
    }
    
    // Validate role
    $valid_roles = ['admin', 'reception', 'doctor', 'lab'];
    if (!in_array($role, $valid_roles)) {
        return ['success' => false, 'message' => 'Invalid role selected'];
    }
    
    // Sanitize inputs
    $username = mysqli_real_escape_string($conn, $username);
    $password = mysqli_real_escape_string($conn, $password);
    $role = mysqli_real_escape_string($conn, $role);
    
    // Prepare query
    $query = "UPDATE users SET username = '$username', password = '$password', role = '$role', staff_id = " .
             ($staff_id ? "'" . intval($staff_id) . "'" : "NULL") . " WHERE id = $user_id";
    
    if ($conn->query($query) === TRUE) {
        return ['success' => true, 'message' => 'User updated successfully'];
    } else {
        return ['success' => false, 'message' => 'Error updating user: ' . $conn->error];
    }
}

/**
 * Check if NIC already exists (for patient/staff registration)
 * @param string $nic
 * @param string $table Table name ('patients' or 'staff')
 * @param int $exclude_id Optional ID to exclude from check
 * @return bool
 */
function isNICExists($nic, $table, $exclude_id = null) {
    global $conn;
    
    if (empty(trim($nic))) {
        return false; // Empty NIC is allowed
    }
    
    $nic = mysqli_real_escape_string($conn, $nic);
    $query = "SELECT id FROM $table WHERE nic = '$nic'";
    
    if ($exclude_id !== null) {
        $query .= " AND id != " . intval($exclude_id);
    }
    
    $result = $conn->query($query);
    return $result->num_rows > 0;
}

/**
 * Check if contact number already exists
 * @param string $contact
 * @param string $table Table name ('patients' or 'staff')
 * @param int $exclude_id Optional ID to exclude from check
 * @return bool
 */
function isContactExists($contact, $table, $exclude_id = null) {
    global $conn;
    
    $contact = mysqli_real_escape_string($conn, $contact);
    $query = "SELECT id FROM $table WHERE contact = '$contact' OR phone = '$contact'";
    
    if ($exclude_id !== null) {
        $query .= " AND id != " . intval($exclude_id);
    }
    
    $result = $conn->query($query);
    return $result->num_rows > 0;
}

// Add these functions to the end of your existing functions.php file


?>

=== END: functions.txt ===

=== START: get_patient.txt ===
<?php
include 'db.php';

if (isset($_GET['id'])) {
    $patient_id = $_GET['id'];
    $stmt = $conn->prepare("SELECT name, age, gender FROM patients WHERE id = ?");
    $stmt->bind_param("i", $patient_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($patient = $result->fetch_assoc()) {
        echo json_encode(['success' => true, 'patient' => $patient]);
    } else {
        echo json_encode(['success' => false]);
    }
}
?>
=== END: get_patient.txt ===

=== START: header.txt ===
<?php
// Get the base path regardless of current directory
$basePath = dirname(__DIR__);
require_once $basePath . '/includes/db.php';

// Define the base URL for the project
$baseURL = '/lch'; // Change this to match your project folder name
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar {
            transition: all 0.3s;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .content {
            transition: all 0.3s;
            margin-left: 256px; /* 64 * 4 = 256px (w-64) */
            min-height: 100vh;
        }
        .content.expanded {
            margin-left: 80px;
        }
        
        /* Submenu styling */
        .submenu {
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .submenu.show {
            display: block;
        }
        
        /* Menu header cursor */
        .menu-header {
            cursor: pointer;
        }
        .menu-header:hover {
            background-color: rgb(29, 78, 216); /* hover:bg-blue-700 */
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
        
        /* Prevent sidebar toggle conflicts */
        .no-sidebar-trigger {
            pointer-events: auto !important;
            z-index: 1001;
        }
        
        /* Responsive design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar w-64 bg-blue-800 text-white no-print">
            <!-- Sidebar Content Container -->
            <div class="flex flex-col h-full">
                <!-- Sidebar Header -->
                <div class="p-4 border-b border-blue-700 flex-shrink-0">
                    <h1 class="text-xl font-bold flex items-center">
                        <i class="fas fa-hospital mr-2"></i>
                        <span class="sidebar-text">Hospital System</span>
                    </h1>
                </div>
                
                <!-- Sidebar Navigation - Scrollable Area -->
                <div class="flex-1 overflow-y-auto p-2">
                    <a href="<?php echo $baseURL; ?>/index.php" class="flex items-center p-3 rounded hover:bg-blue-700 <?php echo basename($_SERVER['PHP_SELF']) == 'index.php' ? 'bg-blue-700' : ''; ?>">
                        <i class="fas fa-tachometer-alt w-6"></i>
                        <span class="sidebar-text ml-3">Dashboard</span>
                    </a>
                    
                    <?php if (hasRole('admin') || hasRole('reception')): ?>
                    <div class="mt-2">
                        <div class="menu-header flex items-center p-3 text-blue-300 rounded" data-submenu="reception-submenu">
                            <i class="fas fa-user-plus w-6"></i>
                            <span class="sidebar-text ml-3">Reception</span>
                            <i class="fas fa-chevron-down ml-auto sidebar-text submenu-chevron"></i>
                        </div>
                        <div id="reception-submenu" class="submenu ml-6">
                            <a href="<?php echo $baseURL; ?>/modules/reception/add_patient.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'add_patient.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-user-plus w-5"></i>
                                <span class="sidebar-text ml-2">Add Patient</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/reception/patient_list.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'patient_list.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-list w-5"></i>
                                <span class="sidebar-text ml-2">Patient List</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/reception/token.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'token.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-ticket-alt w-5"></i>
                                <span class="sidebar-text ml-2">Generate Token</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/reception/billing.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'billing.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-file-invoice-dollar w-5"></i>
                                <span class="sidebar-text ml-2">Billing</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/reception/room_allotment.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'room_allotment.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-bed w-5"></i>
                                <span class="sidebar-text ml-2">Room Allotment</span>
                            </a>
                            <!-- Birth & Death Records Menu Item -->
                            <a href="<?php echo $baseURL; ?>/modules/reception/birth_death_records.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo in_array(basename($_SERVER['PHP_SELF']), ['birth_death_records.php', 'add_birth_record.php', 'add_death_record.php', 'view_birth_records.php', 'view_death_records.php', 'birth_certificates.php', 'death_certificates.php', 'birth_record_details.php', 'death_record_details.php']) ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-heart w-5"></i>
                                <span class="sidebar-text ml-2">Birth & Death Records</span>
                            </a>
                        </div>
                    </div>
                    <?php endif; ?>
                    
                    <?php if (hasRole('admin') || hasRole('doctor')): ?>
                    <div class="mt-2">
                        <div class="menu-header flex items-center p-3 text-blue-300 rounded" data-submenu="doctor-submenu">
                            <i class="fas fa-user-md w-6"></i>
                            <span class="sidebar-text ml-3">Doctor</span>
                            <i class="fas fa-chevron-down ml-auto sidebar-text submenu-chevron"></i>
                        </div>
                        <div id="doctor-submenu" class="submenu ml-6">
                            <a href="<?php echo $baseURL; ?>/modules/doctor/patient_queue.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'patient_queue.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-users w-5"></i>
                                <span class="sidebar-text ml-2">Patient Queue</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/doctor/view_patient.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'view_patient.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-user-injured w-5"></i>
                                <span class="sidebar-text ml-2">View Patient</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/doctor/add_comments.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'add_comments.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-comment-medical w-5"></i>
                                <span class="sidebar-text ml-2">Add Comments</span>
                            </a>
                        </div>
                    </div>
                    <?php endif; ?>
                    
                    <?php if (hasRole('admin') || hasRole('lab')): ?>
                    <div class="mt-2">
                        <div class="menu-header flex items-center p-3 text-blue-300 rounded" data-submenu="lab-submenu">
                            <i class="fas fa-flask w-6"></i>
                            <span class="sidebar-text ml-3">Lab</span>
                            <i class="fas fa-chevron-down ml-auto sidebar-text submenu-chevron"></i>
                        </div>
                        <div id="lab-submenu" class="submenu ml-6">
                            <a href="<?php echo $baseURL; ?>/modules/lab/lab_tokens.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'lab_tokens.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-vial w-5"></i>
                                <span class="sidebar-text ml-2">Lab Tokens</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/lab/add_report.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'add_report.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-file-medical w-5"></i>
                                <span class="sidebar-text ml-2">Add Report</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/lab/view_reports.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'view_reports.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-clipboard-list w-5"></i>
                                <span class="sidebar-text ml-2">View Reports</span>
                            </a>
                        </div>
                    </div>
                    <?php endif; ?>
                    
                    <?php if (hasRole('admin')): ?>
                    <div class="mt-2">
                        <div class="menu-header flex items-center p-3 text-blue-300 rounded" data-submenu="admin-submenu">
                            <i class="fas fa-user-shield w-6"></i>
                            <span class="sidebar-text ml-3">Admin</span>
                            <i class="fas fa-chevron-down ml-auto sidebar-text submenu-chevron"></i>
                        </div>
                        <div id="admin-submenu" class="submenu ml-6">
                            <a href="<?php echo $baseURL; ?>/modules/admin/users.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'users.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-users-cog w-5"></i>
                                <span class="sidebar-text ml-2">Manage Users</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/admin/staff.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'staff.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-user-tie w-5"></i>
                                <span class="sidebar-text ml-2">Manage Staff</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/admin/pricing.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'pricing.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-tags w-5"></i>
                                <span class="sidebar-text ml-2">Manage Pricing</span>
                            </a>
                            <a href="<?php echo $baseURL; ?>/modules/admin/reports.php" class="flex items-center p-2 rounded hover:bg-blue-700 text-sm <?php echo basename($_SERVER['PHP_SELF']) == 'reports.php' ? 'bg-blue-700' : ''; ?>">
                                <i class="fas fa-chart-bar w-5"></i>
                                <span class="sidebar-text ml-2">Reports</span>
                            </a>
                        </div>
                    </div>
                    <?php endif; ?>
                </div>
                
                <!-- Logout Button - Fixed at Bottom -->
                <div class="border-t border-blue-700 p-4 flex-shrink-0 bg-blue-800">
                    <a href="<?php echo $baseURL; ?>/logout.php" class="flex items-center p-3 rounded hover:bg-blue-700 no-sidebar-trigger">
                        <i class="fas fa-sign-out-alt w-6"></i>
                        <span class="sidebar-text ml-3">Logout</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="content" class="content flex-1 flex flex-col">
            <!-- Top Navbar -->
            <nav class="bg-white shadow-sm no-print sticky top-0 z-50">
                <div class="px-4 py-3 flex items-center justify-between">
                    <button id="toggle-sidebar" class="text-gray-600 focus:outline-none no-sidebar-trigger">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <button class="text-gray-600 focus:outline-none no-sidebar-trigger">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">3</span>
                            </button>
                        </div>
                        
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">
                                <?php echo strtoupper(substr($_SESSION['username'], 0, 1)); ?>
                            </div>
                            <div class="ml-2">
                                <div class="text-sm font-medium"><?php echo $_SESSION['username']; ?></div>
                                <div class="text-xs text-gray-500"><?php echo ucfirst($_SESSION['role']); ?></div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- Page Content -->
            <div class="flex-1 p-6">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle submenu toggles using event delegation
    document.addEventListener('click', function(e) {
        const menuHeader = e.target.closest('.menu-header');
        if (menuHeader) {
            e.preventDefault();
            e.stopPropagation();
            
            const submenuId = menuHeader.getAttribute('data-submenu');
            const submenu = document.getElementById(submenuId);
            const chevron = menuHeader.querySelector('.submenu-chevron');
            
            if (submenu && chevron) {
                // Toggle submenu visibility
                submenu.classList.toggle('show');
                
                // Toggle chevron direction
                if (submenu.classList.contains('show')) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-up');
                } else {
                    chevron.classList.remove('fa-chevron-up');
                    chevron.classList.add('fa-chevron-down');
                }
            }
        }
    });

    // Initialize submenus based on current page
    const activeSubmenus = ['reception-submenu', 'doctor-submenu', 'lab-submenu', 'admin-submenu'];
    activeSubmenus.forEach(function(submenuId) {
        const submenu = document.getElementById(submenuId);
        if (submenu) {
            // Check if any child has active class
            const activeChild = submenu.querySelector('.bg-blue-700');
            if (activeChild) {
                submenu.classList.add('show');
                // Update chevron for active submenu
                const menuHeader = document.querySelector(`[data-submenu="${submenuId}"]`);
                if (menuHeader) {
                    const chevron = menuHeader.querySelector('.submenu-chevron');
                    if (chevron) {
                        chevron.classList.remove('fa-chevron-down');
                        chevron.classList.add('fa-chevron-up');
                    }
                }
            }
        }
    });

    // Toggle sidebar functionality
    const toggleSidebarBtn = document.getElementById('toggle-sidebar');
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            
            if (window.innerWidth <= 1024) {
                sidebar.classList.toggle('open');
            } else {
                // Desktop behavior
                sidebar.classList.toggle('collapsed');
                content.classList.toggle('expanded');
            }
        });
    }

    // Close sidebar on mobile when clicking outside
    document.addEventListener('click', function(event) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('toggle-sidebar');
        
        // Check if click is outside sidebar and not on toggle button
        if (window.innerWidth <= 1024 && 
            sidebar && toggleBtn &&
            !sidebar.contains(event.target) && 
            !toggleBtn.contains(event.target) &&
            !event.target.classList.contains('no-sidebar-trigger')) {
            sidebar.classList.remove('open');
        }
    });

    // Handle responsive sidebar
    window.addEventListener('resize', function() {
        const sidebar = document.getElementById('sidebar');
        const content = document.getElementById('content');
        
        if (sidebar && content && window.innerWidth > 1024) {
            sidebar.classList.remove('open');
            // Reset to normal state on desktop
            if (sidebar.classList.contains('collapsed')) {
                content.classList.add('expanded');
            } else {
                content.classList.remove('expanded');
            }
        }
    });
});
</script>
=== END: header.txt ===

=== START: pricing.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('admin');

// Process form submission to add new test
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_test'])) {
    $test_name = $_POST['test_name'];
    $price = $_POST['price'];
    
    $query = "INSERT INTO tests (test_name, price) VALUES ('$test_name', $price)";
    
    if ($conn->query($query) === TRUE) {
        $success = "Test added successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to update test
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_test'])) {
    $test_id = $_POST['test_id'];
    $test_name = $_POST['test_name'];
    $price = $_POST['price'];
    
    $query = "UPDATE tests SET test_name = '$test_name', price = $price WHERE id = $test_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Test updated successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to delete test
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_test'])) {
    $test_id = $_POST['test_id'];
    
    $query = "DELETE FROM tests WHERE id = $test_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Test deleted successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to add new room
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_room'])) {
    $room_name = $_POST['room_name'];
    $price = $_POST['price'];
    
    $query = "INSERT INTO rooms (room_name, price) VALUES ('$room_name', $price)";
    
    if ($conn->query($query) === TRUE) {
        $success = "Room added successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to update room
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_room'])) {
    $room_id = $_POST['room_id'];
    $room_name = $_POST['room_name'];
    $price = $_POST['price'];
    
    $query = "UPDATE rooms SET room_name = '$room_name', price = $price WHERE id = $room_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Room updated successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to delete room
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_room'])) {
    $room_id = $_POST['room_id'];
    
    $query = "DELETE FROM rooms WHERE id = $room_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Room deleted successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to add new custom service
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_service'])) {
    $service_name = $_POST['service_name'];
    $service_type = $_POST['service_type'];
    $price = $_POST['price'];
    $description = $_POST['description'];
    
    if (addCustomService($service_name, $service_type, $price, $description)) {
        $success = "Custom service added successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to update custom service
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_service'])) {
    $service_id = $_POST['service_id'];
    $service_name = $_POST['service_name'];
    $service_type = $_POST['service_type'];
    $price = $_POST['price'];
    $description = $_POST['description'];
    $status = $_POST['status'];
    
    if (updateCustomService($service_id, $service_name, $service_type, $price, $description, $status)) {
        $success = "Custom service updated successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to delete custom service
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_service'])) {
    $service_id = $_POST['service_id'];
    
    if (deleteCustomService($service_id)) {
        $success = "Custom service deleted successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to toggle service status
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['toggle_status'])) {
    $service_id = $_POST['service_id'];
    
    if (toggleCustomServiceStatus($service_id)) {
        $success = "Service status updated successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Get all tests
$tests = getAllTests();

// Get all rooms
$rooms = getAllRooms();

// Get all custom services
$custom_services = getAllCustomServices();
?>

<?php include '../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Manage Pricing</h1>
    <p class="text-gray-600">Manage lab tests, room pricing, and custom services</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
</div>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<!-- Tab Navigation -->
<div class="mb-6 border-b border-gray-200">
    <nav class="-mb-px flex space-x-8">
        <button onclick="showTab('lab-tests')" id="lab-tests-tab" class="tab-btn py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
            Lab Tests
        </button>
        <button onclick="showTab('rooms')" id="rooms-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Rooms
        </button>
        <button onclick="showTab('custom-services')" id="custom-services-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Custom Services
        </button>
    </nav>
</div>

<!-- Lab Tests Tab -->
<div id="lab-tests-content" class="tab-content">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Lab Tests</h2>
            <button onclick="showAddTestForm()" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Test
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php while ($test = $tests->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $test['id']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $test['test_name']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($test['price']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="editTest(<?php echo $test['id']; ?>, '<?php echo $test['test_name']; ?>', <?php echo $test['price']; ?>)" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form method="post" action="pricing.php" class="inline" onsubmit="return confirm('Are you sure you want to delete this test?');">
                                    <input type="hidden" name="test_id" value="<?php echo $test['id']; ?>">
                                    <button type="submit" name="delete_test" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Rooms Tab -->
<div id="rooms-content" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Rooms</h2>
            <button onclick="showAddRoomForm()" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Room
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Room Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php while ($room = $rooms->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $room['id']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $room['room_name']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($room['price']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php echo $room['status'] === 'available' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'; ?>">
                                    <?php echo ucfirst($room['status']); ?>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="editRoom(<?php echo $room['id']; ?>, '<?php echo $room['room_name']; ?>', <?php echo $room['price']; ?>)" class="text-blue-600 hover:text-blue-900 mr-3">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form method="post" action="pricing.php" class="inline" onsubmit="return confirm('Are you sure you want to delete this room?');">
                                    <input type="hidden" name="room_id" value="<?php echo $room['id']; ?>">
                                    <button type="submit" name="delete_room" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Custom Services Tab -->
<div id="custom-services-content" class="tab-content hidden">
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-800">Custom Services & Doctor Fees</h2>
            <button onclick="showAddServiceForm()" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Service
            </button>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php while ($service = $custom_services->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $service['id']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div>
                                    <div class="text-sm font-medium text-gray-900"><?php echo $service['service_name']; ?></div>
                                    <?php if (!empty($service['description'])): ?>
                                        <div class="text-sm text-gray-500"><?php echo substr($service['description'], 0, 50) . (strlen($service['description']) > 50 ? '...' : ''); ?></div>
                                    <?php endif; ?>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                    <?php 
                                        if ($service['service_type'] === 'consultation') echo 'bg-blue-100 text-blue-800';
                                        elseif ($service['service_type'] === 'checkup') echo 'bg-green-100 text-green-800';
                                        elseif ($service['service_type'] === 'procedure') echo 'bg-purple-100 text-purple-800';
                                        elseif ($service['service_type'] === 'therapy') echo 'bg-yellow-100 text-yellow-800';
                                        else echo 'bg-gray-100 text-gray-800';
                                    ?>">
                                    <?php echo ucfirst($service['service_type']); ?>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($service['price']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php echo $service['status'] === 'active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'; ?>">
                                    <?php echo ucfirst($service['status']); ?>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="editService(<?php echo $service['id']; ?>, '<?php echo htmlspecialchars($service['service_name'], ENT_QUOTES); ?>', '<?php echo $service['service_type']; ?>', <?php echo $service['price']; ?>, '<?php echo htmlspecialchars($service['description'], ENT_QUOTES); ?>', '<?php echo $service['status']; ?>')" class="text-blue-600 hover:text-blue-900 mr-2">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <form method="post" action="pricing.php" class="inline mr-2">
                                    <input type="hidden" name="service_id" value="<?php echo $service['id']; ?>">
                                    <button type="submit" name="toggle_status" class="text-yellow-600 hover:text-yellow-900">
                                        <i class="fas fa-toggle-<?php echo $service['status'] === 'active' ? 'on' : 'off'; ?>"></i>
                                    </button>
                                </form>
                                <form method="post" action="pricing.php" class="inline" onsubmit="return confirm('Are you sure you want to delete this service?');">
                                    <input type="hidden" name="service_id" value="<?php echo $service['id']; ?>">
                                    <button type="submit" name="delete_service" class="text-red-600 hover:text-red-900">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Test Modal -->
<div id="add-test-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Add New Test</h2>
        <form method="post" action="pricing.php">
            <div class="mb-4">
                <label for="test_name" class="block text-gray-700 font-medium mb-2">Test Name</label>
                <input type="text" id="test_name" name="test_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-6">
                <label for="price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeAddTestModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="add_test" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Add Test
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Test Modal -->
<div id="edit-test-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Edit Test</h2>
        <form method="post" action="pricing.php">
            <input type="hidden" id="edit_test_id" name="test_id">
            
            <div class="mb-4">
                <label for="edit_test_name" class="block text-gray-700 font-medium mb-2">Test Name</label>
                <input type="text" id="edit_test_name" name="test_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-6">
                <label for="edit_price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="edit_price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeEditTestModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="update_test" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Update Test
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Room Modal -->
<div id="add-room-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Add New Room</h2>
        <form method="post" action="pricing.php">
            <div class="mb-4">
                <label for="room_name" class="block text-gray-700 font-medium mb-2">Room Name</label>
                <input type="text" id="room_name" name="room_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-6">
                <label for="room_price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="room_price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeAddRoomModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="add_room" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Add Room
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Room Modal -->
<div id="edit-room-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Edit Room</h2>
        <form method="post" action="pricing.php">
            <input type="hidden" id="edit_room_id" name="room_id">
            
            <div class="mb-4">
                <label for="edit_room_name" class="block text-gray-700 font-medium mb-2">Room Name</label>
                <input type="text" id="edit_room_name" name="room_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-6">
                <label for="edit_room_price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="edit_room_price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeEditRoomModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="update_room" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Update Room
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Custom Service Modal -->
<div id="add-service-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Add New Service</h2>
        <form method="post" action="pricing.php">
            <div class="mb-4">
                <label for="service_name" class="block text-gray-700 font-medium mb-2">Service Name</label>
                <input type="text" id="service_name" name="service_name" placeholder="e.g. General Consultation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-4">
                <label for="service_type" class="block text-gray-700 font-medium mb-2">Service Type</label>
                <select id="service_type" name="service_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="consultation">Consultation</option>
                    <option value="checkup">Checkup</option>
                    <option value="procedure">Procedure</option>
                    <option value="therapy">Therapy</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="service_price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="service_price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-6">
                <label for="service_description" class="block text-gray-700 font-medium mb-2">Description (Optional)</label>
                <textarea id="service_description" name="description" rows="3" placeholder="Brief description of the service" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeAddServiceModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="add_service" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Add Service
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Custom Service Modal -->
<div id="edit-service-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Edit Service</h2>
        <form method="post" action="pricing.php">
            <input type="hidden" id="edit_service_id" name="service_id">
            
            <div class="mb-4">
                <label for="edit_service_name" class="block text-gray-700 font-medium mb-2">Service Name</label>
                <input type="text" id="edit_service_name" name="service_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-4">
                <label for="edit_service_type" class="block text-gray-700 font-medium mb-2">Service Type</label>
                <select id="edit_service_type" name="service_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="consultation">Consultation</option>
                    <option value="checkup">Checkup</option>
                    <option value="procedure">Procedure</option>
                    <option value="therapy">Therapy</option>
                    <option value="other">Other</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="edit_service_price" class="block text-gray-700 font-medium mb-2">Price (PKR)</label>
                <input type="number" id="edit_service_price" name="price" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="mb-4">
                <label for="edit_service_description" class="block text-gray-700 font-medium mb-2">Description</label>
                <textarea id="edit_service_description" name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            
            <div class="mb-6">
                <label for="edit_service_status" class="block text-gray-700 font-medium mb-2">Status</label>
                <select id="edit_service_status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeEditServiceModal()" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                    Cancel
                </button>
                <button type="submit" name="update_service" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    Update Service
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Tab functionality
    function showTab(tabName) {
        // Hide all tab contents
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => content.classList.add('hidden'));
        
        // Remove active styling from all tabs
        const tabs = document.querySelectorAll('.tab-btn');
        tabs.forEach(tab => {
            tab.classList.remove('border-blue-500', 'text-blue-600');
            tab.classList.add('border-transparent', 'text-gray-500');
        });
        
        // Show selected tab content
        document.getElementById(tabName + '-content').classList.remove('hidden');
        
        // Add active styling to selected tab
        const activeTab = document.getElementById(tabName + '-tab');
        activeTab.classList.remove('border-transparent', 'text-gray-500');
        activeTab.classList.add('border-blue-500', 'text-blue-600');
    }

    // Test functions
    function showAddTestForm() {
        document.getElementById('add-test-modal').classList.remove('hidden');
    }
    
    function closeAddTestModal() {
        document.getElementById('add-test-modal').classList.add('hidden');
    }
    
    function editTest(id, test_name, price) {
        document.getElementById('edit_test_id').value = id;
        document.getElementById('edit_test_name').value = test_name;
        document.getElementById('edit_price').value = price;
        
        document.getElementById('edit-test-modal').classList.remove('hidden');
    }
    
    function closeEditTestModal() {
        document.getElementById('edit-test-modal').classList.add('hidden');
    }
    
    // Room functions
    function showAddRoomForm() {
        document.getElementById('add-room-modal').classList.remove('hidden');
    }
    
    function closeAddRoomModal() {
        document.getElementById('add-room-modal').classList.add('hidden');
    }
    
    function editRoom(id, room_name, price) {
        document.getElementById('edit_room_id').value = id;
        document.getElementById('edit_room_name').value = room_name;
        document.getElementById('edit_room_price').value = price;
        
        document.getElementById('edit-room-modal').classList.remove('hidden');
    }
    
    function closeEditRoomModal() {
        document.getElementById('edit-room-modal').classList.add('hidden');
    }
    
    // Custom Service functions
    function showAddServiceForm() {
        document.getElementById('add-service-modal').classList.remove('hidden');
    }
    
    function closeAddServiceModal() {
        document.getElementById('add-service-modal').classList.add('hidden');
    }
    
    function editService(id, service_name, service_type, price, description, status) {
        document.getElementById('edit_service_id').value = id;
        document.getElementById('edit_service_name').value = service_name;
        document.getElementById('edit_service_type').value = service_type;
        document.getElementById('edit_service_price').value = price;
        document.getElementById('edit_service_description').value = description;
        document.getElementById('edit_service_status').value = status;
        
        document.getElementById('edit-service-modal').classList.remove('hidden');
    }
    
    function closeEditServiceModal() {
        document.getElementById('edit-service-modal').classList.add('hidden');
    }
</script>

<?php include '../../includes/footer.php'; ?>
=== END: pricing.txt ===

=== START: reports.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('admin');

// Get date range from form submission
$start_date = isset($_POST['start_date']) ? $_POST['start_date'] : date('Y-m-01');
$end_date = isset($_POST['end_date']) ? $_POST['end_date'] : date('Y-m-d');

// Get revenue report
$revenue_report = getRevenueReport($start_date, $end_date);

// Get patient statistics
$patient_stats = getPatientStatistics($start_date, $end_date);

// Get service statistics
$service_stats = getServiceStatistics($start_date, $end_date);
?>

<?php include '../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Reports</h1>
    <p class="text-gray-600">View hospital statistics and financial reports</p>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Select Date Range</h2>
    <form method="post" action="reports.php" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="start_date" class="block text-gray-700 font-medium mb-2">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="<?php echo $start_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div>
            <label for="end_date" class="block text-gray-700 font-medium mb-2">End Date</label>
            <input type="date" id="end_date" name="end_date" value="<?php echo $end_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition w-full">
                Generate Report
            </button>
        </div>
    </form>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-money-bill-wave text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Total Revenue</h2>
                <p class="text-2xl font-bold"><?php echo formatCurrency($revenue_report['total_paid']); ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                <i class="fas fa-hourglass-half text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Pending Payments</h2>
                <p class="text-2xl font-bold"><?php echo formatCurrency($revenue_report['total_unpaid']); ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-500">
                <i class="fas fa-undo text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Refunds</h2>
                <p class="text-2xl font-bold"><?php echo formatCurrency($revenue_report['total_refund']); ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-users text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Unique Patients</h2>
                <p class="text-2xl font-bold"><?php echo $patient_stats['unique_patients']; ?></p>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Patient Statistics</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-blue-800">Unique Patients</h3>
                    <p class="text-2xl font-bold text-blue-600"><?php echo $patient_stats['unique_patients']; ?></p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="text-sm font-medium text-green-800">Total Visits</h3>
                    <p class="text-2xl font-bold text-green-600"><?php echo $patient_stats['total_visits']; ?></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Revenue Breakdown</h2>
        </div>
        <div class="p-6">
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Paid</span>
                        <span class="text-sm font-medium text-gray-700"><?php echo formatCurrency($revenue_report['total_paid']); ?></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: <?php echo ($revenue_report['total_paid'] / ($revenue_report['total_paid'] + $revenue_report['total_unpaid'] + $revenue_report['total_refund'])) * 100; ?>%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Unpaid</span>
                        <span class="text-sm font-medium text-gray-700"><?php echo formatCurrency($revenue_report['total_unpaid']); ?></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-600 h-2 rounded-full" style="width: <?php echo ($revenue_report['total_unpaid'] / ($revenue_report['total_paid'] + $revenue_report['total_unpaid'] + $revenue_report['total_refund'])) * 100; ?>%"></div>
                    </div>
                </div>
                
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-sm font-medium text-gray-700">Refund</span>
                        <span class="text-sm font-medium text-gray-700"><?php echo formatCurrency($revenue_report['total_refund']); ?></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-red-600 h-2 rounded-full" style="width: <?php echo ($revenue_report['total_refund'] / ($revenue_report['total_paid'] + $revenue_report['total_unpaid'] + $revenue_report['total_refund'])) * 100; ?>%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bg-white rounded-lg shadow mt-6">
    <div class="p-6 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-800">Service Statistics</h2>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Average Amount</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php if ($service_stats->num_rows > 0): ?>
                    <?php while ($service = $service_stats->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $service['service_name']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $service['count']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($service['total_amount']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($service['total_amount'] / $service['count']); ?></td>
                        </tr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-gray-500">No service data available</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<?php include '../../includes/footer.php'; ?>
=== END: reports.txt ===

=== START: staff.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('admin');

// Process form submission to add new staff
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_staff'])) {
    $name = $_POST['name'];
    $address = $_POST['address'];
    $phone = $_POST['phone'];
    $nic = $_POST['nic'];
    $salary = $_POST['salary'];
    $duty_hours = $_POST['duty_hours'];
    $joining_date = $_POST['joining_date'];
    
    $query = "INSERT INTO staff (name, address, phone, nic, salary, duty_hours, joining_date) 
              VALUES ('$name', '$address', '$phone', '$nic', $salary, '$duty_hours', '$joining_date')";
    
    if ($conn->query($query) === TRUE) {
        $success = "Staff member added successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to update staff
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_staff'])) {
    $staff_id = $_POST['staff_id'];
    $name = $_POST['name'];
    $address = $_POST['address'];
    $phone = $_POST['phone'];
    $nic = $_POST['nic'];
    $salary = $_POST['salary'];
    $duty_hours = $_POST['duty_hours'];
    $joining_date = $_POST['joining_date'];
    
    $query = "UPDATE staff SET name = '$name', address = '$address', phone = '$phone', nic = '$nic', 
              salary = $salary, duty_hours = '$duty_hours', joining_date = '$joining_date'
              WHERE id = $staff_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Staff member updated successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Process form submission to delete staff
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_staff'])) {
    $staff_id = $_POST['staff_id'];
    $query = "DELETE FROM staff WHERE id = $staff_id";
    
    if ($conn->query($query) === TRUE) {
        $success = "Staff member deleted successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Get all staff
$staff = getAllStaff();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Staff - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <?php include '../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">Manage Staff</h1>
        
        <?php if (isset($success)): ?>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                <?php echo $success; ?>
            </div>
        <?php endif; ?>
        
        <?php if (isset($error)): ?>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <?php echo $error; ?>
            </div>
        <?php endif; ?>
        
        <!-- Add New Staff Form -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-indigo-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-user-plus mr-2"></i>
                    Add New Staff
                </h2>
            </div>
            <div class="p-6">
                <form method="post">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Full Name</label>
                            <input type="text" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Phone</label>
                            <input type="text" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">NIC</label>
                            <input type="text" name="nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Salary (PKR)</label>
                            <input type="number" name="salary" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Duty Hours</label>
                            <input type="text" name="duty_hours" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Joining Date</label>
                            <input type="date" name="joining_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-gray-700 mb-2">Address</label>
                        <textarea name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" required></textarea>
                    </div>
                    <div class="mt-4">
                        <button type="submit" name="add_staff" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus mr-2"></i>Add Staff
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Hospital Staff Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-indigo-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-users mr-2"></i>
                    Hospital Staff
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Salary</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Joining Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <?php while ($staff_member = $staff->fetch_assoc()): ?>
                            <tr class="hover:bg-gray-50 transition-colors" data-staff-id="<?php echo $staff_member['id']; ?>"
                                data-name="<?php echo htmlspecialchars($staff_member['name']); ?>"
                                data-address="<?php echo htmlspecialchars($staff_member['address']); ?>"
                                data-phone="<?php echo htmlspecialchars($staff_member['phone']); ?>"
                                data-nic="<?php echo htmlspecialchars($staff_member['nic']); ?>"
                                data-salary="<?php echo htmlspecialchars($staff_member['salary']); ?>"
                                data-duty-hours="<?php echo htmlspecialchars($staff_member['duty_hours']); ?>"
                                data-joining-date="<?php echo htmlspecialchars($staff_member['joining_date']); ?>">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                    <?php echo $staff_member['id']; ?>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900"><?php echo $staff_member['name']; ?></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <?php echo $staff_member['phone']; ?>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <?php echo formatCurrency($staff_member['salary']); ?>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <?php echo $staff_member['joining_date']; ?>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button class="bg-yellow-500 text-white px-3 py-1 rounded-md hover:bg-yellow-600 mr-2 text-sm" onclick="editStaff(<?php echo $staff_member['id']; ?>)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 text-sm" onclick="confirmDelete(<?php echo $staff_member['id']; ?>)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <?php endwhile; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Edit Staff Modal -->
    <div id="editStaffModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Edit Staff</h2>
            <form method="post">
                <input type="hidden" id="edit_staff_id" name="staff_id">
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="edit_name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Address</label>
                    <textarea id="edit_address" name="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3" required></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Phone</label>
                    <input type="text" id="edit_phone" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">NIC</label>
                    <input type="text" id="edit_nic" name="nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Salary (PKR)</label>
                    <input type="number" id="edit_salary" name="salary" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Duty Hours</label>
                    <input type="text" id="edit_duty_hours" name="duty_hours" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 mb-2">Joining Date</label>
                    <input type="date" id="edit_joining_date" name="joining_date" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" name="update_staff" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-save mr-2"></i>Update Staff
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4">Confirm Delete</h2>
            <p>Are you sure you want to delete this staff member?</p>
            <div class="flex justify-end mt-4">
                <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mr-2" onclick="closeDeleteModal()">Cancel</button>
                <form method="post" style="display: inline;">
                    <input type="hidden" id="delete_staff_id" name="staff_id">
                    <button type="submit" name="delete_staff" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Edit staff function
        function editStaff(staff_id) {
            const row = document.querySelector(`tr[data-staff-id="${staff_id}"]`);
            
            document.getElementById('edit_staff_id').value = staff_id;
            document.getElementById('edit_name').value = row.getAttribute('data-name');
            document.getElementById('edit_address').value = row.getAttribute('data-address');
            document.getElementById('edit_phone').value = row.getAttribute('data-phone');
            document.getElementById('edit_nic').value = row.getAttribute('data-nic');
            document.getElementById('edit_salary').value = row.getAttribute('data-salary');
            document.getElementById('edit_duty_hours').value = row.getAttribute('data-duty-hours');
            document.getElementById('edit_joining_date').value = row.getAttribute('data-joining-date');
            
            document.getElementById('editStaffModal').classList.remove('hidden');
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editStaffModal').classList.add('hidden');
        }
        
        // Confirm delete
        function confirmDelete(staff_id) {
            document.getElementById('delete_staff_id').value = staff_id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }
    </script>
</body>
</html>
=== END: staff.txt ===

=== START: users.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('admin');

$success = '';
$error = '';

// Process form submission to add new user
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['add_user'])) {
    $username = $_POST['username'];
    $password = $_POST['password'];
    $role = $_POST['role'];
    $staff_id = !empty($_POST['staff_id']) ? $_POST['staff_id'] : null;
    
    // Use the new validation function
    $result = createUser($username, $password, $role, $staff_id);
    
    if ($result['success']) {
        $success = $result['message'];
    } else {
        $error = $result['message'];
    }
}

// Process form submission to update user
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_user'])) {
    $user_id = $_POST['user_id'];
    $username = $_POST['username'];
    $password = $_POST['password'];
    $role = $_POST['role'];
    $staff_id = !empty($_POST['edit_staff_id']) ? $_POST['edit_staff_id'] : null;
    
    // Use the new validation function
    $result = updateUser($user_id, $username, $password, $role, $staff_id);
    
    if ($result['success']) {
        $success = $result['message'];
    } else {
        $error = $result['message'];
    }
}

// Process form submission to delete user
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['delete_user'])) {
    $user_id = intval($_POST['user_id']);
    
    // Check if user exists and is not the current user
    if ($user_id === $_SESSION['user_id']) {
        $error = "You cannot delete your own account";
    } else {
        $query = "DELETE FROM users WHERE id = $user_id";
        if ($conn->query($query) === TRUE) {
            $success = "User deleted successfully";
        } else {
            $error = "Error deleting user: " . $conn->error;
        }
    }
}

// Get all users
$users = getAllUsers();

// Get staff for dropdown
$staff = getAllStaff();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <?php include '../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Manage Users</h1>
            <p class="text-gray-600">Create and manage user accounts for the hospital system</p>
        </div>
        
        <?php if (!empty($success)): ?>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    <?php echo $success; ?>
                </div>
            </div>
        <?php endif; ?>
        
        <?php if (!empty($error)): ?>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <?php echo $error; ?>
                </div>
            </div>
        <?php endif; ?>
        
        <!-- Add New User Form -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-indigo-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-user-plus mr-2"></i>
                    Add New User
                </h2>
            </div>
            <div class="p-6">
                <form method="post" id="addUserForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="username" class="block text-gray-700 font-medium mb-2">Username <span class="text-red-500">*</span></label>
                            <input type="text" 
                                   id="username" 
                                   name="username" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                   required
                                   minlength="3"
                                   maxlength="50"
                                   pattern="[a-zA-Z0-9_-]+"
                                   title="Username can only contain letters, numbers, underscore, and hyphen"
                                   onblur="checkUsername(this.value)">
                            <div id="username-feedback" class="mt-1 text-sm hidden"></div>
                            <div class="mt-1 text-xs text-gray-500">
                                Must be 3-50 characters long. Only letters, numbers, underscore, and hyphen allowed.
                            </div>
                        </div>
                        
                        <div>
                            <label for="password" class="block text-gray-700 font-medium mb-2">Password <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="password" 
                                       id="password" 
                                       name="password" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                                       required
                                       minlength="6">
                                <button type="button" onclick="togglePassword('password')" class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-eye" id="password-toggle"></i>
                                </button>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">
                                Must be at least 6 characters long
                            </div>
                        </div>
                        
                        <div>
                            <label for="role" class="block text-gray-700 font-medium mb-2">Role <span class="text-red-500">*</span></label>
                            <select id="role" name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="reception">Reception</option>
                                <option value="doctor">Doctor</option>
                                <option value="lab">Lab</option>
                            </select>
                        </div>
                        
                        <div id="staff-dropdown" style="display: none;">
                            <label for="staff_id" class="block text-gray-700 font-medium mb-2">Staff Member</label>
                            <select id="staff_id" name="staff_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Staff Member</option>
                                <?php while ($staff_member = $staff->fetch_assoc()): ?>
                                    <option value="<?php echo $staff_member['id']; ?>"><?php echo $staff_member['name']; ?></option>
                                <?php endwhile; ?>
                            </select>
                            <div class="mt-1 text-xs text-gray-500">
                                Link this user account to a staff member (optional for Doctor/Lab roles)
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            <span class="text-red-500">*</span> Required fields
                        </div>
                        <button type="submit" name="add_user" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">
                            <i class="fas fa-plus mr-2"></i>Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- System Users Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-indigo-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-users-cog mr-2"></i>
                    System Users
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Member</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <?php while ($user = $users->fetch_assoc()): ?>
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="text-sm font-medium text-gray-900"><?php echo $user['id']; ?></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-8 w-8">
                                            <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                                                <span class="text-sm font-medium text-indigo-600">
                                                    <?php echo strtoupper(substr($user['username'], 0, 1)); ?>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-3">
                                            <div class="text-sm font-medium text-gray-900"><?php echo $user['username']; ?></div>
                                            <?php if ($user['id'] === $_SESSION['user_id']): ?>
                                                <div class="text-xs text-green-600">(Current User)</div>
                                            <?php endif; ?>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php 
                                        if ($user['role'] === 'admin') echo 'bg-purple-100 text-purple-800';
                                        elseif ($user['role'] === 'reception') echo 'bg-blue-100 text-blue-800';
                                        elseif ($user['role'] === 'doctor') echo 'bg-green-100 text-green-800';
                                        else echo 'bg-yellow-100 text-yellow-800';
                                    ?>">
                                        <i class="fas fa-<?php 
                                            if ($user['role'] === 'admin') echo 'crown';
                                            elseif ($user['role'] === 'reception') echo 'desk';
                                            elseif ($user['role'] === 'doctor') echo 'user-md';
                                            else echo 'flask';
                                        ?> mr-1"></i>
                                        <?php echo ucfirst($user['role']); ?>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <?php 
                                    if ($user['staff_id']) {
                                        $staff_member = getStaff($user['staff_id']);
                                        echo $staff_member ? $staff_member['name'] : '<span class="text-red-500">Staff not found</span>';
                                    } else {
                                        echo '<span class="text-gray-500">Not linked</span>';
                                    }
                                    ?>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1"></i>Active
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button onclick="editUser(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['username'], ENT_QUOTES); ?>', '<?php echo $user['password']; ?>', '<?php echo $user['role']; ?>', <?php echo $user['staff_id'] ?: 'null'; ?>)" 
                                            class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 mr-2">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <?php if ($user['id'] !== $_SESSION['user_id']): ?>
                                    <button onclick="confirmDelete(<?php echo $user['id']; ?>, '<?php echo htmlspecialchars($user['username'], ENT_QUOTES); ?>')" 
                                            class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <?php else: ?>
                                    <span class="text-gray-400 text-xs">(Cannot delete own account)</span>
                                    <?php endif; ?>
                                </td>
                            </tr>
                        <?php endwhile; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div id="editUserModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">
                <i class="fas fa-user-edit mr-2"></i>Edit User
            </h2>
            <form method="post" id="editUserForm">
                <input type="hidden" id="edit_user_id" name="user_id">
                <div class="mb-4">
                    <label for="edit_username" class="block text-gray-700 font-medium mb-2">Username <span class="text-red-500">*</span></label>
                    <input type="text" 
                           id="edit_username" 
                           name="username" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                           required
                           minlength="3"
                           maxlength="50"
                           pattern="[a-zA-Z0-9_-]+"
                           onblur="checkUsername(this.value, document.getElementById('edit_user_id').value)">
                    <div id="edit-username-feedback" class="mt-1 text-sm hidden"></div>
                </div>
                <div class="mb-4">
                    <label for="edit_password" class="block text-gray-700 font-medium mb-2">Password <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input type="password" 
                               id="edit_password" 
                               name="password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" 
                               required
                               minlength="6">
                        <button type="button" onclick="togglePassword('edit_password')" class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-eye" id="edit_password-toggle"></i>
                        </button>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="edit_role" class="block text-gray-700 font-medium mb-2">Role <span class="text-red-500">*</span></label>
                    <select id="edit_role" name="role" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                        <option value="admin">Admin</option>
                        <option value="reception">Reception</option>
                        <option value="doctor">Doctor</option>
                        <option value="lab">Lab</option>
                    </select>
                </div>
                <div id="edit_staff_dropdown" class="mb-4" style="display: none;">
                    <label for="edit_staff_id" class="block text-gray-700 font-medium mb-2">Staff Member</label>
                    <select id="edit_staff_id" name="edit_staff_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Staff Member</option>
                        <?php 
                        $staff->data_seek(0); // Reset pointer
                        while ($staff_member = $staff->fetch_assoc()): ?>
                            <option value="<?php echo $staff_member['id']; ?>"><?php echo $staff_member['name']; ?></option>
                        <?php endwhile; ?>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="submit" name="update_user" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        <i class="fas fa-save mr-2"></i>Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Delete
            </h2>
            <p class="mb-4">Are you sure you want to delete the user "<span id="delete-username" class="font-semibold"></span>"? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeDeleteModal()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                    Cancel
                </button>
                <form method="post" style="display: inline;">
                    <input type="hidden" id="delete_user_id" name="user_id">
                    <button type="submit" name="delete_user" 
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        <i class="fas fa-trash mr-2"></i>Delete User
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        // Show/hide staff dropdown based on role selection
        document.getElementById('role').addEventListener('change', function() {
            const staffDropdown = document.getElementById('staff-dropdown');
            if (this.value === 'doctor' || this.value === 'lab') {
                staffDropdown.style.display = 'block';
            } else {
                staffDropdown.style.display = 'none';
            }
        });
        
        // Handle edit role change
        document.getElementById('edit_role').addEventListener('change', function() {
            const editStaffDropdown = document.getElementById('edit_staff_dropdown');
            if (this.value === 'doctor' || this.value === 'lab') {
                editStaffDropdown.style.display = 'block';
            } else {
                editStaffDropdown.style.display = 'none';
            }
        });
        
        // Username availability checker
        let usernameCheckTimeout;
        function checkUsername(username, excludeId = null) {
            clearTimeout(usernameCheckTimeout);
            
            if (username.length < 3) return;
            
            const feedbackId = excludeId ? 'edit-username-feedback' : 'username-feedback';
            const feedback = document.getElementById(feedbackId);
            
            usernameCheckTimeout = setTimeout(() => {
                // Simulate AJAX call - In real implementation, you'd make an actual AJAX request
                // For now, we'll just do basic validation
                if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                    feedback.className = 'mt-1 text-sm text-red-600';
                    feedback.textContent = 'Invalid characters in username';
                    feedback.classList.remove('hidden');
                } else {
                    feedback.className = 'mt-1 text-sm text-green-600';
                    feedback.textContent = 'Username format is valid';
                    feedback.classList.remove('hidden');
                }
            }, 500);
        }
        
        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(inputId + '-toggle');
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.classList.remove('fa-eye');
                toggle.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                toggle.classList.remove('fa-eye-slash');
                toggle.classList.add('fa-eye');
            }
        }
        
        // Edit user function
        function editUser(id, username, password, role, staffId) {
            document.getElementById('edit_user_id').value = id;
            document.getElementById('edit_username').value = username;
            document.getElementById('edit_password').value = password;
            document.getElementById('edit_role').value = role;
            
            // Show/hide staff dropdown based on role
            const editStaffDropdown = document.getElementById('edit_staff_dropdown');
            if (role === 'doctor' || role === 'lab') {
                editStaffDropdown.style.display = 'block';
                if (staffId) {
                    document.getElementById('edit_staff_id').value = staffId;
                }
            } else {
                editStaffDropdown.style.display = 'none';
            }
            
            document.getElementById('editUserModal').classList.remove('hidden');
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editUserModal').classList.add('hidden');
            document.getElementById('edit-username-feedback').classList.add('hidden');
        }
        
        // Confirm delete
        function confirmDelete(id, username) {
            document.getElementById('delete_user_id').value = id;
            document.getElementById('delete-username').textContent = username;
            document.getElementById('deleteModal').classList.remove('hidden');
        }
        
        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }
        
        // Form validation
        document.getElementById('addUserForm').addEventListener('submit', function(e) {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username.length < 3) {
                e.preventDefault();
                alert('Username must be at least 3 characters long');
                return false;
            }
            
            if (password.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long');
                return false;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                e.preventDefault();
                alert('Username can only contain letters, numbers, underscore, and hyphen');
                return false;
            }
        });
        
        // Similar validation for edit form
        document.getElementById('editUserForm').addEventListener('submit', function(e) {
            const username = document.getElementById('edit_username').value;
            const password = document.getElementById('edit_password').value;
            
            if (username.length < 3) {
                e.preventDefault();
                alert('Username must be at least 3 characters long');
                return false;
            }
            
            if (password.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long');
                return false;
            }
            
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                e.preventDefault();
                alert('Username can only contain letters, numbers, underscore, and hyphen');
                return false;
            }
        });
    </script>
</body>
</html>
=== END: users.txt ===

=== START: add_comments.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('doctor');

// Get patient ID from URL and validate it
if (!isset($_GET['patient_id']) || empty($_GET['patient_id'])) {
    // Redirect back to patient queue if no valid patient ID
    header('Location: /lch/modules/doctor/patient_queue.php?error=no_patient_id');
    exit;
}

$patient_id = intval($_GET['patient_id']);

// Get patient details
$patient = getPatient($patient_id);

// Check if patient exists
if (!$patient) {
    // Redirect back if patient not found
    header('Location: /lch/modules/doctor/patient_queue.php?error=patient_not_found');
    exit;
}

// Initialize variables
$success = '';
$error = '';
$comments = '';
$medicines = '';

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $patient_id = intval($_POST['patient_id']);
    $doctor_id = $_SESSION['user_id']; // Use logged-in user's ID instead of hardcoded
    $visit_date = $_POST['visit_date'];
    $comments = trim($_POST['comments']);
    $medicines = trim($_POST['medicines']);
    
    // Debug information - remove after testing
    error_log("Form submitted - Patient ID: $patient_id, Doctor ID: $doctor_id, Date: $visit_date");
    
    // Validation
    if (empty($visit_date)) {
        $error = "Visit date is required";
    } elseif (empty($comments)) {
        $error = "Comments/Diagnosis is required";
    } elseif (empty($medicines)) {
        $error = "Prescribed medicines is required";
    } else {
        // Insert visit record
        $query = "INSERT INTO visits (patient_id, doctor_id, visit_date, comments, medicines) 
                  VALUES (?, ?, ?, ?, ?)";
        
        $stmt = $conn->prepare($query);
        $stmt->bind_param("iisss", $patient_id, $doctor_id, $visit_date, $comments, $medicines);
        
        if ($stmt->execute()) {
            $visit_id = $conn->insert_id;
            
            // Create billing record for consultation
            $billing_query = "INSERT INTO billing (patient_id, service_name, amount, paid_amount, status) 
                              VALUES (?, 'Doctor Consultation', 1000, 0, 'unpaid')";
            $billing_stmt = $conn->prepare($billing_query);
            $billing_stmt->bind_param("i", $patient_id);
            
            if ($billing_stmt->execute()) {
                $billing_id = $conn->insert_id;
                
                // Update visit with billing ID
                $update_query = "UPDATE visits SET billing_id = ? WHERE id = ?";
                $update_stmt = $conn->prepare($update_query);
                $update_stmt->bind_param("ii", $billing_id, $visit_id);
                $update_stmt->execute();
                
                $success = "Visit record added successfully";
                
                // Clear form fields after successful submission
                $comments = '';
                $medicines = '';
            } else {
                $error = "Error creating billing record: " . $billing_stmt->error;
            }
        } else {
            $error = "Error saving visit record: " . $stmt->error;
        }
    }
}
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Add Visit Comments</h1>
    <p class="text-gray-600">Record patient visit details</p>
</div>

<?php if (isset($_GET['error'])): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php 
    if ($_GET['error'] === 'no_patient_id') {
        echo "No patient ID provided.";
    } elseif ($_GET['error'] === 'patient_not_found') {
        echo "Patient not found.";
    }
    ?>
</div>
<?php endif; ?>

<?php if (!empty($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
    <div class="mt-2">
        <a href="/lch/modules/doctor/view_patient.php?id=<?php echo $patient_id; ?>" class="bg-green-600 text-white py-1 px-3 rounded text-sm hover:bg-green-700">
            <i class="fas fa-eye mr-1"></i> View Patient History
        </a>
        <button onclick="printConsultation()" class="bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700 ml-2">
            <i class="fas fa-print mr-1"></i> Print Consultation Slip
        </button>
    </div>
</div>
<?php endif; ?>

<?php if (!empty($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Patient Information</h2>
            
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">ID:</span>
                    <span class="font-medium"><?php echo $patient['id']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Name:</span>
                    <span class="font-medium"><?php echo $patient['name']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Age:</span>
                    <span class="font-medium"><?php echo $patient['age']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Gender:</span>
                    <span class="font-medium"><?php echo $patient['gender']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Contact:</span>
                    <span class="font-medium"><?php echo $patient['contact']; ?></span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow p-6">
            <form method="post" action="/lch/modules/doctor/add_comments.php?patient_id=<?php echo $patient_id; ?>">
                <input type="hidden" name="patient_id" value="<?php echo $patient_id; ?>">
                
                <div class="mb-4">
                    <label for="visit_date" class="block text-gray-700 font-medium mb-2">Visit Date <span class="text-red-500">*</span></label>
                    <input type="date" id="visit_date" name="visit_date" value="<?php echo date('Y-m-d'); ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="mb-4">
                    <label for="comments" class="block text-gray-700 font-medium mb-2">Comments / Diagnosis <span class="text-red-500">*</span></label>
                    <textarea id="comments" name="comments" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter patient diagnosis, symptoms, and observations..." required><?php echo htmlspecialchars($comments); ?></textarea>
                </div>
                
                <div class="mb-6">
                    <label for="medicines" class="block text-gray-700 font-medium mb-2">Prescribed Medicines <span class="text-red-500">*</span></label>
                    <textarea id="medicines" name="medicines" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter prescribed medicines with dosage and instructions..." required><?php echo htmlspecialchars($medicines); ?></textarea>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <a href="/lch/modules/doctor/view_patient.php?id=<?php echo $patient_id; ?>" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                        Cancel
                    </a>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                        Save Visit Record
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Consultation Slip Print Template -->
<div id="consultation-print" class="hidden">
    <div class="p-6" style="width: 300px; font-family: monospace;">
        <div class="text-center mb-4">
            <h3 class="font-bold text-lg">HOSPITAL MANAGEMENT SYSTEM</h3>
            <p class="text-sm">123 Medical Street, Lahore</p>
            <p class="text-sm">Phone: 0300-1234567</p>
        </div>
        
        <div class="border-t border-b border-dashed py-2 my-2">
            <div class="flex justify-between mb-1">
                <span class="font-bold">DATE:</span>
                <span><?php echo date('d M Y'); ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span class="font-bold">TIME:</span>
                <span><?php echo date('h:i A'); ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">PATIENT DETAILS:</div>
            <div class="flex justify-between mb-1">
                <span>ID:</span>
                <span><?php echo $patient['id']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Name:</span>
                <span><?php echo $patient['name']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Age:</span>
                <span><?php echo $patient['age']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Gender:</span>
                <span><?php echo $patient['gender']; ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">CONSULTATION DETAILS:</div>
            <div class="mb-2">
                <span class="font-bold">Diagnosis:</span>
                <p><?php echo htmlspecialchars($comments); ?></p>
            </div>
            <div>
                <span class="font-bold">Medicines:</span>
                <p><?php echo htmlspecialchars($medicines); ?></p>
            </div>
        </div>
        
        <div class="text-center text-xs mt-6">
            <p>Dr. <?php echo $_SESSION['username']; ?></p>
            <p>Signature: _______________</p>
        </div>
    </div>
</div>

<script>
    function printConsultation() {
        const printContent = document.getElementById('consultation-print').innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        
        // Reload page to restore original content
        location.reload();
    }
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: add_comments.txt ===

=== START: patient_queue.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('doctor');

// Process form submission to mark token as completed
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['complete_token'])) {
    $token_id = $_POST['token_id'];
    $update_query = "UPDATE tokens SET status = 'completed' WHERE id = $token_id";
    if ($conn->query($update_query) === TRUE) {
        $success = "Token marked as completed";
        // Refresh the page to update the list
        header("Location: patient_queue.php?success=token_completed");
        exit;
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Check if patient_id is provided in URL
$patient_id = isset($_GET['patient_id']) ? $_GET['patient_id'] : '';

// Get waiting patients with correct query
$query = "SELECT t.*, p.name as patient_name 
          FROM tokens t 
          JOIN patients p ON t.patient_id = p.id 
          WHERE t.type = 'doctor' AND t.status = 'waiting' 
          ORDER BY t.created_at ASC";
$result = $conn->query($query);

// Get completed consultations for today
$today = date('Y-m-d');
$completed_query = "SELECT t.*, p.name as patient_name 
                   FROM tokens t 
                   JOIN patients p ON t.patient_id = p.id 
                   WHERE t.type = 'doctor' AND t.status = 'completed' AND DATE(t.updated_at) = '$today'
                   ORDER BY t.updated_at DESC";
$completed_result = $conn->query($completed_query);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Queue - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <?php include '../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">Patient Queue</h1>
        
        <?php if (isset($_GET['success']) && $_GET['success'] == 'token_completed'): ?>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                Token marked as completed successfully.
            </div>
        <?php endif; ?>
        
        <?php if (isset($error)): ?>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <?php echo $error; ?>
            </div>
        <?php endif; ?>
        
        <!-- Waiting Patients Section -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-blue-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    Waiting Patients
                </h2>
            </div>
            
            <?php if ($result->num_rows > 0): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Token No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Generated At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php while ($token = $result->fetch_assoc()): ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('d M Y h:i A', strtotime($token['created_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="token_id" value="<?php echo $token['id']; ?>">
                                            <button type="submit" name="complete_token" 
                                                    class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mr-2">
                                                <i class="fas fa-check mr-1"></i> Complete
                                            </button>
                                        </form>
                                        <a href="view_patient.php?id=<?php echo $token['patient_id']; ?>" 
                                           class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                            <i class="fas fa-eye mr-1"></i> View
                                        </a>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                </div>
            <?php else: ?>
                <div class="px-6 py-12 text-center">
                    <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No patients in queue</h3>
                    <p class="text-gray-500">There are no patients waiting for consultation at the moment.</p>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- Today's Completed Consultations Section -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-green-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Today's Completed Consultations
                </h2>
            </div>
            
            <?php if ($completed_result->num_rows > 0): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Token No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Completed At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php while ($token = $completed_result->fetch_assoc()): ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('d M Y h:i A', strtotime($token['updated_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <a href="view_patient.php?id=<?php echo $token['patient_id']; ?>" 
                                           class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-2">
                                            <i class="fas fa-eye mr-1"></i> View
                                        </a>
                                        <a href="add_comments.php?patient_id=<?php echo $token['patient_id']; ?>" 
                                           class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                            <i class="fas fa-comment-medical mr-1"></i> Add Comments
                                        </a>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                </div>
            <?php else: ?>
                <div class="px-6 py-12 text-center">
                    <i class="fas fa-clipboard-check text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No completed consultations today</h3>
                    <p class="text-gray-500">No patient consultations have been completed today.</p>
                </div>
            <?php endif; ?>
        </div>
    </div>
</body>
</html>
=== END: patient_queue.txt ===

=== START: view_patient.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('doctor');

// Process form submission to update visit
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_visit'])) {
    $visit_id = $_POST['visit_id'];
    $comments = $_POST['comments'];
    $medicines = $_POST['medicines'];
    
    // Update visit using prepared statement
    $query = "UPDATE visits SET comments = ?, medicines = ? WHERE id = ?";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("ssi", $comments, $medicines, $visit_id);
    
    if ($stmt->execute()) {
        $success = "Visit record updated successfully";
    } else {
        $error = "Error updating visit record: " . $stmt->error;
    }
}

// Get patient ID from URL and validate it
if (!isset($_GET['id']) || empty($_GET['id'])) {
    // Redirect back to patient queue if no valid patient ID
    header('Location: patient_queue.php');
    exit;
}
$patient_id = $_GET['id'];

// Get patient details
$patient = getPatient($patient_id);

// Check if patient exists
if (!$patient) {
    // Redirect back if patient not found
    header('Location: patient_queue.php?error=patient_not_found');
    exit;
}

// Get patient visits
$visits = getPatientVisits($patient_id);

// Get patient bills
$bills = getPatientBills($patient_id);

// Get patient lab reports with test results
$lab_reports_query = "SELECT lr.*, p.name as patient_name 
                      FROM lab_reports lr 
                      JOIN patients p ON lr.patient_id = p.id 
                      WHERE lr.patient_id = ? 
                      ORDER BY lr.created_at DESC";
$lab_stmt = $conn->prepare($lab_reports_query);
$lab_stmt->bind_param("i", $patient_id);
$lab_stmt->execute();
$lab_reports = $lab_stmt->get_result();

// Get patient tokens
$tokens = getPatientTokens($patient_id);
?>
<?php include __DIR__ . '/../../includes/header.php'; ?>

<!-- Success/Error Messages -->
<?php if (isset($success)): ?>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <?php echo $success; ?>
        </div>
    </div>
<?php endif; ?>

<?php if (isset($error)): ?>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <?php echo $error; ?>
        </div>
    </div>
<?php endif; ?>

<?php if (isset($_GET['error']) && $_GET['error'] === 'patient_not_found'): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    Patient not found.
</div>
<?php endif; ?>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Patient Information</h2>
            
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">ID:</span>
                    <span class="font-medium"><?php echo $patient['id']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Name:</span>
                    <span class="font-medium"><?php echo $patient['name']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Age:</span>
                    <span class="font-medium"><?php echo $patient['age']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Gender:</span>
                    <span class="font-medium"><?php echo $patient['gender']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Contact:</span>
                    <span class="font-medium"><?php echo $patient['contact']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Emergency Contact:</span>
                    <span class="font-medium"><?php echo $patient['emergency_contact'] ?: 'N/A'; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Relative Name:</span>
                    <span class="font-medium"><?php echo $patient['relative_name'] ?: 'N/A'; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">NIC:</span>
                    <span class="font-medium"><?php echo $patient['nic'] ?: 'N/A'; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Address:</span>
                    <span class="font-medium"><?php echo $patient['address'] ?: 'N/A'; ?></span>
                </div>
            </div>
            
            <div class="mt-6">
                <a href="add_comments.php?patient_id=<?php echo $patient_id; ?>" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition block text-center">
                    <i class="fas fa-comment-medical mr-2"></i> Add Visit Comments
                </a>
                <a href="patient_queue.php" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition block text-center mt-2">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Queue
                </a>
            </div>
        </div>
    </div>
    
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow mb-6">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-800">Visit History</h2>
            </div>
            
            <?php if ($visits->num_rows > 0): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Doctor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medicines</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php 
                            // Reset the result pointer to fetch data again
                            $visits->data_seek(0);
                            while ($visit = $visits->fetch_assoc()): 
                            ?>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap"><?php echo date('d M Y', strtotime($visit['visit_date'])); ?></td>
                                    <td class="px-6 py-4 whitespace-nowrap"><?php echo $visit['doctor_name']; ?></td>
                                    <td class="px-6 py-4">
                                        <div class="max-w-xs truncate" title="<?php echo htmlspecialchars($visit['comments'] ?: 'N/A'); ?>">
                                            <?php echo $visit['comments'] ?: 'N/A'; ?>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="max-w-xs truncate" title="<?php echo htmlspecialchars($visit['medicines'] ?: 'N/A'); ?>">
                                            <?php echo $visit['medicines'] ?: 'N/A'; ?>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button onclick="openEditVisitModal(<?php echo $visit['id']; ?>, '<?php echo addslashes($visit['comments']); ?>', '<?php echo addslashes($visit['medicines']); ?>')" 
                                                class="text-yellow-600 hover:text-yellow-900">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                </div>
            <?php else: ?>
                <div class="p-8 text-center">
                    <i class="fas fa-history text-gray-400 text-5xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No visit history</h3>
                    <p class="text-gray-500">This patient has no previous visits recorded.</p>
                </div>
            <?php endif; ?>
        </div>
        
        <div class="grid grid-cols-1 gap-6">
            <!-- Lab Reports Section - Full Width -->
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-800">Lab Reports</h2>
                </div>
                
                <?php if ($lab_reports->num_rows > 0): ?>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Report ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Technician</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <?php while ($report = $lab_reports->fetch_assoc()): ?>
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap font-medium text-sm">#<?php echo str_pad($report['id'], 4, '0', STR_PAD_LEFT); ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="font-medium text-gray-900"><?php echo htmlspecialchars($report['test_name']); ?></div>
                                            <div class="text-sm text-gray-500"><?php echo ucfirst(str_replace('_', ' ', $report['report_type'])); ?></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><?php echo date('d M Y', strtotime($report['created_at'])); ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs rounded-full <?php echo $report['status'] === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'; ?>">
                                                <?php echo ucfirst($report['status']); ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm"><?php echo htmlspecialchars($report['technician_name'] ?: 'N/A'); ?></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                            <button onclick="viewReport(<?php echo $report['id']; ?>)" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-xs">
                                                <i class="fas fa-eye mr-1"></i> View
                                            </button>
                                            <button onclick="printReport(<?php echo $report['id']; ?>)" class="bg-green-600 text-white py-1 px-3 rounded hover:bg-green-700 text-xs">
                                                <i class="fas fa-print mr-1"></i> Print
                                            </button>
                                        </td>
                                    </tr>
                                <?php endwhile; ?>
                            </tbody>
                        </table>
                    </div>
                <?php else: ?>
                    <div class="p-8 text-center">
                        <i class="fas fa-file-medical text-gray-400 text-5xl mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-1">No lab reports</h3>
                        <p class="text-gray-500">No lab reports found for this patient.</p>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>

<!-- Edit Visit Modal -->
<div id="editVisitModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-edit mr-2 text-yellow-600"></i>
                    Edit Visit Record
                </h3>
                <button onclick="closeEditVisitModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editVisitForm" method="POST" class="space-y-4">
                <input type="hidden" name="update_visit" value="1">
                <input type="hidden" name="visit_id" id="edit_visit_id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments / Diagnosis</label>
                    <textarea name="comments" id="edit_comments" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Enter diagnosis or comments..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prescribed Medicines</label>
                    <textarea name="medicines" id="edit_medicines" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Enter prescribed medicines..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditVisitModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Update Visit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// View report in new window - same as print but without auto-print
function viewReport(reportId) {
    // Open the lab report view page in a new window
    window.open(`/lch/modules/lab/report_view.php?id=${reportId}`, '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
}

// Print report function
function printReport(reportId) {
    // Open the print page in a new window
    window.open(`/lch/modules/lab/print_report.php?id=${reportId}`, '_blank', 'width=800,height=600');
}

// Edit visit functions
function openEditVisitModal(visitId, comments, medicines) {
    // Populate form fields
    document.getElementById('edit_visit_id').value = visitId;
    document.getElementById('edit_comments').value = comments.replace(/\\'/g, "'").replace(/\\"/g, '"');
    document.getElementById('edit_medicines').value = medicines.replace(/\\'/g, "'").replace(/\\"/g, '"');
    
    // Show modal
    document.getElementById('editVisitModal').classList.remove('hidden');
}

function closeEditVisitModal() {
    document.getElementById('editVisitModal').classList.add('hidden');
    document.getElementById('editVisitForm').reset();
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editVisitModal');
    if (event.target === modal) {
        closeEditVisitModal();
    }
}
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: view_patient.txt ===

=== START: add_report.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Get patient ID and token ID from URL with validation
$patient_id = isset($_GET['patient_id']) ? intval($_GET['patient_id']) : 0;
$token_id = isset($_GET['token_id']) ? intval($_GET['token_id']) : 0;

// Validate patient ID
if ($patient_id <= 0) {
    header('Location: /lch/modules/lab/lab_tokens.php?error=no_patient_id');
    exit;
}

// Get patient details with validation
$patient = getPatient($patient_id);
if (!$patient) {
    header('Location: /lch/modules/lab/lab_tokens.php?error=patient_not_found');
    exit;
}

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $patient_id = intval($_POST['patient_id']);
    $token_id = intval($_POST['token_id']);
    $report_type = $_POST['report_type'];
    $technician_name = $_POST['technician_name'];
    $remarks = $_POST['remarks'] ?? '';
    
    // Validation
    if (empty($report_type)) {
        $error = "Please select a report type";
    } else {
        // Insert main lab report
        $query = "INSERT INTO lab_reports (patient_id, test_name, file_path, status, report_type, technician_name, remarks) 
                  VALUES (?, ?, ?, 'completed', ?, ?, ?)";
        
        $test_display_name = ucfirst(str_replace('_', ' ', $report_type)) . ' Report';
        $filename = $report_type . '_' . $patient_id . '_' . time() . '.html';
        
        $stmt = $conn->prepare($query);
        $stmt->bind_param("isssss", $patient_id, $test_display_name, $filename, $report_type, $technician_name, $remarks);
        
        if ($stmt->execute()) {
            $lab_report_id = $conn->insert_id;
            
            // Insert individual test results
            $all_saved = true;
            if (isset($_POST['test_results'])) {
                foreach ($_POST['test_results'] as $category => $tests) {
                    foreach ($tests as $test_name => $result_value) {
                        if (!empty($result_value)) {
                            // Get reference data for this test
                            $ref_query = "SELECT unit, reference_range FROM test_templates WHERE report_type = ? AND test_category = ? AND test_name = ?";
                            $ref_stmt = $conn->prepare($ref_query);
                            $ref_stmt->bind_param("sss", $report_type, $category, $test_name);
                            $ref_stmt->execute();
                            $ref_result = $ref_stmt->get_result();
                            $ref_data = $ref_result->fetch_assoc();
                            
                            $unit = $ref_data['unit'] ?? '';
                            $reference_range = $ref_data['reference_range'] ?? '';
                            
                            // Insert test result
                            $result_query = "INSERT INTO lab_test_results (lab_report_id, test_category, test_name, result_value, unit, reference_range) 
                                           VALUES (?, ?, ?, ?, ?, ?)";
                            $result_stmt = $conn->prepare($result_query);
                            $result_stmt->bind_param("isssss", $lab_report_id, $category, $test_name, $result_value, $unit, $reference_range);
                            
                            if (!$result_stmt->execute()) {
                                $all_saved = false;
                                break;
                            }
                        }
                    }
                    if (!$all_saved) break;
                }
            }
            
            if ($all_saved) {
                // Generate HTML report file for printing
                $report_html = generateReportHTML($patient, $report_type, $technician_name, $remarks, $_POST['test_results'] ?? [], $lab_report_id);
                $report_file_path = '../../uploads/reports/' . $filename;
                
                // Create uploads directory if it doesn't exist
                if (!is_dir('../../uploads/reports/')) {
                    mkdir('../../uploads/reports/', 0755, true);
                }
                
                file_put_contents($report_file_path, $report_html);
                
                $success = "Lab report saved successfully";
                // Store the latest report data for print
                $latest_report_data = [
                    'patient' => $patient,
                    'report_type' => $report_type,
                    'technician_name' => $technician_name,
                    'remarks' => $remarks,
                    'test_results' => $_POST['test_results'] ?? [],
                    'lab_report_id' => $lab_report_id,
                    'filename' => $filename
                ];
            } else {
                $error = "Error saving test results";
            }
        } else {
            $error = "Error creating report: " . $stmt->error;
        }
    }
}

// Function to generate report HTML for saving and printing
function generateReportHTML($patient, $report_type, $technician_name, $remarks, $test_results, $lab_report_id) {
    $current_date = date('d/m/Y');
    $current_time = date('h:i A');
    
    $header_class = ($report_type == 'bio_chemistry' || $report_type == 'haematology') ? 'red' : 'blue';
    $title_color = ($report_type == 'bio_chemistry' || $report_type == 'haematology') ? '#dc2626' : '#2563eb';
    
    $report_titles = [
        'bio_chemistry' => 'BIO CHEMISTRY REPORT',
        'haematology' => 'HAEMATOLOGY REPORT', 
        'urine_analysis' => 'URINE ANALYSIS',
        'serology' => 'SEROLOGY REPORT'
    ];
    
    $html = '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 0%, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: ' . $title_color . ';
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 0%, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: ' . $title_color . '; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: ' . htmlspecialchars($patient['name']) . ' &nbsp;&nbsp;&nbsp; Age: ' . $patient['age'] . ' &nbsp;&nbsp;&nbsp; Sex: ' . $patient['gender'] . ' &nbsp;&nbsp;&nbsp; Date: ' . $current_date . '
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>' . $report_titles[$report_type] . '</h2>';
    
    // Add test results table based on report type
    if (!empty($test_results)) {
        if ($report_type == 'bio_chemistry') {
            $html .= '<table class="report-table">
                <thead><tr>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                </tr></thead><tbody>';
        } else {
            $html .= '<table class="report-table">
                <thead><tr>
                    <th style="width: 30%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 15%">UNIT</th>
                    <th style="width: 30%">REFERENCE RANGE</th>
                </tr></thead><tbody>';
        }
        
        foreach ($test_results as $category => $tests) {
            $html .= '<tr class="category-header"><td colspan="4"><strong>' . htmlspecialchars($category) . '</strong></td></tr>';
            foreach ($tests as $test_name => $result_value) {
                if (!empty($result_value)) {
                    // Get reference range from your database
                    global $conn;
                    $ref_stmt = $conn->prepare("SELECT unit, reference_range FROM test_templates WHERE report_type = ? AND test_name = ?");
                    $ref_stmt->bind_param("ss", $report_type, $test_name);
                    $ref_stmt->execute();
                    $ref_result = $ref_stmt->get_result();
                    $ref_data = $ref_result->fetch_assoc();
                    
                    $unit = $ref_data['unit'] ?? '';
                    $reference = $ref_data['reference_range'] ?? '';
                    
                    $html .= '<tr>
                        <td>' . htmlspecialchars($test_name) . '</td>
                        <td class="result-value">' . htmlspecialchars($result_value) . '</td>
                        <td style="text-align: center;">' . htmlspecialchars($unit) . '</td>
                        <td style="font-size: 9px;">' . htmlspecialchars($reference) . '</td>';
                    
                    if ($report_type == 'bio_chemistry') {
                        $html .= '<td colspan="4"></td>';
                    }
                    $html .= '</tr>';
                }
            }
        }
        
        $html .= '</tbody></table>';
    }
    
    $html .= '<div style="margin-top: 30px;">
        <p><strong>Technician:</strong> ' . htmlspecialchars($technician_name) . '</p>
        <p><strong>Remarks:</strong> ' . htmlspecialchars($remarks) . '</p>
        <p><strong>Date & Time:</strong> ' . $current_date . ' at ' . $current_time . '</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>';
    
    return $html;
}
?>

<?php include '../../includes/header.php'; ?>

<style>
/* Shahmir Laboratory Styling */
.shahmir-header {
    background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
    color: white;
    padding: 15px;
    border-radius: 8px 8px 0 0;
    position: relative;
    overflow: hidden;
}

.shahmir-header.blue {
    background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
}

.shahmir-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0,0 Q50,20 100,0 L100,20 L0,20 Z" fill="rgba(0,0,0,0.1)"/></svg>');
    background-size: 100% 100%;
}

.shahmir-logo {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.logo-circle {
    width: 60px;
    height: 60px;
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.1);
}

.report-table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    font-size: 11px;
    font-family: Arial, sans-serif;
}

.report-table th,
.report-table td {
    border: 1px solid #333;
    padding: 4px 6px;
    text-align: left;
    vertical-align: top;
}

.report-table th {
    background-color: #f5f5f5;
    font-weight: bold;
    text-align: center;
    font-size: 10px;
}

.category-header {
    background-color: #e5e5e5 !important;
    font-weight: bold;
    text-align: center;
    color: #dc2626;
    font-size: 11px;
}

.category-header.blue {
    color: #2563eb;
}

.test-input {
    border: none;
    background: transparent;
    width: 100%;
    padding: 1px;
    font-size: 10px;
    min-height: 16px;
}

.test-input:focus {
    outline: 1px solid #2563eb;
    background: #f0f9ff;
}

.unit-cell {
    min-width: 50px;
    text-align: center;
    font-size: 9px;
    font-weight: bold;
}

.reference-cell {
    min-width: 120px;
    font-size: 9px;
    line-height: 1.1;
    padding: 2px 4px;
}

.hospital-footer {
    background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
    color: white;
    padding: 8px;
    text-align: center;
    border-radius: 0 0 8px 8px;
    font-size: 10px;
    margin-top: 15px;
}

.hospital-footer.red {
    background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
}

.patient-info-row {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
    font-size: 11px;
    color: #333;
}

.print-only {
    display: none;
}

@media print {
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    .shahmir-header { break-inside: avoid; }
    .report-table { break-inside: avoid; }
    body { font-size: 11px; }
}
</style>

<div class="mb-6 no-print">
    <h1 class="text-2xl font-bold text-gray-800">Add Lab Report</h1>
    <p class="text-gray-600">Create professional lab reports with Shahmir Laboratory format</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 no-print">
    <?php echo $success; ?>
    <div class="mt-2">
        <button onclick="printReport()" class="bg-green-600 text-white py-1 px-3 rounded text-sm hover:bg-green-700">
            <i class="fas fa-print mr-1"></i> Print Report
        </button>
        <a href="/lch/modules/lab/lab_tokens.php" class="bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700 ml-2">
            <i class="fas fa-arrow-left mr-1"></i> Back to Lab Tokens
        </a>
    </div>
</div>

<!-- Print Section -->
<?php if (isset($latest_report_data)): ?>
<div class="print-only">
    <?php
    // Display the generated HTML report for printing
    echo generateReportHTML(
        $latest_report_data['patient'],
        $latest_report_data['report_type'], 
        $latest_report_data['technician_name'],
        $latest_report_data['remarks'],
        $latest_report_data['test_results'],
        $latest_report_data['lab_report_id']
    );
    ?>
</div>
<?php endif; ?>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 no-print">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 no-print">
    <!-- Patient Info Sidebar -->
    <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow p-6 sticky top-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Patient Information</h2>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">ID:</span>
                    <span class="font-medium"><?php echo $patient['id']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Name:</span>
                    <span class="font-medium"><?php echo $patient['name']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Age:</span>
                    <span class="font-medium"><?php echo $patient['age']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Gender:</span>
                    <span class="font-medium"><?php echo $patient['gender']; ?></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Contact:</span>
                    <span class="font-medium"><?php echo $patient['contact']; ?></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="lg:col-span-3">
        <div class="bg-white rounded-lg shadow p-6">
            <form method="post" action="/lch/modules/lab/add_report.php?patient_id=<?php echo $patient_id; ?>&token_id=<?php echo $token_id; ?>" id="reportForm">
                <input type="hidden" name="patient_id" value="<?php echo $patient_id; ?>">
                <input type="hidden" name="token_id" value="<?php echo $token_id; ?>">
                
                <!-- Report Type Selection -->
                <div class="mb-6">
                    <label for="report_type" class="block text-gray-700 font-medium mb-2">Select Report Type <span class="text-red-500">*</span></label>
                    <select id="report_type" name="report_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="loadReportForm()">
                        <option value="">Choose a report type</option>
                        <option value="bio_chemistry">Bio Chemistry Report</option>
                        <option value="haematology">Haematology Report</option>
                        <option value="urine_analysis">Urine Analysis</option>
                        <option value="serology">Serology Report</option>
                    </select>
                </div>

                <!-- Technician Name -->
                <div class="mb-4">
                    <label for="technician_name" class="block text-gray-700 font-medium mb-2">Lab Technician Name</label>
                    <input type="text" id="technician_name" name="technician_name" value="<?php echo $_SESSION['username']; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <!-- Dynamic Report Form Container -->
                <div id="reportFormContainer"></div>

                <!-- Remarks -->
                <div class="mb-6" id="remarksSection" style="display: none;">
                    <label for="remarks" class="block text-gray-700 font-medium mb-2">Remarks</label>
                    <textarea id="remarks" name="remarks" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Any additional observations or comments..."></textarea>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-3" id="formActions" style="display: none;">
                    <a href="/lch/modules/lab/lab_tokens.php" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                        Cancel
                    </a>
                    <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                        Save Report & Generate
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function loadReportForm() {
    const reportType = document.getElementById('report_type').value;
    const container = document.getElementById('reportFormContainer');
    const remarksSection = document.getElementById('remarksSection');
    const formActions = document.getElementById('formActions');
    
    if (!reportType) {
        container.innerHTML = '';
        remarksSection.style.display = 'none';
        formActions.style.display = 'none';
        return;
    }
    
    // Show remarks and actions
    remarksSection.style.display = 'block';
    formActions.style.display = 'flex';
    
    // Generate form based on type
    let formHTML = '';
    
    switch(reportType) {
        case 'bio_chemistry':
            formHTML = generateBioChemistryForm();
            break;
        case 'haematology':
            formHTML = generateHaematologyForm();
            break;
        case 'urine_analysis':
            formHTML = generateUrineAnalysisForm();
            break;
        case 'serology':
            formHTML = generateSerologyForm();
            break;
    }
    
    container.innerHTML = formHTML;
}

function generateBioChemistryForm() {
    return `
        <div class="shahmir-header">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div class="shahmir-logo">
                        <div class="logo-circle">
                            <i class="fas fa-microscope text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Shahmir Laboratory</h1>
                            <p class="text-sm opacity-90">Facility Available for Multi Lab Collection</p>
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <p><strong>Timings</strong></p>
                        <p>Monday-Sunday: Open Round The Clock</p>
                    </div>
                </div>
                <div class="patient-info-row">
                    <span>Name: <?php echo $patient['name']; ?> &nbsp;&nbsp;&nbsp; Age: <?php echo $patient['age']; ?> &nbsp;&nbsp;&nbsp; Sex: <?php echo $patient['gender']; ?> &nbsp;&nbsp;&nbsp; Date: <?php echo date('d/m/Y'); ?></span>
                </div>
                <div class="text-sm">
                    Referred By.........................................................................................................................................
                </div>
            </div>
        </div>
        
        <h2 class="text-xl font-bold text-red-600 my-4">BIO CHEMISTRY REPORT</h2>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr class="category-header">
                    <td colspan="4"><strong>BLOOD GLUCOSE LEVELS</strong></td>
                    <td colspan="4"><strong>CARDIAC ENZYMES</strong></td>
                </tr>
                <tr>
                    <td>Glucose (Fasting)</td>
                    <td><input type="text" name="test_results[BLOOD GLUCOSE LEVELS][Glucose (Fasting)]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">60 - 110</td>
                    <td>SGOT (AST)</td>
                    <td><input type="text" name="test_results[CARDIAC ENZYMES][SGOT (AST)]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">Upto: 38</td>
                </tr>
                <tr>
                    <td>Glucose (Random)</td>
                    <td><input type="text" name="test_results[BLOOD GLUCOSE LEVELS][Glucose (Random)]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">80 - 160</td>
                    <td>LDH</td>
                    <td><input type="text" name="test_results[CARDIAC ENZYMES][LDH]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">160 - 320</td>
                </tr>
                <tr class="category-header">
                    <td colspan="4"><strong>LIVER FUNCTION TEST</strong></td>
                    <td>CK-NAC</td>
                    <td><input type="text" name="test_results[CARDIAC ENZYMES][CK-NAC]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">Male: &lt;190<br>Female: &lt;167</td>
                </tr>
                <tr>
                    <td>Bilirubin (Total)</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Bilirubin (Total)]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">up to : 1.0<br>After 1 Week: 5.0</td>
                    <td colspan="4" class="category-header"><strong>RENAL FUNCTION TEST</strong></td>
                </tr>
                <tr>
                    <td>Bilirubin (Direct)</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Bilirubin (Direct)]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">up to : 0.4</td>
                    <td>Blood Urea</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Blood Urea]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">up to : 50</td>
                </tr>
                <tr>
                    <td>Bilirubin (Indirect)</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Bilirubin (Indirect)]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">up to : 0.8</td>
                    <td>Creatinine</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Creatinine]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">up to : 1.1</td>
                </tr>
                <tr>
                    <td>ALT (SGPT)</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][ALT (SGPT)]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">up to : 42</td>
                    <td>Uric Acid</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Uric Acid]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Male: 3.4 - 7.0<br>Female: 2.4 - 5.7<br>Children: 2.0 - 5.5</td>
                </tr>
                <tr>
                    <td>Alkaline Phosphatase</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Alkaline Phosphatase]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">Male: 80-306<br>Female: 64-306<br>Children: Upto: 644</td>
                    <td>BUN</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][BUN]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">15 - 40</td>
                </tr>
                <tr>
                    <td>Gamma GT</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Gamma GT]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">Male: Upto: 51<br>Female: Upto: 30</td>
                    <td>Sodium</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Sodium]" class="test-input"></td>
                    <td class="unit-cell">mmol/L</td>
                    <td class="reference-cell">135 - 145</td>
                </tr>
                <tr>
                    <td>Albumin</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Albumin]" class="test-input"></td>
                    <td class="unit-cell">G/dl</td>
                    <td class="reference-cell">3.5 - 5.5</td>
                    <td>Potassium</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Potassium]" class="test-input"></td>
                    <td class="unit-cell">mmol/L</td>
                    <td class="reference-cell">3.5 - 5.5</td>
                </tr>
                <tr>
                    <td>Protein (Total)</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Protein (Total)]" class="test-input"></td>
                    <td class="unit-cell">G/dl</td>
                    <td class="reference-cell">Premature: 3.6 - 7.0<br>Children: 5.1 - 7.5<br>Adults: 6.0 - 8.3</td>
                    <td>Calcium</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Calcium]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">8.1 - 10.4</td>
                </tr>
                <tr>
                    <td>Globulins</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][Globulins]" class="test-input"></td>
                    <td class="unit-cell">G/dl</td>
                    <td class="reference-cell">1.5 - 3.0</td>
                    <td>Phosphorous</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][Phosphorous]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Premature: 4.0-8.0<br>Children: 2.5-6.0<br>Adults: 2.7-4.5</td>
                </tr>
                <tr>
                    <td>A/G Ratio</td>
                    <td><input type="text" name="test_results[LIVER FUNCTION TEST][A/G Ratio]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">1.5:1 - &lt; 2.5:1</td>
                    <td>CPK-MB</td>
                    <td><input type="text" name="test_results[RENAL FUNCTION TEST][CPK-MB]" class="test-input"></td>
                    <td class="unit-cell">U/L</td>
                    <td class="reference-cell">05-24</td>
                </tr>
                <tr class="category-header">
                    <td colspan="8"><strong>LIPID PROFILE</strong></td>
                </tr>
                <tr>
                    <td>Cholesterol</td>
                    <td><input type="text" name="test_results[LIPID PROFILE][Cholesterol]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Adults: &lt; 190</td>
                    <td colspan="4"></td>
                </tr>
                <tr>
                    <td>Triglycerides</td>
                    <td><input type="text" name="test_results[LIPID PROFILE][Triglycerides]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Suspected: 165</td>
                    <td colspan="4"></td>
                </tr>
                <tr>
                    <td>HDL Cholesterol</td>
                    <td><input type="text" name="test_results[LIPID PROFILE][HDL Cholesterol]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Male: >55<br>Female: >65</td>
                    <td colspan="4"></td>
                </tr>
                <tr>
                    <td>LDL Cholesterol</td>
                    <td><input type="text" name="test_results[LIPID PROFILE][LDL Cholesterol]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">Borderline: &lt;130<br>Suspicious: &lt;130<br>Elevated: &lt;190</td>
                    <td colspan="4"></td>
                </tr>
                <tr>
                    <td>VLDL Cholesterol</td>
                    <td><input type="text" name="test_results[LIPID PROFILE][VLDL Cholesterol]" class="test-input"></td>
                    <td class="unit-cell">mg/dl</td>
                    <td class="reference-cell">03 - 32</td>
                    <td colspan="4"></td>
                </tr>
            </tbody>
        </table>
        
        <div class="hospital-footer red">
            <p class="font-bold">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
            <p class="text-xs">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
        </div>
    `;
}

function generateHaematologyForm() {
    return `
        <div class="shahmir-header">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div class="shahmir-logo">
                        <div class="logo-circle">
                            <i class="fas fa-microscope text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Shahmir Laboratory</h1>
                            <p class="text-sm opacity-90">Facility Available for Multi Lab Collection</p>
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <p><strong>Timings</strong></p>
                        <p>Monday-Sunday: Open Round The Clock</p>
                    </div>
                </div>
                <div class="patient-info-row">
                    <span>Name: <?php echo $patient['name']; ?> &nbsp;&nbsp;&nbsp; Age: <?php echo $patient['age']; ?> &nbsp;&nbsp;&nbsp; Sex: <?php echo $patient['gender']; ?> &nbsp;&nbsp;&nbsp; Date: <?php echo date('d/m/Y'); ?></span>
                </div>
                <div class="text-sm">
                    Referred By.........................................................................................................................................
                </div>
            </div>
        </div>
        
        <h2 class="text-xl font-bold text-red-600 my-4">HAEMATOLOGY REPORT</h2>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 20%">RESULT</th>
                    <th style="width: 15%">UNIT</th>
                    <th style="width: 40%">REFERENCE RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>WBC Count</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][WBC Count]" class="test-input"></td>
                    <td class="unit-cell">/cmm</td>
                    <td class="reference-cell">4,000 - 11,000</td>
                </tr>
                <tr>
                    <td>R.B.C Count</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][R.B.C Count]" class="test-input"></td>
                    <td class="unit-cell">Million/Cmm</td>
                    <td class="reference-cell">4.25-5.9</td>
                </tr>
                <tr>
                    <td>Haemoglobin</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][Haemoglobin]" class="test-input"></td>
                    <td class="unit-cell">g/dl</td>
                    <td class="reference-cell">(M): 13- 18, (F): 12 - 16</td>
                </tr>
                <tr>
                    <td>PCV / HCT</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][PCV / HCT]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">40-50</td>
                </tr>
                <tr>
                    <td>MCV</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][MCV]" class="test-input"></td>
                    <td class="unit-cell">fl</td>
                    <td class="reference-cell">80-95</td>
                </tr>
                <tr>
                    <td>MCH</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][MCH]" class="test-input"></td>
                    <td class="unit-cell">Pg</td>
                    <td class="reference-cell">27-34</td>
                </tr>
                <tr>
                    <td>MCHC</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][MCHC]" class="test-input"></td>
                    <td class="unit-cell">g/dl</td>
                    <td class="reference-cell">30-35</td>
                </tr>
                <tr>
                    <td>Platelet Count</td>
                    <td><input type="text" name="test_results[HAEMATOLOGY REPORT][Platelet Count]" class="test-input"></td>
                    <td class="unit-cell">/Cmm</td>
                    <td class="reference-cell">150,000 - 400,000</td>
                </tr>
                <tr class="category-header">
                    <td colspan="4"><strong>Different Leukocyte Count (DLC)</strong></td>
                </tr>
                <tr>
                    <td>Neutrophils</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Neutrophils]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">60 after age of 02 years</td>
                </tr>
                <tr>
                    <td>Lymphocytes</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Lymphocytes]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">35 after age of 02 year</td>
                </tr>
                <tr>
                    <td>Monocytes</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Monocytes]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">04 - 09</td>
                </tr>
                <tr>
                    <td>Eosinophils</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Eosinophils]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">00 - 04</td>
                </tr>
                <tr>
                    <td>Basophils</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Basophils]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Blast Cells</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Blast Cells]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Reticulocytes Count</td>
                    <td><input type="text" name="test_results[Different Leukocyte Count (DLC)][Reticulocytes Count]" class="test-input"></td>
                    <td class="unit-cell">%</td>
                    <td class="reference-cell">2.0</td>
                </tr>
                <tr class="category-header">
                    <td colspan="4"><strong>ESR</strong></td>
                </tr>
                <tr>
                    <td>ESR</td>
                    <td><input type="text" name="test_results[ESR][ESR]" class="test-input"></td>
                    <td class="unit-cell">1st hour / mm</td>
                    <td class="reference-cell">(M): Upto:20, (F): upto:15</td>
                </tr>
                <tr class="category-header">
                    <td colspan="4"><strong>RBC MORPHOLOGY</strong></td>
                </tr>
                <tr>
                    <td>Microcytosis</td>
                    <td><input type="text" name="test_results[RBC MORPHOLOGY][Microcytosis]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">Sickle Cells</td>
                </tr>
                <tr>
                    <td>Macrocytosis</td>
                    <td><input type="text" name="test_results[RBC MORPHOLOGY][Macrocytosis]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">Spherocytes</td>
                </tr>
                <tr>
                    <td>Anisocytosis</td>
                    <td><input type="text" name="test_results[RBC MORPHOLOGY][Anisocytosis]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">Elliptocytosis</td>
                </tr>
                <tr>
                    <td>Hypochromia</td>
                    <td><input type="text" name="test_results[RBC MORPHOLOGY][Hypochromia]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">Target Cells</td>
                </tr>
                <tr>
                    <td>Poikilocytosis</td>
                    <td><input type="text" name="test_results[RBC MORPHOLOGY][Poikilocytosis]" class="test-input"></td>
                    <td class="unit-cell"></td>
                    <td class="reference-cell">Normochromic</td>
                </tr>
            </tbody>
        </table>
        
        <div class="hospital-footer red">
            <p class="font-bold">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
            <p class="text-xs">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
        </div>
    `;
}

function generateUrineAnalysisForm() {
    return `
        <div class="shahmir-header blue">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div class="shahmir-logo">
                        <div class="logo-circle">
                            <i class="fas fa-microscope text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Shahmir Laboratory</h1>
                            <p class="text-sm opacity-90">Facility Available for Multi Lab Collection</p>
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <p><strong>Timings</strong></p>
                        <p>Monday-Sunday: Open Round The Clock</p>
                    </div>
                </div>
                <div class="patient-info-row">
                    <span>Name: <?php echo $patient['name']; ?> &nbsp;&nbsp;&nbsp; Age: <?php echo $patient['age']; ?> &nbsp;&nbsp;&nbsp; Sex: <?php echo $patient['gender']; ?> &nbsp;&nbsp;&nbsp; Date: <?php echo date('d/m/Y'); ?></span>
                </div>
                <div class="text-sm">
                    Referred By.........................................................................................................................................
                </div>
            </div>
        </div>
        
        <h2 class="text-xl font-bold text-blue-600 my-4">URINE ANALYSIS</h2>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 30%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 45%">REFERENCE RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr class="category-header blue">
                    <td colspan="3"><strong>PHYSICAL ANALYSIS</strong></td>
                </tr>
                <tr>
                    <td>Colour</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Colour]" class="test-input"></td>
                    <td class="reference-cell">Pale Yellow</td>
                </tr>
                <tr>
                    <td>Turbidity</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Turbidity]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>pH</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][pH]" class="test-input"></td>
                    <td class="reference-cell">5.0-6.0</td>
                </tr>
                <tr>
                    <td>Specific Gravity</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Specific Gravity]" class="test-input"></td>
                    <td class="reference-cell">1.005 - 1.030 (After 12 hrs,<br>Fluid restriction > 1.025)</td>
                </tr>
                <tr>
                    <td>Glucose</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Glucose]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Albumin (Protein)</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Albumin (Protein)]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Blood</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Blood]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Ketones</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Ketones]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Nitrate</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Nitrate]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Bilirubin</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Bilirubin]" class="test-input"></td>
                    <td class="reference-cell">Nil</td>
                </tr>
                <tr>
                    <td>Urobilinogen</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Urobilinogen]" class="test-input"></td>
                    <td class="reference-cell">Normal</td>
                </tr>
                <tr>
                    <td>Leukocytes</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Leukocytes]" class="test-input"></td>
                    <td class="reference-cell">Negative</td>
                </tr>
                <tr>
                    <td>Bile Salt</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Bile Salt]" class="test-input"></td>
                    <td class="reference-cell">Negative</td>
                </tr>
                <tr>
                    <td>Bile Pigment</td>
                    <td><input type="text" name="test_results[PHYSICAL ANALYSIS][Bile Pigment]" class="test-input"></td>
                    <td class="reference-cell">Normal</td>
                </tr>
                <tr class="category-header blue">
                    <td colspan="3"><strong>MICROSCOPIC ANALYSIS</strong></td>
                </tr>
                <tr>
                    <td>Pus Cells</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Pus Cells]" class="test-input"></td>
                    <td class="reference-cell">M:00- 03, F:00 - 05/HPF</td>
                </tr>
                <tr>
                    <td>Red Blood Cells</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Red Blood Cells]" class="test-input"></td>
                    <td class="reference-cell">00 - 02 / HPF</td>
                </tr>
                <tr>
                    <td>Epithelial Cells</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Epithelial Cells]" class="test-input"></td>
                    <td class="reference-cell">M:00- 03, F:00 - 10/HPF</td>
                </tr>
                <tr>
                    <td>Casts</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Casts]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Amorphous Urates</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Amorphous Urates]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Amorphour Phosphates</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Amorphour Phosphates]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Spermatozoa</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Spermatozoa]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Bacteria</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Bacteria]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Mucus Thread</td>
                    <td><input type="text" name="test_results[MICROSCOPIC ANALYSIS][Mucus Thread]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr class="category-header blue">
                    <td colspan="3"><strong>CRYSTALS</strong></td>
                </tr>
                <tr>
                    <td>Calcium Oxalate Crystals</td>
                    <td><input type="text" name="test_results[CRYSTALS][Calcium Oxalate Crystals]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Uric Acid Crystals</td>
                    <td><input type="text" name="test_results[CRYSTALS][Uric Acid Crystals]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
                <tr>
                    <td>Tripple Phosphate Crystals</td>
                    <td><input type="text" name="test_results[CRYSTALS][Tripple Phosphate Crystals]" class="test-input"></td>
                    <td class="reference-cell">Nil / HPF</td>
                </tr>
            </tbody>
        </table>
        
        <div class="hospital-footer">
            <p class="font-bold">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
            <p class="text-xs">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
        </div>
    `;
}

function generateSerologyForm() {
    return `
        <div class="shahmir-header blue">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div class="shahmir-logo">
                        <div class="logo-circle">
                            <i class="fas fa-microscope text-white text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-bold">Shahmir Laboratory</h1>
                            <p class="text-sm opacity-90">Facility Available for Multi Lab Collection</p>
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <p><strong>Timings</strong></p>
                        <p>Monday-Sunday: Open Round The Clock</p>
                    </div>
                </div>
                <div class="patient-info-row">
                    <span>Name: <?php echo $patient['name']; ?> &nbsp;&nbsp;&nbsp; Age: <?php echo $patient['age']; ?> &nbsp;&nbsp;&nbsp; Sex: <?php echo $patient['gender']; ?> &nbsp;&nbsp;&nbsp; Date: <?php echo date('d/m/Y'); ?></span>
                </div>
                <div class="text-sm">
                    Referred By.........................................................................................................................................
                </div>
            </div>
        </div>
        
        <h2 class="text-xl font-bold text-blue-600 my-4">SEROLOGY REPORT</h2>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 20%">RESULT</th>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 30%">RESULT</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Hbs Ag by (Screening)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Hbs Ag by (Screening)]" class="test-input"></td>
                    <td>Pregnancy Test (ICT)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Pregnancy Test (ICT)]" class="test-input"></td>
                </tr>
                <tr>
                    <td>Anti HCV by(Screening)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Anti HCV by(Screening)]" class="test-input"></td>
                    <td>Toxoplasma (IgG)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Toxoplasma (IgG)]" class="test-input"></td>
                </tr>
                <tr>
                    <td>Dengue (IgG)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Dengue (IgG)]" class="test-input"></td>
                    <td>Toxoplasma (IgM)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Toxoplasma (IgM)]" class="test-input"></td>
                </tr>
                <tr>
                    <td>Dengue (IgM)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Dengue (IgM)]" class="test-input"></td>
                    <td>Tuberculosis (IgG)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Tuberculosis (IgG)]" class="test-input"></td>
                </tr>
                <tr>
                    <td>H. Pylori Antibody</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][H. Pylori Antibody]" class="test-input"></td>
                    <td>Tuberculosis (IgM)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Tuberculosis (IgM)]" class="test-input"></td>
                </tr>
                <tr>
                    <td>HIV (AIDS)by (Screening)</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][HIV (AIDS)by (Screening)]" class="test-input"></td>
                    <td>Chickengunya IgG</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Chickengunya IgG]" class="test-input"></td>
                </tr>
                <tr>
                    <td>ICT Malaria Parasite Ag</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][ICT Malaria Parasite Ag]" class="test-input"></td>
                    <td>Chickengunya IgM</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][Chickengunya IgM]" class="test-input"></td>
                </tr>
                <tr>
                    <td>VDRL Test</td>
                    <td><input type="text" name="test_results[SEROLOGY REPORT][VDRL Test]" class="test-input"></td>
                    <td colspan="2"></td>
                </tr>
            </tbody>
        </table>
        
        <h3 class="text-lg font-bold text-blue-600 my-4">COAGULATION PROFILE</h3>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 25%">UNIT</th>
                    <th style="width: 25%">REFERENCE RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Prothrombin time</td>
                    <td><input type="text" name="test_results[COAGULATION PROFILE][Prothrombin time]" class="test-input"></td>
                    <td class="unit-cell">Seconds</td>
                    <td class="reference-cell">11-13</td>
                </tr>
                <tr>
                    <td>Control</td>
                    <td><input type="text" name="test_results[COAGULATION PROFILE][Control]" class="test-input"></td>
                    <td class="unit-cell">Seconds</td>
                    <td class="reference-cell">11-13</td>
                </tr>
                <tr>
                    <td>APTT</td>
                    <td><input type="text" name="test_results[COAGULATION PROFILE][APTT]" class="test-input"></td>
                    <td class="unit-cell">Seconds</td>
                    <td class="reference-cell">25-35</td>
                </tr>
                <tr>
                    <td>INR</td>
                    <td><input type="text" name="test_results[COAGULATION PROFILE][INR]" class="test-input"></td>
                    <td class="unit-cell">Seconds</td>
                    <td class="reference-cell">0.8-1.2</td>
                </tr>
            </tbody>
        </table>
        
        <h3 class="text-lg font-bold text-blue-600 my-4">BLEEDING TIME</h3>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 25%">UNIT</th>
                    <th style="width: 25%">REFERENCE RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Bleeding Time</td>
                    <td><input type="text" name="test_results[BLEEDING TIME][Bleeding Time]" class="test-input"></td>
                    <td class="unit-cell">Min / Sec</td>
                    <td class="reference-cell">01 - 06 Minutes</td>
                </tr>
            </tbody>
        </table>
        
        <h3 class="text-lg font-bold text-blue-600 my-4">CLOTTING TIME</h3>
        
        <table class="report-table">
            <thead>
                <tr>
                    <th style="width: 25%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 25%">UNIT</th>
                    <th style="width: 25%">REFERENCE RANGE</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Clotting Time</td>
                    <td><input type="text" name="test_results[CLOTTING TIME][Clotting Time]" class="test-input"></td>
                    <td class="unit-cell">Min / Sec</td>
                    <td class="reference-cell">03 - 10 Minutes</td>
                </tr>
            </tbody>
        </table>
        
        <div class="hospital-footer">
            <p class="font-bold">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
            <p class="text-xs">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
        </div>
    `;
}

function printReport() {
    window.print();
}
</script>

<?php include '../../includes/footer.php'; ?>
=== END: add_report.txt ===

=== START: get_form.txt ===
<?php
include '../includes/db.php';

if (!isset($_GET['type'])) {
    exit('No test type specified');
}

$test_type = $_GET['type'];

// Map test types to report types in database
$report_type_map = [
    'cbc' => 'haematology',
    'biochem' => 'bio_chemistry', 
    'serology' => 'serology',
    'urine' => 'urine_analysis'
];

if (!isset($report_type_map[$test_type])) {
    exit('Invalid test type');
}

$report_type = $report_type_map[$test_type];

// Get test templates from database
$stmt = $conn->prepare("SELECT * FROM test_templates WHERE report_type = ? ORDER BY display_order ASC");
$stmt->bind_param("s", $report_type);
$stmt->execute();
$result = $stmt->get_result();

$tests = [];
while ($row = $result->fetch_assoc()) {
    $tests[] = $row;
}

if (empty($tests)) {
    exit('No tests found for this type');
}

// Group tests by category
$grouped_tests = [];
foreach ($tests as $test) {
    $grouped_tests[$test['test_category']][] = $test;
}

// Set header colors based on report type
$header_color = ($report_type == 'bio_chemistry' || $report_type == 'haematology') ? 'bg-red-600' : 'bg-blue-600';
$report_title = [
    'bio_chemistry' => 'BIO CHEMISTRY REPORT',
    'haematology' => 'HAEMATOLOGY REPORT', 
    'urine_analysis' => 'URINE ANALYSIS',
    'serology' => 'SEROLOGY REPORT'
];
?>

<div class="lab-report-form bg-white p-6 border rounded-lg">
    <!-- Hospital Header -->
    <div class="text-center mb-6 border-b pb-4">
        <div class="flex items-center justify-center mb-2">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-blue-800">SHAHMIR LABORATORY</h1>
                <p class="text-sm text-gray-600">Facility Available for Multi Lab Collection</p>
            </div>
        </div>
    </div>

    <!-- Report Header -->
    <div class="<?php echo $header_color; ?> text-white text-center py-2 mb-4 rounded">
        <h2 class="text-lg font-bold"><?php echo $report_title[$report_type]; ?></h2>
    </div>

    <!-- Patient Info Section -->
    <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
        <div>
            <strong>Patient Name:</strong> <span id="patient-name">__________________</span><br>
            <strong>Age:</strong> <span id="patient-age">____</span> &nbsp;&nbsp;
            <strong>Gender:</strong> <span id="patient-gender">____</span>
        </div>
        <div class="text-right">
            <strong>Date:</strong> <?php echo date('d/m/Y'); ?><br>
            <strong>Sample ID:</strong> <span id="sample-id">__________</span>
        </div>
    </div>

    <!-- Test Results Form -->
    <?php foreach ($grouped_tests as $category => $category_tests): ?>
        <div class="mb-6">
            <h3 class="text-lg font-semibold bg-gray-100 p-2 mb-3 rounded"><?php echo $category; ?></h3>
            
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300 text-sm">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="border border-gray-300 p-2 text-left">Test</th>
                            <th class="border border-gray-300 p-2 text-center">Result</th>
                            <th class="border border-gray-300 p-2 text-center">Unit</th>
                            <th class="border border-gray-300 p-2 text-center">Reference Range</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($category_tests as $test): ?>
                        <tr>
                            <td class="border border-gray-300 p-2 font-medium">
                                <?php echo htmlspecialchars($test['test_name']); ?>
                            </td>
                            <td class="border border-gray-300 p-2">
                                <input 
                                    type="text" 
                                    name="test_results[<?php echo $category; ?>][<?php echo $test['test_name']; ?>]"
                                    class="w-full p-1 border rounded text-center focus:border-blue-500 focus:outline-none"
                                    placeholder="Enter result"
                                >
                            </td>
                            <td class="border border-gray-300 p-2 text-center text-gray-600">
                                <?php echo htmlspecialchars($test['unit'] ?? ''); ?>
                            </td>
                            <td class="border border-gray-300 p-2 text-center text-gray-600 text-xs">
                                <?php echo nl2br(htmlspecialchars($test['reference_range'] ?? '')); ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    <?php endforeach; ?>

    <!-- Footer -->
    <div class="mt-8 pt-4 border-t text-center text-sm text-gray-600">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p><strong>Lab Technician:</strong> ________________</p>
                <p class="mt-2">Signature & Date</p>
            </div>
            <div>
                <p><strong>Pathologist:</strong> ________________</p>
                <p class="mt-2">Signature & Date</p>
            </div>
        </div>
        <div class="mt-4 text-xs">
            <p><strong>Life Care Hospital</strong></p>
            <p>Contact: 0345-9007891 | Address: Your Hospital Address</p>
        </div>
    </div>
</div>

<script>
// Auto-populate patient data when form loads
document.addEventListener('DOMContentLoaded', function() {
    const patientId = document.querySelector('input[name="patient_id"]').value;
    if (patientId) {
        // Fetch patient data
        fetch('../includes/get_patient.php?id=' + patientId)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('patient-name').textContent = data.patient.name;
                    document.getElementById('patient-age').textContent = data.patient.age;
                    document.getElementById('patient-gender').textContent = data.patient.gender;
                    document.getElementById('sample-id').textContent = 'S' + patientId + Date.now().toString().slice(-4);
                }
            })
            .catch(error => console.log('Error fetching patient data:', error));
    }
});
</script>
=== END: get_form.txt ===

=== START: lab_tokens.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Process form submission to mark token as completed
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['complete_token'])) {
    $token_id = $_POST['token_id'];
    $update_query = "UPDATE tokens SET status = 'completed' WHERE id = $token_id";
    if ($conn->query($update_query) === TRUE) {
        $success = "Token marked as completed";
        // Refresh the page to update the list
        header("Location: lab_tokens.php?success=token_completed");
        exit;
    } else {
        $error = "Error: " . $conn->error;
    }
}

// Get waiting patients with correct query
$query = "SELECT t.*, p.name as patient_name, ts.test_name 
          FROM tokens t 
          JOIN patients p ON t.patient_id = p.id 
          LEFT JOIN tests ts ON t.test_id = ts.id 
          WHERE t.type = 'lab' AND t.status = 'waiting' 
          ORDER BY t.created_at ASC";
$result = $conn->query($query);

// Get completed tests for today
$today = date('Y-m-d');
$completed_query = "SELECT t.*, p.name as patient_name, ts.test_name 
                   FROM tokens t 
                   JOIN patients p ON t.patient_id = p.id 
                   LEFT JOIN tests ts ON t.test_id = ts.id 
                   WHERE t.type = 'lab' AND t.status = 'completed' AND DATE(t.updated_at) = '$today'
                   ORDER BY t.updated_at DESC";
$completed_result = $conn->query($completed_query);
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lab Tokens - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <?php include '../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-2xl font-bold mb-6">Lab Tokens</h1>
        
        <?php if (isset($_GET['success']) && $_GET['success'] == 'token_completed'): ?>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
                Token marked as completed successfully.
            </div>
        <?php endif; ?>
        
        <?php if (isset($error)): ?>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                <?php echo $error; ?>
            </div>
        <?php endif; ?>
        
        <!-- Waiting Patients Section -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-blue-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-clock mr-2"></i>
                    Waiting Patients
                </h2>
            </div>
            
            <?php if ($result->num_rows > 0): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Token No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Generated At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php while ($token = $result->fetch_assoc()): ?>
                                <?php 
                                // Check if report already exists
                                $report_exists_query = "SELECT id FROM lab_reports WHERE patient_id = {$token['patient_id']} AND test_name = '{$token['test_name']}' AND created_at >= '{$token['created_at']}'";
                                $report_exists = $conn->query($report_exists_query);
                                $has_report = $report_exists->num_rows > 0;
                                ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900"><?php echo $token['test_name']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('d M Y h:i A', strtotime($token['created_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <?php if ($has_report): ?>
                                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                <i class="fas fa-check-circle mr-1"></i> Report Added
                                            </span>
                                        <?php else: ?>
                                            <a href="add_report.php?patient_id=<?php echo $token['patient_id']; ?>&test_id=<?php echo $token['test_id']; ?>&token_id=<?php echo $token['id']; ?>" 
                                               class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 mr-2">
                                                <i class="fas fa-plus mr-1"></i> Add Report
                                            </a>
                                        <?php endif; ?>
                                        
                                        <form method="post" style="display: inline;">
                                            <input type="hidden" name="token_id" value="<?php echo $token['id']; ?>">
                                            <button type="submit" name="complete_token" 
                                                    class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                                <i class="fas fa-check mr-1"></i> Complete
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                </div>
            <?php else: ?>
                <div class="px-6 py-12 text-center">
                    <i class="fas fa-users text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No patients in queue</h3>
                    <p class="text-gray-500">There are no patients waiting for lab tests at the moment.</p>
                </div>
            <?php endif; ?>
        </div>
        
        <!-- Today's Completed Tests Section -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-green-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>
                    Today's Completed Tests
                </h2>
            </div>
            
            <?php if ($completed_result->num_rows > 0): ?>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Token No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-40">Completed At</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-48">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php while ($token = $completed_result->fetch_assoc()): ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('d M Y h:i A', strtotime($token['updated_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <a href="view_reports.php?patient_id=<?php echo $token['patient_id']; ?>" 
                                           class="inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                            <i class="fas fa-file-medical mr-1"></i> View Reports
                                        </a>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        </tbody>
                    </table>
                </div>
            <?php else: ?>
                <div class="px-6 py-12 text-center">
                    <i class="fas fa-clipboard-check text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">No completed tests today</h3>
                    <p class="text-gray-500">No lab tests have been completed today.</p>
                </div>
            <?php endif; ?>
        </div>
    </div>
</body>
</html>
=== END: lab_tokens.txt ===

=== START: print_report.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Get report ID from URL
$report_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($report_id <= 0) {
    die('Invalid report ID');
}

// Get report details
$query = "SELECT lr.*, p.name as patient_name, p.age, p.gender 
          FROM lab_reports lr 
          JOIN patients p ON lr.patient_id = p.id 
          WHERE lr.id = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $report_id);
$stmt->execute();
$result = $stmt->get_result();
$report = $result->fetch_assoc();

if (!$report) {
    die('Report not found');
}

// Get test results for this report
$results_query = "SELECT * FROM lab_test_results WHERE lab_report_id = ? ORDER BY test_category, test_name";
$results_stmt = $conn->prepare($results_query);
$results_stmt->bind_param("i", $report_id);
$results_stmt->execute();
$results_result = $results_stmt->get_result();

$test_results = [];
while ($row = $results_result->fetch_assoc()) {
    $test_results[$row['test_category']][] = $row;
}

// Check if HTML report file exists and try to display it first
$report_file = '../../uploads/reports/' . $report['file_path'];
if (file_exists($report_file) && !empty($report['file_path'])) {
    echo file_get_contents($report_file);
    exit;
}

// If file doesn't exist, generate report on the fly
$report_titles = [
    'bio_chemistry' => 'BIO CHEMISTRY REPORT',
    'haematology' => 'HAEMATOLOGY REPORT', 
    'urine_analysis' => 'URINE ANALYSIS',
    'serology' => 'SEROLOGY REPORT'
];

$header_class = ($report['report_type'] == 'bio_chemistry' || $report['report_type'] == 'haematology') ? 'red' : 'blue';
$title_color = ($report['report_type'] == 'bio_chemistry' || $report['report_type'] == 'haematology') ? '#dc2626' : '#2563eb';
$bg_color = ($header_class == 'red') ? '#dc2626' : '#2563eb';
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - <?php echo htmlspecialchars($report['patient_name']); ?></title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, <?php echo $bg_color; ?> 0%, <?php echo $bg_color; ?> 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: <?php echo $title_color; ?>;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, <?php echo $bg_color; ?> 0%, <?php echo $bg_color; ?> 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { 
            color: <?php echo $title_color; ?>; 
            font-size: 18px; 
            margin: 20px 0; 
            text-align: center;
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
            text-align: center;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            @page { margin: 0.5in; }
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            <strong>Name:</strong> <?php echo htmlspecialchars($report['patient_name']); ?> &nbsp;&nbsp;&nbsp; 
            <strong>Age:</strong> <?php echo $report['age']; ?> &nbsp;&nbsp;&nbsp; 
            <strong>Sex:</strong> <?php echo $report['gender']; ?> &nbsp;&nbsp;&nbsp; 
            <strong>Date:</strong> <?php echo date('d/m/Y', strtotime($report['created_at'])); ?>
        </div>
        <div style="font-size: 11px;">
            <strong>Referred By:</strong> .........................................................................................................................................
        </div>
    </div>
    
    <h2><?php echo $report_titles[$report['report_type']]; ?></h2>

    <?php if (!empty($test_results)): ?>
        <table class="report-table">
            <?php if ($report['report_type'] == 'bio_chemistry'): ?>
                <thead>
                    <tr>
                        <th style="width: 15%">TEST</th>
                        <th style="width: 10%">RESULT</th>
                        <th style="width: 8%">UNIT</th>
                        <th style="width: 17%">REF. RANGE</th>
                        <th style="width: 15%">TEST</th>
                        <th style="width: 10%">RESULT</th>
                        <th style="width: 8%">UNIT</th>
                        <th style="width: 17%">REF. RANGE</th>
                    </tr>
                </thead>
            <?php else: ?>
                <thead>
                    <tr>
                        <th style="width: 40%">TEST</th>
                        <th style="width: 20%">RESULT</th>
                        <th style="width: 15%">UNIT</th>
                        <th style="width: 25%">REFERENCE RANGE</th>
                    </tr>
                </thead>
            <?php endif; ?>
            
            <tbody>
                <?php foreach ($test_results as $category => $tests): ?>
                    <tr class="category-header">
                        <td colspan="<?php echo $report['report_type'] == 'bio_chemistry' ? '8' : '4'; ?>">
                            <strong><?php echo htmlspecialchars($category); ?></strong>
                        </td>
                    </tr>
                    <?php foreach ($tests as $test): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($test['test_name']); ?></td>
                            <td class="result-value"><?php echo htmlspecialchars($test['result_value']); ?></td>
                            <td style="text-align: center;"><?php echo htmlspecialchars($test['unit']); ?></td>
                            <td style="font-size: 8px;"><?php echo nl2br(htmlspecialchars($test['reference_range'])); ?></td>
                            <?php if ($report['report_type'] == 'bio_chemistry'): ?>
                                <td colspan="4"></td>
                            <?php endif; ?>
                        </tr>
                    <?php endforeach; ?>
                <?php endforeach; ?>
            </tbody>
        </table>
    <?php else: ?>
        <div style="text-align: center; padding: 40px;">
            <p style="font-size: 14px; color: #666;">No test results available for this report.</p>
        </div>
    <?php endif; ?>
    
    <div style="margin-top: 30px; font-size: 10px;">
        <p><strong>Technician:</strong> <?php echo htmlspecialchars($report['technician_name'] ?? 'N/A'); ?></p>
        <p><strong>Remarks:</strong> <?php echo htmlspecialchars($report['remarks'] ?? 'No remarks'); ?></p>
        <p><strong>Report Generated:</strong> <?php echo date('d/m/Y h:i A', strtotime($report['created_at'])); ?></p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0; text-align: center;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
        }
    </script>
</body>
</html>
=== END: print_report.txt ===

=== START: print_report_template.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Get report ID from URL
$report_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($report_id <= 0) {
    die('Invalid report ID');
}

// Get report details
$query = "SELECT lr.*, p.name as patient_name, p.age, p.gender 
          FROM lab_reports lr 
          JOIN patients p ON lr.patient_id = p.id 
          WHERE lr.id = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $report_id);
$stmt->execute();
$result = $stmt->get_result();
$report = $result->fetch_assoc();

if (!$report) {
    die('Report not found');
}

// Get test results for this report
$results_query = "SELECT * FROM lab_test_results WHERE lab_report_id = ?";
$results_stmt = $conn->prepare($results_query);
$results_stmt->bind_param("i", $report_id);
$results_stmt->execute();
$results_result = $results_stmt->get_result();

$test_results = [];
while ($row = $results_result->fetch_assoc()) {
    $test_results[$row['test_category']][$row['test_name']] = $row['result_value'];
}

// Check if HTML report file exists
$report_file = '../../uploads/reports/' . $report['file_path'];
if (file_exists($report_file)) {
    // Display the saved HTML report
    echo file_get_contents($report_file);
} else {
    // Generate report on the fly if file doesn't exist
    echo generatePrintableReport($report, $test_results);
}

// Function to generate printable report if file doesn't exist
function generatePrintableReport($report, $test_results) {
    $current_date = date('d/m/Y');
    $header_class = ($report['report_type'] == 'bio_chemistry' || $report['report_type'] == 'haematology') ? 'red' : 'blue';
    $title_color = ($report['report_type'] == 'bio_chemistry' || $report['report_type'] == 'haematology') ? '#dc2626' : '#2563eb';
    
    $report_titles = [
        'bio_chemistry' => 'BIO CHEMISTRY REPORT',
        'haematology' => 'HAEMATOLOGY REPORT', 
        'urine_analysis' => 'URINE ANALYSIS',
        'serology' => 'SEROLOGY REPORT'
    ];
    
    return '<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - ' . htmlspecialchars($report['patient_name']) . '</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 0%, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 6px 8px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: ' . $title_color . ';
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 0%, ' . ($header_class == 'red' ? '#dc2626' : '#2563eb') . ' 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { 
            color: ' . $title_color . '; 
            font-size: 18px; 
            margin: 20px 0; 
            text-align: center;
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
            text-align: center;
        }
        @media print {
            body { margin: 0; padding: 10px; }
            @page { margin: 0.5in; }
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            <strong>Name:</strong> ' . htmlspecialchars($report['patient_name']) . ' &nbsp;&nbsp;&nbsp; 
            <strong>Age:</strong> ' . $report['age'] . ' &nbsp;&nbsp;&nbsp; 
            <strong>Sex:</strong> ' . $report['gender'] . ' &nbsp;&nbsp;&nbsp; 
            <strong>Date:</strong> ' . date('d/m/Y', strtotime($report['created_at'])) . '
        </div>
        <div style="font-size: 11px;">
            <strong>Referred By:</strong> .........................................................................................................................................
        </div>
    </div>
    
    <h2>' . $report_titles[$report['report_type']] . '</h2>';
    
    // Generate appropriate table based on report type
    if (!empty($test_results)) {
        if ($report['report_type'] == 'bio_chemistry') {
            $html = generateBioChemTable($test_results);
        } elseif ($report['report_type'] == 'haematology') {
            $html = generateHaematologyTable($test_results);
        } elseif ($report['report_type'] == 'urine_analysis') {
            $html = generateUrineTable($test_results);
        } elseif ($report['report_type'] == 'serology') {
            $html = generateSerologyTable($test_results);
        }
    }
    
    return $html . '
    <div style="margin-top: 30px; font-size: 10px;">
        <p><strong>Technician:</strong> ' . htmlspecialchars($report['technician_name']) . '</p>
        <p><strong>Remarks:</strong> ' . htmlspecialchars($report['remarks']) . '</p>
        <p><strong>Report Generated:</strong> ' . date('d/m/Y h:i A', strtotime($report['created_at'])) . '</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0; text-align: center;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
    
    <script>
        window.onload = function() {
            window.print();
        }
    </script>
</body>
</html>';
}

function generateBioChemTable($test_results) {
    $html = '<table class="report-table">
        <thead><tr>
            <th style="width: 15%">TEST</th>
            <th style="width: 10%">RESULT</th>
            <th style="width: 8%">UNIT</th>
            <th style="width: 17%">REF. RANGE</th>
            <th style="width: 15%">TEST</th>
            <th style="width: 10%">RESULT</th>
            <th style="width: 8%">UNIT</th>
            <th style="width: 17%">REF. RANGE</th>
        </tr></thead><tbody>';
    
    foreach ($test_results as $category => $tests) {
        $html .= '<tr class="category-header"><td colspan="8"><strong>' . htmlspecialchars($category) . '</strong></td></tr>';
        foreach ($tests as $test_name => $result_value) {
            if (!empty($result_value)) {
                // Get reference data from database
                global $conn;
                $ref_stmt = $conn->prepare("SELECT unit, reference_range FROM test_templates WHERE test_name = ? AND report_type = 'bio_chemistry'");
                $ref_stmt->bind_param("s", $test_name);
                $ref_stmt->execute();
                $ref_result = $ref_stmt->get_result();
                $ref_data = $ref_result->fetch_assoc();
                
                $unit = $ref_data['unit'] ?? '';
                $reference = $ref_data['reference_range'] ?? '';
                
                $html .= '<tr>
                    <td>' . htmlspecialchars($test_name) . '</td>
                    <td class="result-value">' . htmlspecialchars($result_value) . '</td>
                    <td style="text-align: center;">' . htmlspecialchars($unit) . '</td>
                    <td style="font-size: 8px;">' . nl2br(htmlspecialchars($reference)) . '</td>
                    <td colspan="4"></td>
                </tr>';
            }
        }
    }
    
    $html .= '</tbody></table>';
    return $html;
}

function generateHaematologyTable($test_results) {
    $html = '<table class="report-table">
        <thead><tr>
            <th style="width: 30%">TEST</th>
            <th style="width: 25%">RESULT</th>
            <th style="width: 15%">UNIT</th>
            <th style="width: 30%">REFERENCE RANGE</th>
        </tr></thead><tbody>';
    
    foreach ($test_results as $category => $tests) {
        $html .= '<tr class="category-header"><td colspan="4"><strong>' . htmlspecialchars($category) . '</strong></td></tr>';
        foreach ($tests as $test_name => $result_value) {
            if (!empty($result_value)) {
                global $conn;
                $ref_stmt = $conn->prepare("SELECT unit, reference_range FROM test_templates WHERE test_name = ? AND report_type = 'haematology'");
                $ref_stmt->bind_param("s", $test_name);
                $ref_stmt->execute();
                $ref_result = $ref_stmt->get_result();
                $ref_data = $ref_result->fetch_assoc();
                
                $unit = $ref_data['unit'] ?? '';
                $reference = $ref_data['reference_range'] ?? '';
                
                $html .= '<tr>
                    <td>' . htmlspecialchars($test_name) . '</td>
                    <td class="result-value">' . htmlspecialchars($result_value) . '</td>
                    <td style="text-align: center;">' . htmlspecialchars($unit) . '</td>
                    <td style="font-size: 8px;">' . nl2br(htmlspecialchars($reference)) . '</td>
                </tr>';
            }
        }
    }
    
    $html .= '</tbody></table>';
    return $html;
}

function generateUrineTable($test_results) {
    $html = '<table class="report-table">
        <thead><tr>
            <th style="width: 40%">TEST</th>
            <th style="width: 30%">RESULT</th>
            <th style="width: 30%">REFERENCE RANGE</th>
        </tr></thead><tbody>';
    
    foreach ($test_results as $category => $tests) {
        $html .= '<tr class="category-header"><td colspan="3"><strong>' . htmlspecialchars($category) . '</strong></td></tr>';
        foreach ($tests as $test_name => $result_value) {
            if (!empty($result_value)) {
                global $conn;
                $ref_stmt = $conn->prepare("SELECT reference_range FROM test_templates WHERE test_name = ? AND report_type = 'urine_analysis'");
                $ref_stmt->bind_param("s", $test_name);
                $ref_stmt->execute();
                $ref_result = $ref_stmt->get_result();
                $ref_data = $ref_result->fetch_assoc();
                
                $reference = $ref_data['reference_range'] ?? '';
                
                $html .= '<tr>
                    <td>' . htmlspecialchars($test_name) . '</td>
                    <td class="result-value">' . htmlspecialchars($result_value) . '</td>
                    <td style="font-size: 8px;">' . nl2br(htmlspecialchars($reference)) . '</td>
                </tr>';
            }
        }
    }
    
    $html .= '</tbody></table>';
    return $html;
}

function generateSerologyTable($test_results) {
    $html = '<table class="report-table">
        <thead><tr>
            <th style="width: 50%">TEST</th>
            <th style="width: 50%">RESULT</th>
        </tr></thead><tbody>';
    
    foreach ($test_results as $category => $tests) {
        $html .= '<tr class="category-header"><td colspan="2"><strong>' . htmlspecialchars($category) . '</strong></td></tr>';
        foreach ($tests as $test_name => $result_value) {
            if (!empty($result_value)) {
                $html .= '<tr>
                    <td>' . htmlspecialchars($test_name) . '</td>
                    <td class="result-value">' . htmlspecialchars($result_value) . '</td>
                </tr>';
            }
        }
    }
    
    $html .= '</tbody></table>';
    return $html;
}
?>
=== END: print_report_template.txt ===

=== START: report_view.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Get report ID from URL
$report_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($report_id <= 0) {
    header('Location: /lch/modules/lab/view_reports.php?error=invalid_report');
    exit;
}

// Get report details
$query = "SELECT lr.*, p.name as patient_name, p.age, p.gender, p.contact 
          FROM lab_reports lr 
          JOIN patients p ON lr.patient_id = p.id 
          WHERE lr.id = ?";
$stmt = $conn->prepare($query);
$stmt->bind_param("i", $report_id);
$stmt->execute();
$result = $stmt->get_result();
$report = $result->fetch_assoc();

if (!$report) {
    header('Location: /lch/modules/lab/view_reports.php?error=report_not_found');
    exit;
}

// Get test results for this report
$results_query = "SELECT * FROM lab_test_results WHERE lab_report_id = ? ORDER BY test_category, test_name";
$results_stmt = $conn->prepare($results_query);
$results_stmt->bind_param("i", $report_id);
$results_stmt->execute();
$results_result = $results_stmt->get_result();

$test_results = [];
while ($row = $results_result->fetch_assoc()) {
    $test_results[$row['test_category']][] = $row;
}

$report_titles = [
    'bio_chemistry' => 'BIO CHEMISTRY REPORT',
    'haematology' => 'HAEMATOLOGY REPORT', 
    'urine_analysis' => 'URINE ANALYSIS',
    'serology' => 'SEROLOGY REPORT'
];

$header_colors = [
    'bio_chemistry' => 'bg-red-600',
    'haematology' => 'bg-red-600', 
    'urine_analysis' => 'bg-blue-600',
    'serology' => 'bg-blue-600'
];
?>

<?php include '../../includes/header.php'; ?>

<style>
/* Report styling matching the forms */
.shahmir-header {
    background: linear-gradient(135deg, <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?> 0%, <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?> 100%);
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
    position: relative;
    overflow: hidden;
}

.shahmir-logo {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.logo-circle {
    width: 70px;
    height: 70px;
    border: 3px solid white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.1);
}

.report-table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    font-size: 12px;
    font-family: Arial, sans-serif;
}

.report-table th,
.report-table td {
    border: 1px solid #333;
    padding: 8px 10px;
    text-align: left;
    vertical-align: top;
}

.report-table th {
    background-color: #f5f5f5;
    font-weight: bold;
    text-align: center;
    font-size: 11px;
}

.category-header {
    background-color: #e5e5e5 !important;
    font-weight: bold;
    text-align: center;
    color: <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?>;
    font-size: 12px;
}

.hospital-footer {
    background: linear-gradient(135deg, <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?> 0%, <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?> 100%);
    color: white;
    padding: 12px;
    text-align: center;
    border-radius: 0 0 8px 8px;
    font-size: 11px;
    margin-top: 20px;
}

.result-value {
    font-weight: bold;
    color: #1f2937;
    text-align: center;
}

.no-sidebar-trigger {
    pointer-events: auto !important;
    z-index: 1000;
}

@media print {
    .no-print { display: none !important; }
    body { font-size: 11px; }
    .shahmir-header { break-inside: avoid; }
    .report-table { break-inside: avoid; }
}
</style>

<div class="mb-6 no-print">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Lab Report Details</h1>
            <p class="text-gray-600">Report ID: #<?php echo $report['id']; ?></p>
        </div>
        <div class="space-x-3">
            <button onclick="printReport(<?php echo $report['id']; ?>); return false;" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 no-sidebar-trigger">
                <i class="fas fa-print mr-2"></i> Print Report
            </button>
            <a href="/lch/modules/lab/view_reports.php" class="bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 no-sidebar-trigger">
                <i class="fas fa-arrow-left mr-2"></i> Back to Reports
            </a>
        </div>
    </div>
</div>

<!-- Report Display -->
<div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <!-- Shahmir Laboratory Header -->
    <div class="shahmir-header">
        <div class="relative z-10">
            <div class="flex justify-between items-start">
                <div class="shahmir-logo">
                    <div class="logo-circle">
                        <i class="fas fa-microscope text-white text-3xl"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold">Shahmir Laboratory</h1>
                        <p class="text-lg opacity-90">Facility Available for Multi Lab Collection</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg"><strong>Timings</strong></p>
                    <p>Monday-Sunday: Open Round The Clock</p>
                </div>
            </div>
            <div class="mt-4 text-lg">
                <strong>Name:</strong> <?php echo htmlspecialchars($report['patient_name']); ?> &nbsp;&nbsp;&nbsp; 
                <strong>Age:</strong> <?php echo $report['age']; ?> &nbsp;&nbsp;&nbsp; 
                <strong>Sex:</strong> <?php echo $report['gender']; ?> &nbsp;&nbsp;&nbsp; 
                <strong>Date:</strong> <?php echo date('d/m/Y', strtotime($report['created_at'])); ?>
            </div>
            <div class="text-base mt-2">
                <strong>Referred By:</strong> .........................................................................................................................................
            </div>
        </div>
    </div>

    <!-- Report Content -->
    <div class="p-6">
        <h2 class="text-2xl font-bold text-center mb-6" style="color: <?php echo $header_colors[$report['report_type']] == 'bg-red-600' ? '#dc2626' : '#2563eb'; ?>">
            <?php echo $report_titles[$report['report_type']]; ?>
        </h2>

        <?php if (!empty($test_results)): ?>
            <table class="report-table">
                <?php if ($report['report_type'] == 'bio_chemistry'): ?>
                    <thead>
                        <tr>
                            <th style="width: 15%">TEST</th>
                            <th style="width: 10%">RESULT</th>
                            <th style="width: 8%">UNIT</th>
                            <th style="width: 17%">REF. RANGE</th>
                            <th style="width: 15%">TEST</th>
                            <th style="width: 10%">RESULT</th>
                            <th style="width: 8%">UNIT</th>
                            <th style="width: 17%">REF. RANGE</th>
                        </tr>
                    </thead>
                <?php else: ?>
                    <thead>
                        <tr>
                            <th style="width: 40%">TEST</th>
                            <th style="width: 20%">RESULT</th>
                            <th style="width: 15%">UNIT</th>
                            <th style="width: 25%">REFERENCE RANGE</th>
                        </tr>
                    </thead>
                <?php endif; ?>
                
                <tbody>
                    <?php foreach ($test_results as $category => $tests): ?>
                        <tr class="category-header">
                            <td colspan="<?php echo $report['report_type'] == 'bio_chemistry' ? '8' : '4'; ?>">
                                <strong><?php echo htmlspecialchars($category); ?></strong>
                            </td>
                        </tr>
                        <?php foreach ($tests as $test): ?>
                            <tr>
                                <td><?php echo htmlspecialchars($test['test_name']); ?></td>
                                <td class="result-value"><?php echo htmlspecialchars($test['result_value']); ?></td>
                                <td style="text-align: center;"><?php echo htmlspecialchars($test['unit']); ?></td>
                                <td style="font-size: 10px;"><?php echo nl2br(htmlspecialchars($test['reference_range'])); ?></td>
                                <?php if ($report['report_type'] == 'bio_chemistry'): ?>
                                    <td colspan="4"></td>
                                <?php endif; ?>
                            </tr>
                        <?php endforeach; ?>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else: ?>
            <div class="text-center py-8">
                <i class="fas fa-flask text-gray-400 text-4xl mb-4"></i>
                <p class="text-gray-600">No test results found for this report.</p>
            </div>
        <?php endif; ?>

        <!-- Additional Information -->
        <div class="mt-8 grid grid-cols-2 gap-6">
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">Report Information</h3>
                <div class="text-sm space-y-1">
                    <p><strong>Technician:</strong> <?php echo htmlspecialchars($report['technician_name'] ?? 'N/A'); ?></p>
                    <p><strong>Generated:</strong> <?php echo date('d/m/Y h:i A', strtotime($report['created_at'])); ?></p>
                    <p><strong>Status:</strong> 
                        <span class="px-2 py-1 text-xs rounded-full <?php echo $report['status'] === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'; ?>">
                            <?php echo ucfirst($report['status']); ?>
                        </span>
                    </p>
                </div>
            </div>
            <div>
                <h3 class="font-semibold text-gray-800 mb-2">Remarks</h3>
                <div class="text-sm bg-gray-50 p-3 rounded">
                    <?php echo !empty($report['remarks']) ? nl2br(htmlspecialchars($report['remarks'])) : 'No remarks provided.'; ?>
                </div>
            </div>
        </div>
    </div>

    <!-- Hospital Footer -->
    <div class="hospital-footer">
        <p class="font-bold text-base">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p class="text-sm mt-1">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
        <div class="mt-3 text-xs">
            <p><strong>Not for Medico legal / Court use</strong></p>
            <p><strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong></p>
        </div>
    </div>
</div>

<script>
// Print report function - same as other pages
function printReport(reportId) {
    // Prevent event bubbling that might affect sidebar
    if (event) {
        event.stopPropagation();
    }
    
    // Open the print page in a new window/tab
    window.open('/lch/modules/lab/print_report.php?id=' + reportId, '_blank', 'width=800,height=600');
    
    // Return false to prevent any default behavior
    return false;
}
</script>

<?php include '../../includes/footer.php'; ?>
=== END: report_view.txt ===

=== START: view_reports.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('lab');

// Get patient ID from URL if available
$patient_id = isset($_GET['patient_id']) ? intval($_GET['patient_id']) : 0;
$patient = null;

// Check if viewing a specific report
$view_report_id = isset($_GET['view_report']) ? intval($_GET['view_report']) : 0;

// If viewing a specific report, redirect to the report view page
if ($view_report_id > 0) {
    header("Location: /lch/modules/lab/report_view.php?id=" . $view_report_id);
    exit;
}

// Get lab reports with proper patient name joining
if ($patient_id > 0) {
    $patient = getPatient($patient_id);
    $query = "SELECT lr.*, p.name as patient_name 
              FROM lab_reports lr 
              JOIN patients p ON lr.patient_id = p.id 
              WHERE lr.patient_id = ? 
              ORDER BY lr.created_at DESC";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("i", $patient_id);
    $stmt->execute();
    $lab_reports = $stmt->get_result();
} else {
    $query = "SELECT lr.*, p.name as patient_name 
              FROM lab_reports lr 
              JOIN patients p ON lr.patient_id = p.id 
              ORDER BY lr.created_at DESC";
    $lab_reports = $conn->query($query);
}
?>

<?php include '../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Lab Reports</h1>
    <p class="text-gray-600">View and manage lab test reports</p>
</div>

<?php if ($patient_id > 0 && $patient): ?>
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <h2 class="text-lg font-semibold text-gray-800">Patient: <?php echo htmlspecialchars($patient['name']); ?> (ID: <?php echo $patient['id']; ?>)</h2>
</div>
<?php endif; ?>

<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">Lab Reports</h2>
        <div class="relative">
            <input type="text" id="search" placeholder="Search reports..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
        </div>
    </div>
    
    <?php if ($lab_reports->num_rows > 0): ?>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="report-table-body">
                    <?php while ($report = $lab_reports->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $report['id']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo htmlspecialchars($report['patient_name']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo htmlspecialchars($report['test_name']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo date('d M Y', strtotime($report['created_at'])); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php echo $report['status'] === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'; ?>">
                                    <?php echo ucfirst($report['status']); ?>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <a href="/lch/modules/lab/report_view.php?id=<?php echo $report['id']; ?>" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 mr-2 no-sidebar-trigger">
                                    <i class="fas fa-eye mr-1"></i> View
                                </a>
                                <button onclick="printReport(<?php echo $report['id']; ?>); return false;" class="bg-green-600 text-white py-1 px-3 rounded hover:bg-green-700 no-sidebar-trigger">
                                    <i class="fas fa-print mr-1"></i> Print
                                </button>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        </div>
    <?php else: ?>
        <div class="p-8 text-center">
            <i class="fas fa-file-medical text-gray-400 text-5xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-1">No lab reports found</h3>
            <p class="text-gray-500">There are no lab reports available.</p>
        </div>
    <?php endif; ?>
</div>

<style>
/* Prevent sidebar from collapsing when buttons are clicked */
.sidebar {
    transition: none !important;
}

/* Ensure buttons don't trigger sidebar events */
.no-sidebar-trigger {
    pointer-events: auto !important;
    z-index: 1000;
}
</style>

<script>
// Search functionality
document.getElementById('search').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#report-table-body tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Print report function - same as add_report.php
function printReport(reportId) {
    // Prevent event bubbling that might affect sidebar
    if (event) {
        event.stopPropagation();
    }
    
    // Open the print page in a new window/tab
    window.open('/lch/modules/lab/print_report.php?id=' + reportId, '_blank', 'width=800,height=600');
    
    // Return false to prevent any default behavior
    return false;
}
</script>

<?php include '../../includes/footer.php'; ?>
=== END: view_reports.txt ===

=== START: add_birth_record.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $patient_id = $_POST['patient_id'];
    $newborn_name = $_POST['newborn_name'];
    $father_name = $_POST['father_name'];
    $mother_name = $_POST['mother_name'];
    $father_nic = $_POST['father_nic'];
    $mother_nic = $_POST['mother_nic'];
    $date_of_birth = $_POST['date_of_birth'];
    $time_of_birth = $_POST['time_of_birth'];
    $weight = $_POST['weight'];
    $length = $_POST['length'];
    $gender = $_POST['gender'];
    $delivery_type = $_POST['delivery_type'];
    $birth_complications = $_POST['birth_complications'];
    $doctor_id = $_POST['doctor_id'];
    $address = $_POST['address'];
    $created_by = $_SESSION['user_id'];
    
    // Generate certificate number
    $certificate_number = generateBirthCertificateNumber();
    $issued_by = $_SESSION['username'];
    
    $query = "INSERT INTO birth_records (patient_id, newborn_name, father_name, mother_name, father_nic, mother_nic, 
              date_of_birth, time_of_birth, weight, length, gender, delivery_type, birth_complications, 
              doctor_id, address, certificate_number, issued_by, created_by) 
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
    
    $stmt = $conn->prepare($query);
    $stmt->bind_param("isssssssddsssisssi", $patient_id, $newborn_name, $father_name, $mother_name, 
                      $father_nic, $mother_nic, $date_of_birth, $time_of_birth, $weight, $length, 
                      $gender, $delivery_type, $birth_complications, $doctor_id, $address, 
                      $certificate_number, $issued_by, $created_by);
    
    if ($stmt->execute()) {
        $birth_record_id = $conn->insert_id;
        $success = "Birth record added successfully. Certificate Number: $certificate_number";
    } else {
        $error = "Error: " . $stmt->error;
    }
}

// Get all patients for dropdown
$patients = getAllPatients();

// Get all doctors for dropdown
$doctors = getAllStaff();
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Add Birth Record</h1>
    <p class="text-gray-600">Register a new birth and generate birth certificate</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
    <div class="mt-2">
        <a href="birth_certificates.php?id=<?php echo $birth_record_id; ?>" class="bg-green-600 text-white py-1 px-3 rounded text-sm hover:bg-green-700">
            <i class="fas fa-certificate mr-1"></i> Print Birth Certificate
        </a>
        <a href="birth_death_records.php" class="bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700 ml-2">
            <i class="fas fa-arrow-left mr-1"></i> Back to Records
        </a>
    </div>
</div>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<div class="bg-white rounded-lg shadow p-6">
    <form method="post" action="add_birth_record.php">
        <!-- Mother/Patient Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Mother Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="patient_id" class="block text-gray-700 font-medium mb-2">Select Mother (Patient) <span class="text-red-500">*</span></label>
                    <select id="patient_id" name="patient_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="fillMotherInfo()">
                        <option value="">Select a patient</option>
                        <?php while ($patient = $patients->fetch_assoc()): ?>
                            <option value="<?php echo $patient['id']; ?>" 
                                    data-name="<?php echo htmlspecialchars($patient['name']); ?>"
                                    data-contact="<?php echo htmlspecialchars($patient['contact']); ?>"
                                    data-address="<?php echo htmlspecialchars($patient['address']); ?>">
                                <?php echo $patient['name'] . ' (ID: ' . $patient['id'] . ')'; ?>
                            </option>
                        <?php endwhile; ?>
                    </select>
                </div>
                
                <div>
                    <label for="mother_name" class="block text-gray-700 font-medium mb-2">Mother's Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="mother_name" name="mother_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="mother_nic" class="block text-gray-700 font-medium mb-2">Mother's NIC Number</label>
                    <input type="text" id="mother_nic" name="mother_nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Father Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Father Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="father_name" class="block text-gray-700 font-medium mb-2">Father's Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="father_name" name="father_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="father_nic" class="block text-gray-700 font-medium mb-2">Father's NIC Number <span class="text-red-500">*</span></label>
                    <input type="text" id="father_nic" name="father_nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
        </div>

        <!-- Newborn Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Newborn Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="newborn_name" class="block text-gray-700 font-medium mb-2">Newborn's Name <span class="text-red-500">*</span></label>
                    <input type="text" id="newborn_name" name="newborn_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="gender" class="block text-gray-700 font-medium mb-2">Gender <span class="text-red-500">*</span></label>
                    <select id="gender" name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                
                <div>
                    <label for="delivery_type" class="block text-gray-700 font-medium mb-2">Delivery Type <span class="text-red-500">*</span></label>
                    <select id="delivery_type" name="delivery_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Type</option>
                        <option value="Normal">Normal Delivery</option>
                        <option value="C-Section">C-Section</option>
                        <option value="Assisted">Assisted Delivery</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Birth Details -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Birth Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div>
                    <label for="date_of_birth" class="block text-gray-700 font-medium mb-2">Date of Birth <span class="text-red-500">*</span></label>
                    <input type="datetime-local" id="date_of_birth" name="date_of_birth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="time_of_birth" class="block text-gray-700 font-medium mb-2">Time of Birth <span class="text-red-500">*</span></label>
                    <input type="time" id="time_of_birth" name="time_of_birth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="weight" class="block text-gray-700 font-medium mb-2">Weight (kg)</label>
                    <input type="number" id="weight" name="weight" step="0.01" placeholder="3.50" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="length" class="block text-gray-700 font-medium mb-2">Length (cm)</label>
                    <input type="number" id="length" name="length" step="0.1" placeholder="50.0" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Medical Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Medical Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="doctor_id" class="block text-gray-700 font-medium mb-2">Attending Doctor</label>
                    <select id="doctor_id" name="doctor_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Doctor</option>
                        <?php 
                        $doctors->data_seek(0);
                        while ($doctor = $doctors->fetch_assoc()): ?>
                            <option value="<?php echo $doctor['id']; ?>">Dr. <?php echo $doctor['name']; ?></option>
                        <?php endwhile; ?>
                    </select>
                </div>
                
                <div>
                    <label for="birth_complications" class="block text-gray-700 font-medium mb-2">Birth Complications (if any)</label>
                    <textarea id="birth_complications" name="birth_complications" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter any complications during birth..."></textarea>
                </div>
            </div>
        </div>

        <!-- Address -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Address Information</h3>
            <div>
                <label for="address" class="block text-gray-700 font-medium mb-2">Full Address <span class="text-red-500">*</span></label>
                <textarea id="address" name="address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Enter complete address..."></textarea>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <a href="birth_death_records.php" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                Cancel
            </a>
            <button type="submit" class="bg-green-600 text-white py-2 px-6 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition">
                Add Birth Record
            </button>
        </div>
    </form>
</div>

<script>
    // Auto-fill mother information when patient is selected
    function fillMotherInfo() {
        const select = document.getElementById('patient_id');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            document.getElementById('mother_name').value = selectedOption.dataset.name || '';
            document.getElementById('address').value = selectedOption.dataset.address || '';
        } else {
            document.getElementById('mother_name').value = '';
            document.getElementById('address').value = '';
        }
    }
    
    // Set current date and time as default
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const currentDateTime = now.toISOString().slice(0, 16);
        const currentTime = now.toTimeString().slice(0, 5);
        
        document.getElementById('date_of_birth').value = currentDateTime;
        document.getElementById('time_of_birth').value = currentTime;
    });
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: add_birth_record.txt ===

=== START: add_death_record.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $patient_id = $_POST['patient_id'];
    $deceased_name = $_POST['deceased_name'];
    $father_name = $_POST['father_name'];
    $mother_name = $_POST['mother_name'];
    $spouse_name = $_POST['spouse_name'];
    $deceased_nic = $_POST['deceased_nic'];
    $date_of_death = $_POST['date_of_death'];
    $time_of_death = $_POST['time_of_death'];
    $age_at_death = $_POST['age_at_death'];
    $cause_of_death = $_POST['cause_of_death'];
    $place_of_death = $_POST['place_of_death'];
    $doctor_id = $_POST['doctor_id'];
    $address = $_POST['address'];
    $next_of_kin = $_POST['next_of_kin'];
    $next_of_kin_relation = $_POST['next_of_kin_relation'];
    $next_of_kin_contact = $_POST['next_of_kin_contact'];
    $autopsy_required = isset($_POST['autopsy_required']) ? 1 : 0;
    $autopsy_notes = $_POST['autopsy_notes'];
    $created_by = $_SESSION['user_id'];
    
    // Generate certificate number
    $certificate_number = generateDeathCertificateNumber();
    $issued_by = $_SESSION['username'];
    
    $query = "INSERT INTO death_records (patient_id, deceased_name, father_name, mother_name, spouse_name, 
              deceased_nic, date_of_death, time_of_death, age_at_death, cause_of_death, place_of_death, 
              doctor_id, address, next_of_kin, next_of_kin_relation, next_of_kin_contact, 
              autopsy_required, autopsy_notes, certificate_number, issued_by, created_by) 
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
    
    $stmt = $conn->prepare($query);
    $stmt->bind_param("isssssssisissssssissi", $patient_id, $deceased_name, $father_name, $mother_name, 
                      $spouse_name, $deceased_nic, $date_of_death, $time_of_death, $age_at_death, 
                      $cause_of_death, $place_of_death, $doctor_id, $address, $next_of_kin, 
                      $next_of_kin_relation, $next_of_kin_contact, $autopsy_required, $autopsy_notes, 
                      $certificate_number, $issued_by, $created_by);
    
    if ($stmt->execute()) {
        $death_record_id = $conn->insert_id;
        $success = "Death record added successfully. Certificate Number: $certificate_number";
    } else {
        $error = "Error: " . $stmt->error;
    }
}

// Get all patients for dropdown
$patients = getAllPatients();

// Get all doctors for dropdown
$doctors = getAllStaff();
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Add Death Record</h1>
    <p class="text-gray-600">Register a death and generate death certificate</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
    <div class="mt-2">
        <a href="death_certificates.php?id=<?php echo $death_record_id; ?>" class="bg-green-600 text-white py-1 px-3 rounded text-sm hover:bg-green-700">
            <i class="fas fa-certificate mr-1"></i> Print Death Certificate
        </a>
        <a href="birth_death_records.php" class="bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700 ml-2">
            <i class="fas fa-arrow-left mr-1"></i> Back to Records
        </a>
    </div>
</div>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<div class="bg-white rounded-lg shadow p-6">
    <form method="post" action="add_death_record.php">
        <!-- Deceased Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Deceased Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="patient_id" class="block text-gray-700 font-medium mb-2">Select Patient <span class="text-red-500">*</span></label>
                    <select id="patient_id" name="patient_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required onchange="fillPatientInfo()">
                        <option value="">Select a patient</option>
                        <?php while ($patient = $patients->fetch_assoc()): ?>
                            <option value="<?php echo $patient['id']; ?>" 
                                    data-name="<?php echo htmlspecialchars($patient['name']); ?>"
                                    data-age="<?php echo $patient['age']; ?>"
                                    data-contact="<?php echo htmlspecialchars($patient['contact']); ?>"
                                    data-address="<?php echo htmlspecialchars($patient['address']); ?>">
                                <?php echo $patient['name'] . ' (ID: ' . $patient['id'] . ')'; ?>
                            </option>
                        <?php endwhile; ?>
                    </select>
                </div>
                
                <div>
                    <label for="deceased_name" class="block text-gray-700 font-medium mb-2">Deceased Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="deceased_name" name="deceased_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="deceased_nic" class="block text-gray-700 font-medium mb-2">Deceased NIC Number</label>
                    <input type="text" id="deceased_nic" name="deceased_nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="age_at_death" class="block text-gray-700 font-medium mb-2">Age at Death <span class="text-red-500">*</span></label>
                    <input type="number" id="age_at_death" name="age_at_death" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
        </div>

        <!-- Family Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Family Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="father_name" class="block text-gray-700 font-medium mb-2">Father's Name <span class="text-red-500">*</span></label>
                    <input type="text" id="father_name" name="father_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="mother_name" class="block text-gray-700 font-medium mb-2">Mother's Name</label>
                    <input type="text" id="mother_name" name="mother_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="spouse_name" class="block text-gray-700 font-medium mb-2">Spouse Name (if applicable)</label>
                    <input type="text" id="spouse_name" name="spouse_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Death Details -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Death Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="date_of_death" class="block text-gray-700 font-medium mb-2">Date of Death <span class="text-red-500">*</span></label>
                    <input type="datetime-local" id="date_of_death" name="date_of_death" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="time_of_death" class="block text-gray-700 font-medium mb-2">Time of Death <span class="text-red-500">*</span></label>
                    <input type="time" id="time_of_death" name="time_of_death" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="place_of_death" class="block text-gray-700 font-medium mb-2">Place of Death <span class="text-red-500">*</span></label>
                    <input type="text" id="place_of_death" name="place_of_death" value="Life Care Hospital" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
        </div>

        <!-- Medical Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Medical Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="cause_of_death" class="block text-gray-700 font-medium mb-2">Cause of Death <span class="text-red-500">*</span></label>
                    <textarea id="cause_of_death" name="cause_of_death" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Enter detailed cause of death..."></textarea>
                </div>
                
                <div>
                    <label for="doctor_id" class="block text-gray-700 font-medium mb-2">Attending Doctor</label>
                    <select id="doctor_id" name="doctor_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Doctor</option>
                        <?php 
                        $doctors->data_seek(0);
                        while ($doctor = $doctors->fetch_assoc()): ?>
                            <option value="<?php echo $doctor['id']; ?>">Dr. <?php echo $doctor['name']; ?></option>
                        <?php endwhile; ?>
                    </select>
                </div>
            </div>
        </div>

        <!-- Next of Kin Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Next of Kin Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="next_of_kin" class="block text-gray-700 font-medium mb-2">Next of Kin Name <span class="text-red-500">*</span></label>
                    <input type="text" id="next_of_kin" name="next_of_kin" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div>
                    <label for="next_of_kin_relation" class="block text-gray-700 font-medium mb-2">Relation <span class="text-red-500">*</span></label>
                    <select id="next_of_kin_relation" name="next_of_kin_relation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select Relation</option>
                        <option value="Spouse">Spouse</option>
                        <option value="Son">Son</option>
                        <option value="Daughter">Daughter</option>
                        <option value="Father">Father</option>
                        <option value="Mother">Mother</option>
                        <option value="Brother">Brother</option>
                        <option value="Sister">Sister</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div>
                    <label for="next_of_kin_contact" class="block text-gray-700 font-medium mb-2">Contact Number <span class="text-red-500">*</span></label>
                    <input type="text" id="next_of_kin_contact" name="next_of_kin_contact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
            </div>
        </div>

        <!-- Autopsy Information -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Autopsy Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="autopsy_required" name="autopsy_required" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" onchange="toggleAutopsyNotes()">
                        <span class="ml-2 text-gray-700 font-medium">Autopsy Required</span>
                    </label>
                </div>
                
                <div id="autopsy_notes_section" class="hidden">
                    <label for="autopsy_notes" class="block text-gray-700 font-medium mb-2">Autopsy Notes</label>
                    <textarea id="autopsy_notes" name="autopsy_notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter autopsy related notes..."></textarea>
                </div>
            </div>
        </div>

        <!-- Address -->
        <div class="mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Address Information</h3>
            <div>
                <label for="address" class="block text-gray-700 font-medium mb-2">Full Address <span class="text-red-500">*</span></label>
                <textarea id="address" name="address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="Enter complete address..."></textarea>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <a href="birth_death_records.php" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
                Cancel
            </a>
            <button type="submit" class="bg-red-600 text-white py-2 px-6 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition">
                Add Death Record
            </button>
        </div>
    </form>
</div>

<script>
    // Auto-fill patient information when patient is selected
    function fillPatientInfo() {
        const select = document.getElementById('patient_id');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            document.getElementById('deceased_name').value = selectedOption.dataset.name || '';
            document.getElementById('age_at_death').value = selectedOption.dataset.age || '';
            document.getElementById('address').value = selectedOption.dataset.address || '';
            document.getElementById('next_of_kin_contact').value = selectedOption.dataset.contact || '';
        } else {
            document.getElementById('deceased_name').value = '';
            document.getElementById('age_at_death').value = '';
            document.getElementById('address').value = '';
            document.getElementById('next_of_kin_contact').value = '';
        }
    }
    
    // Toggle autopsy notes section
    function toggleAutopsyNotes() {
        const checkbox = document.getElementById('autopsy_required');
        const notesSection = document.getElementById('autopsy_notes_section');
        
        if (checkbox.checked) {
            notesSection.classList.remove('hidden');
        } else {
            notesSection.classList.add('hidden');
        }
    }
    
    // Set current date and time as default
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const currentDateTime = now.toISOString().slice(0, 16);
        const currentTime = now.toTimeString().slice(0, 5);
        
        document.getElementById('date_of_death').value = currentDateTime;
        document.getElementById('time_of_death').value = currentTime;
    });
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: add_death_record.txt ===

=== START: add_patient.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $name = $_POST['name'];
    $age = $_POST['age'];
    $gender = $_POST['gender'];
    $contact = $_POST['contact'];
    $emergency_contact = $_POST['emergency_contact'];
    $relative_name = $_POST['relative_name'];
    $nic = $_POST['nic'];
    $address = $_POST['address'];
    
    $query = "INSERT INTO patients (name, age, gender, contact, emergency_contact, relative_name, nic, address) 
              VALUES ('$name', $age, '$gender', '$contact', '$emergency_contact', '$relative_name', '$nic', '$address')";
    
    if ($conn->query($query) === TRUE) {
        $success = "Patient added successfully";
    } else {
        $error = "Error: " . $conn->error;
    }
}
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Add New Patient</h1>
    <p class="text-gray-600">Register a new patient in the system</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
</div>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <?php echo $error; ?>
</div>
<?php endif; ?>

<div class="bg-white rounded-lg shadow p-6">
    <form method="post" action="add_patient.php">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="name" class="block text-gray-700 font-medium mb-2">Full Name</label>
                <input type="text" id="name" name="name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div>
                <label for="age" class="block text-gray-700 font-medium mb-2">Age</label>
                <input type="number" id="age" name="age" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div>
                <label for="gender" class="block text-gray-700 font-medium mb-2">Gender</label>
                <select id="gender" name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div>
                <label for="contact" class="block text-gray-700 font-medium mb-2">Contact Number</label>
                <input type="text" id="contact" name="contact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div>
                <label for="emergency_contact" class="block text-gray-700 font-medium mb-2">Emergency Contact</label>
                <input type="text" id="emergency_contact" name="emergency_contact" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="relative_name" class="block text-gray-700 font-medium mb-2">Husband/Father/Guardian Name</label>
                <input type="text" id="relative_name" name="relative_name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div>
                <label for="nic" class="block text-gray-700 font-medium mb-2">NIC Number</label>
                <input type="text" id="nic" name="nic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="md:col-span-2">
                <label for="address" class="block text-gray-700 font-medium mb-2">Address</label>
                <textarea id="address" name="address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end">
            <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                Add Patient
            </button>
        </div>
    </form>
</div>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: add_patient.txt ===

=== START: billing.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get patient ID from URL if available
$patient_id = isset($_GET['patient_id']) ? $_GET['patient_id'] : '';

// Process form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $patient_id = $_POST['patient_id'];
    $bill_group_id = 'BILL_' . time(); // Generate unique bill group ID
    
    // Process each service
    $service_names = $_POST['service_name'];
    $amounts = $_POST['amount'];
    $discounts = $_POST['discount'];
    $paid_amounts = $_POST['paid_amount'];
    
    $total_amount = 0;
    $total_discount = 0;
    $total_paid = 0;
    
    for ($i = 0; $i < count($service_names); $i++) {
        if (!empty($service_names[$i])) {
            $service_name = $service_names[$i];
            $amount = $amounts[$i];
            $discount = $discounts[$i];
            $paid_amount = $paid_amounts[$i];
            
            $total_amount += $amount;
            $total_discount += $discount;
            $total_paid += $paid_amount;
            
            $query = "INSERT INTO billing (patient_id, service_name, amount, discount, paid_amount, status, bill_group_id) 
                      VALUES ($patient_id, '$service_name', $amount, $discount, $paid_amount, 'paid', '$bill_group_id')";
            $conn->query($query);
        }
    }
    
    $success = "Bill created successfully with ID: $bill_group_id";
    
    // Get patient details
    $patient = getPatient($patient_id);
}

// Get all patients for dropdown
$patients = getAllPatients();

// Get all tests for dropdown
$tests = getAllTests();

// Get all rooms for dropdown
$rooms = getAllRooms();

// Get all custom services for dropdown
$custom_services = getActiveCustomServices();
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Billing</h1>
    <p class="text-gray-600">Create and manage patient bills</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <?php echo $success; ?>
    <div class="mt-2">
        <button onclick="printBill()" class="bg-green-600 text-white py-1 px-3 rounded text-sm hover:bg-green-700">
            <i class="fas fa-print mr-1"></i> Print Bill
        </button>
        <a href="generate_bill.php?patient_id=<?php echo $patient_id; ?>" class="bg-blue-600 text-white py-1 px-3 rounded text-sm hover:bg-blue-700 ml-2">
            <i class="fas fa-file-pdf mr-1"></i> Generate PDF Bill
        </a>
    </div>
</div>
<?php endif; ?>

<div class="bg-white rounded-lg shadow p-6">
    <form method="post" action="billing.php" id="billing-form">
        <div class="mb-4">
            <label for="patient_id" class="block text-gray-700 font-medium mb-2">Select Patient</label>
            <select id="patient_id" name="patient_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="">Select a patient</option>
                <?php while ($patient = $patients->fetch_assoc()): ?>
                    <option value="<?php echo $patient['id']; ?>" <?php echo ($patient['id'] == $patient_id) ? 'selected' : ''; ?>>
                        <?php echo $patient['name'] . ' (ID: ' . $patient['id'] . ')'; ?>
                    </option>
                <?php endwhile; ?>
            </select>
        </div>
        
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-800">Services</h3>
                <button type="button" id="add-service-btn" class="bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 text-sm">
                    <i class="fas fa-plus mr-1"></i> Add Service
                </button>
            </div>
            
            <div id="services-container">
                <!-- Initial service row -->
                <div class="service-row grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-gray-200 rounded-lg">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Service Name</label>
                        <select name="service_name[]" class="service-name w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="">Select a service</option>
                            
                            <!-- Custom Services from Pricing Module -->
                            <optgroup label="Custom Services">
                                <?php while ($service = $custom_services->fetch_assoc()): ?>
                                    <option value="<?php echo htmlspecialchars($service['service_name']); ?>" 
                                            data-price="<?php echo $service['price']; ?>"
                                            data-type="custom">
                                        <?php echo $service['service_name'] . ' (' . ucfirst($service['service_type']) . ') - ' . formatCurrency($service['price']); ?>
                                    </option>
                                <?php endwhile; ?>
                            </optgroup>
                            
                            <!-- Lab Tests -->
                            <optgroup label="Lab Tests">
                                <?php 
                                $tests->data_seek(0);
                                while ($test = $tests->fetch_assoc()): ?>
                                    <option value="<?php echo htmlspecialchars($test['test_name']); ?>" 
                                            data-price="<?php echo $test['price']; ?>"
                                            data-type="lab">
                                        <?php echo $test['test_name'] . ' - ' . formatCurrency($test['price']); ?>
                                    </option>
                                <?php endwhile; ?>
                            </optgroup>
                            
                            <!-- Room Charges -->
                            <optgroup label="Room Charges">
                                <?php 
                                $rooms->data_seek(0);
                                while ($room = $rooms->fetch_assoc()): ?>
                                    <option value="<?php echo htmlspecialchars($room['room_name']); ?>" 
                                            data-price="<?php echo $room['price']; ?>"
                                            data-type="room">
                                        <?php echo $room['room_name'] . ' - ' . formatCurrency($room['price']) . '/day'; ?>
                                    </option>
                                <?php endwhile; ?>
                            </optgroup>
                            
                            <!-- Standard Services -->
                            <optgroup label="Standard Services">
                                <option value="Doctor Consultation" data-price="1000" data-type="standard">Doctor Consultation - PKR 1,000</option>
                                <option value="Emergency Fee" data-price="2000" data-type="standard">Emergency Fee - PKR 2,000</option>
                                <option value="Medicines" data-price="500" data-type="standard">Medicines - PKR 500</option>
                                <option value="Other Services" data-price="0" data-type="standard">Other Services</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Amount (PKR)</label>
                        <input type="number" name="amount[]" class="service-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Discount (PKR)</label>
                        <input type="number" name="discount[]" class="service-discount w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Paid Amount (PKR)</label>
                        <input type="number" name="paid_amount[]" class="service-paid w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div class="flex items-end">
                        <button type="button" class="remove-service-btn bg-red-600 text-white py-2 px-3 rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-gray-200 pt-4">
                <div class="flex justify-between">
                    <div>
                        <div class="text-lg font-medium">Total Amount: <span id="total-amount">0</span> PKR</div>
                        <div class="text-lg font-medium">Total Discount: <span id="total-discount">0</span> PKR</div>
                        <div class="text-lg font-medium">Total Paid: <span id="total-paid">0</span> PKR</div>
                    </div>
                    <div>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                            Create Bill
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="bg-white rounded-lg shadow p-6 mt-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Recent Bills</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Services</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php
                $query = "SELECT bill_group_id, patient_id, SUM(amount) as total_amount, status, MAX(created_at) as created_at 
                          FROM billing 
                          GROUP BY bill_group_id 
                          ORDER BY created_at DESC 
                          LIMIT 10";
                $result = $conn->query($query);
                
                if ($result->num_rows > 0) {
                    while ($row = $result->fetch_assoc()) {
                        $patient = getPatient($row['patient_id']);
                        $service_count_query = "SELECT COUNT(*) as count FROM billing WHERE bill_group_id = '" . $row['bill_group_id'] . "'";
                        $service_count_result = $conn->query($service_count_query);
                        $service_count = $service_count_result->fetch_assoc()['count'];
                        
                        echo "<tr>";
                        echo "<td class='px-6 py-4 whitespace-nowrap'>" . $row['bill_group_id'] . "</td>";
                        echo "<td class='px-6 py-4 whitespace-nowrap'>" . $patient['name'] . "</td>";
                        echo "<td class='px-6 py-4 whitespace-nowrap'>" . $service_count . " services</td>";
                        echo "<td class='px-6 py-4 whitespace-nowrap'>" . formatCurrency($row['total_amount']) . "</td>";
                        echo "<td class='px-6 py-4 whitespace-nowrap'>";
                        if ($row['status'] === 'paid') {
                            echo "<span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800'>Paid</span>";
                        } elseif ($row['status'] === 'unpaid') {
                            echo "<span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800'>Unpaid</span>";
                        } elseif ($row['status'] === 'refund') {
                            echo "<span class='px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800'>Refund</span>";
                        }
                        echo "</td>";
                        echo "<td class='px-6 py-4 whitespace-nowrap text-sm'>";
                        echo "<a href='bill_details.php?bill_group_id=" . $row['bill_group_id'] . "' class='bg-blue-600 text-white py-1 px-3 rounded hover:bg-blue-700 mr-2'>";
                        echo "<i class='fas fa-eye mr-1'></i> View";
                        echo "</a>";
                        echo "</td>";
                        echo "</tr>";
                    }
                } else {
                    echo "<tr><td colspan='6' class='px-6 py-4 text-center text-gray-500'>No bills found</td></tr>";
                }
                ?>
            </tbody>
        </table>
    </div>
    <div class="mt-4 text-center">
        <a href="bill_records.php" class="text-blue-600 hover:text-blue-800 text-sm">View All Bills</a>
    </div>
</div>

<!-- Bill Print Template -->
<div id="bill-print" class="hidden">
    <div class="p-6" style="width: 300px; font-family: monospace;">
        <div class="text-center mb-4">
            <h3 class="font-bold text-lg">HOSPITAL MANAGEMENT SYSTEM</h3>
            <p class="text-sm">123 Medical Street, Lahore</p>
            <p class="text-sm">Phone: 0300-1234567</p>
        </div>
        
        <div class="border-t border-b border-dashed py-2 my-2">
            <div class="flex justify-between mb-1">
                <span class="font-bold">BILL NO:</span>
                <span><?php echo isset($bill_group_id) ? $bill_group_id : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span class="font-bold">DATE:</span>
                <span><?php echo date('d M Y'); ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span class="font-bold">TIME:</span>
                <span><?php echo date('h:i A'); ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">PATIENT DETAILS:</div>
            <div class="flex justify-between mb-1">
                <span>ID:</span>
                <span><?php echo isset($patient) ? $patient['id'] : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Name:</span>
                <span><?php echo isset($patient) ? $patient['name'] : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Age:</span>
                <span><?php echo isset($patient) ? $patient['age'] : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Gender:</span>
                <span><?php echo isset($patient) ? $patient['gender'] : ''; ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">BILL DETAILS:</div>
            <div class="mb-2">
                <div class="text-sm font-medium">Services:</div>
                <div class="text-xs">
                    <?php
                    if (isset($service_names)) {
                        for ($i = 0; $i < count($service_names); $i++) {
                            if (!empty($service_names[$i])) {
                                echo "• " . $service_names[$i] . ": " . formatCurrency($amounts[$i]) . "<br>";
                            }
                        }
                    }
                    ?>
                </div>
            </div>
            <div class="flex justify-between mb-1">
                <span>Total Amount:</span>
                <span><?php echo isset($total_amount) ? formatCurrency($total_amount) : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Total Discount:</span>
                <span><?php echo isset($total_discount) ? formatCurrency($total_discount) : ''; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Total Paid:</span>
                <span><?php echo isset($total_paid) ? formatCurrency($total_paid) : ''; ?></span>
            </div>
        </div>
        
        <div class="text-center text-xs mt-6">
            <p>Thank you for your payment</p>
            <p>Please keep this receipt for your records</p>
        </div>
    </div>
</div>

<script>
    // Add new service row
    document.getElementById('add-service-btn').addEventListener('click', function() {
        const container = document.getElementById('services-container');
        const serviceRow = document.createElement('div');
        serviceRow.className = 'service-row grid grid-cols-1 md:grid-cols-5 gap-4 mb-4 p-4 border border-gray-200 rounded-lg';
        
        serviceRow.innerHTML = `
            <div>
                <label class="block text-gray-700 font-medium mb-2">Service Name</label>
                <select name="service_name[]" class="service-name w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select a service</option>
                    
                    <!-- Custom Services from Pricing Module -->
                    <optgroup label="Custom Services">
                        <?php 
                        $custom_services->data_seek(0);
                        while ($service = $custom_services->fetch_assoc()): ?>
                            <option value="<?php echo htmlspecialchars($service['service_name']); ?>" 
                                    data-price="<?php echo $service['price']; ?>"
                                    data-type="custom">
                                <?php echo $service['service_name'] . ' (' . ucfirst($service['service_type']) . ') - ' . formatCurrency($service['price']); ?>
                            </option>
                        <?php endwhile; ?>
                    </optgroup>
                    
                    <!-- Lab Tests -->
                    <optgroup label="Lab Tests">
                        <?php 
                        $tests->data_seek(0);
                        while ($test = $tests->fetch_assoc()): ?>
                            <option value="<?php echo htmlspecialchars($test['test_name']); ?>" 
                                    data-price="<?php echo $test['price']; ?>"
                                    data-type="lab">
                                <?php echo $test['test_name'] . ' - ' . formatCurrency($test['price']); ?>
                            </option>
                        <?php endwhile; ?>
                    </optgroup>
                    
                    <!-- Room Charges -->
                    <optgroup label="Room Charges">
                        <?php 
                        $rooms->data_seek(0);
                        while ($room = $rooms->fetch_assoc()): ?>
                            <option value="<?php echo htmlspecialchars($room['room_name']); ?>" 
                                    data-price="<?php echo $room['price']; ?>"
                                    data-type="room">
                                <?php echo $room['room_name'] . ' - ' . formatCurrency($room['price']) . '/day'; ?>
                            </option>
                        <?php endwhile; ?>
                    </optgroup>
                    
                    <!-- Standard Services -->
                    <optgroup label="Standard Services">
                        <option value="Doctor Consultation" data-price="1000" data-type="standard">Doctor Consultation - PKR 1,000</option>
                        <option value="Emergency Fee" data-price="2000" data-type="standard">Emergency Fee - PKR 2,000</option>
                        <option value="Medicines" data-price="500" data-type="standard">Medicines - PKR 500</option>
                        <option value="Other Services" data-price="0" data-type="standard">Other Services</option>
                    </optgroup>
                </select>
            </div>
            
            <div>
                <label class="block text-gray-700 font-medium mb-2">Amount (PKR)</label>
                <input type="number" name="amount[]" class="service-amount w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div>
                <label class="block text-gray-700 font-medium mb-2">Discount (PKR)</label>
                <input type="number" name="discount[]" class="service-discount w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" value="0">
            </div>
            
            <div>
                <label class="block text-gray-700 font-medium mb-2">Paid Amount (PKR)</label>
                <input type="number" name="paid_amount[]" class="service-paid w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex items-end">
                <button type="button" class="remove-service-btn bg-red-600 text-white py-2 px-3 rounded hover:bg-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(serviceRow);
        
        // Add event listeners to the new row
        addServiceRowEventListeners(serviceRow);
        
        // Update totals
        updateTotals();
    });
    
    // Remove service row
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-service-btn')) {
            e.target.closest('.service-row').remove();
            updateTotals();
        }
    });
    
    // Add event listeners to initial service row
    function addServiceRowEventListeners(row) {
        const serviceSelect = row.querySelector('.service-name');
        const amountInput = row.querySelector('.service-amount');
        const discountInput = row.querySelector('.service-discount');
        const paidInput = row.querySelector('.service-paid');
        
        // Auto-fill amount when service is selected
        serviceSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            
            if (price && price !== '0') {
                amountInput.value = price;
                
                // Calculate paid amount
                const amount = parseFloat(amountInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                paidInput.value = (amount - discount).toFixed(2);
            }
            
            updateTotals();
        });
        
        // Calculate paid amount when amount or discount changes
        amountInput.addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            paidInput.value = (amount - discount).toFixed(2);
            updateTotals();
        });
        
        discountInput.addEventListener('input', function() {
            const amount = parseFloat(amountInput.value) || 0;
            const discount = parseFloat(this.value) || 0;
            paidInput.value = (amount - discount).toFixed(2);
            updateTotals();
        });
        
        paidInput.addEventListener('input', updateTotals);
    }
    
    // Add event listeners to initial service row
    const initialServiceRow = document.querySelector('.service-row');
    if (initialServiceRow) {
        addServiceRowEventListeners(initialServiceRow);
    }
    
    // Update totals
    function updateTotals() {
        const amountInputs = document.querySelectorAll('.service-amount');
        const discountInputs = document.querySelectorAll('.service-discount');
        const paidInputs = document.querySelectorAll('.service-paid');
        
        let totalAmount = 0;
        let totalDiscount = 0;
        let totalPaid = 0;
        
        amountInputs.forEach(input => {
            totalAmount += parseFloat(input.value) || 0;
        });
        
        discountInputs.forEach(input => {
            totalDiscount += parseFloat(input.value) || 0;
        });
        
        paidInputs.forEach(input => {
            totalPaid += parseFloat(input.value) || 0;
        });
        
        document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        document.getElementById('total-discount').textContent = totalDiscount.toFixed(2);
        document.getElementById('total-paid').textContent = totalPaid.toFixed(2);
    }
    
    function printBill() {
        const printContent = document.getElementById('bill-print').innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
    }
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: billing.txt ===

=== START: bill_details.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get bill group ID from URL
$bill_group_id = isset($_GET['bill_group_id']) ? $_GET['bill_group_id'] : '';

// Get bill details
$query = "SELECT * FROM billing WHERE bill_group_id = '$bill_group_id'";
$result = $conn->query($query);

if ($result->num_rows === 0) {
    // Redirect if bill not found
    header('Location: billing.php');
    exit;
}

$bill_items = [];
$total_amount = 0;
$total_discount = 0;
$total_paid = 0;
$patient_id = null;

while ($row = $result->fetch_assoc()) {
    $bill_items[] = $row;
    $total_amount += $row['amount'];
    $total_discount += $row['discount'];
    $total_paid += $row['paid_amount'];
    $patient_id = $row['patient_id'];
}

$patient = getPatient($patient_id);
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Bill Details</h1>
    <p class="text-gray-600">View detailed bill information</p>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-xl font-semibold text-gray-800">Bill #<?php echo $bill_group_id; ?></h2>
            <p class="text-gray-600">Date: <?php echo date('d M Y', strtotime($bill_items[0]['created_at'])); ?></p>
        </div>
        <div>
            <button onclick="printBill()" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                <i class="fas fa-print mr-2"></i> Print Bill
            </button>
            <a href="generate_bill.php?bill_group_id=<?php echo $bill_group_id; ?>" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition ml-2">
                <i class="fas fa-file-pdf mr-2"></i> Generate PDF
            </a>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <div class="lg:col-span-1">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Patient Information</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">ID:</span>
                        <span class="font-medium"><?php echo $patient['id']; ?></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Name:</span>
                        <span class="font-medium"><?php echo $patient['name']; ?></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Age:</span>
                        <span class="font-medium"><?php echo $patient['age']; ?></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Gender:</span>
                        <span class="font-medium"><?php echo $patient['gender']; ?></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Contact:</span>
                        <span class="font-medium"><?php echo $patient['contact']; ?></span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="lg:col-span-2">
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-800 mb-4">Bill Summary</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Total Amount</div>
                        <div class="text-xl font-bold"><?php echo formatCurrency($total_amount); ?></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Total Discount</div>
                        <div class="text-xl font-bold"><?php echo formatCurrency($total_discount); ?></div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600">Total Paid</div>
                        <div class="text-xl font-bold"><?php echo formatCurrency($total_paid); ?></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php foreach ($bill_items as $item): ?>
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap"><?php echo $item['service_name']; ?></td>
                        <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($item['amount']); ?></td>
                        <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($item['discount']); ?></td>
                        <td class="px-6 py-4 whitespace-nowrap"><?php echo formatCurrency($item['paid_amount']); ?></td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php 
                                if ($item['status'] === 'paid') echo 'bg-green-100 text-green-800';
                                elseif ($item['status'] === 'unpaid') echo 'bg-yellow-100 text-yellow-800';
                                else echo 'bg-red-100 text-red-800';
                            ?>">
                                <?php echo ucfirst($item['status']); ?>
                            </span>
                        </td>
                    </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
</div>

<div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions</h2>
    <div class="flex space-x-4">
        <a href="billing.php" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
            <i class="fas fa-arrow-left mr-2"></i> Back to Billing
        </a>
        <a href="bill_records.php" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition">
            <i class="fas fa-list mr-2"></i> View All Bills
        </a>
    </div>
</div>

<!-- Bill Print Template -->
<div id="bill-print" class="hidden">
    <div class="p-6" style="width: 300px; font-family: monospace;">
        <div class="text-center mb-4">
            <h3 class="font-bold text-lg">HOSPITAL MANAGEMENT SYSTEM</h3>
            <p class="text-sm">123 Medical Street, Lahore</p>
            <p class="text-sm">Phone: 0300-1234567</p>
        </div>
        
        <div class="border-t border-b border-dashed py-2 my-2">
            <div class="flex justify-between mb-1">
                <span class="font-bold">BILL NO:</span>
                <span><?php echo $bill_group_id; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span class="font-bold">DATE:</span>
                <span><?php echo date('d M Y', strtotime($bill_items[0]['created_at'])); ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">PATIENT DETAILS:</div>
            <div class="flex justify-between mb-1">
                <span>ID:</span>
                <span><?php echo $patient['id']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Name:</span>
                <span><?php echo $patient['name']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Age:</span>
                <span><?php echo $patient['age']; ?></span>
            </div>
            <div class="flex justify-between mb-1">
                <span>Gender:</span>
                <span><?php echo $patient['gender']; ?></span>
            </div>
        </div>
        
        <div class="mb-4">
            <div class="font-bold mb-2">BILL DETAILS:</div>
            <?php foreach ($bill_items as $item): ?>
                <div class="mb-2">
                    <div><?php echo $item['service_name']; ?></div>
                    <div class="flex justify-between text-sm">
                        <span>Amount: <?php echo formatCurrency($item['amount']); ?></span>
                        <span>Paid: <?php echo formatCurrency($item['paid_amount']); ?></span>
                    </div>
                </div>
            <?php endforeach; ?>
        </div>
        
        <div class="border-t border-dashed pt-2">
            <div class="flex justify-between font-bold mb-1">
                <span>Total Amount:</span>
                <span><?php echo formatCurrency($total_amount); ?></span>
            </div>
            <div class="flex justify-between font-bold mb-1">
                <span>Total Discount:</span>
                <span><?php echo formatCurrency($total_discount); ?></span>
            </div>
            <div class="flex justify-between font-bold">
                <span>Total Paid:</span>
                <span><?php echo formatCurrency($total_paid); ?></span>
            </div>
        </div>
        
        <div class="text-center text-xs mt-6">
            <p>Thank you for your payment</p>
            <p>Please keep this receipt for your records</p>
        </div>
    </div>
</div>

<script>
    function printBill() {
        const printContent = document.getElementById('bill-print').innerHTML;
        const originalContent = document.body.innerHTML;
        
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
    }
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: bill_details.txt ===

=== START: bill_records.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get filter parameters
$filter = isset($_GET['filter']) ? $_GET['filter'] : 'today';
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-d');
$end_date = isset($_GET['end_date']) ? $_GET['end_date'] : date('Y-m-d');
$token_filter = isset($_GET['token_filter']) ? $_GET['token_filter'] : 'today';
$token_type = isset($_GET['token_type']) ? $_GET['token_type'] : 'all';

// Build date filter query for bills
$date_filter = "";
if ($filter === 'today') {
    $date_filter = "DATE(created_at) = CURDATE()";
} elseif ($filter === 'yesterday') {
    $date_filter = "DATE(created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)";
} elseif ($filter === 'this_week') {
    $date_filter = "YEARWEEK(created_at) = YEARWEEK(CURDATE())";
} elseif ($filter === 'this_month') {
    $date_filter = "MONTH(created_at) = MONTH(CURDATE()) AND YEAR(created_at) = YEAR(CURDATE())";
} elseif ($filter === 'custom') {
    $date_filter = "DATE(created_at) BETWEEN '$start_date' AND '$end_date'";
}

// Build date filter query for tokens
$token_date_filter = "";
if ($token_filter === 'today') {
    $token_date_filter = "DATE(t.created_at) = CURDATE()";
} elseif ($token_filter === 'yesterday') {
    $token_date_filter = "DATE(t.created_at) = DATE_SUB(CURDATE(), INTERVAL 1 DAY)";
} elseif ($token_filter === 'this_week') {
    $token_date_filter = "YEARWEEK(t.created_at) = YEARWEEK(CURDATE())";
} elseif ($token_filter === 'this_month') {
    $token_date_filter = "MONTH(t.created_at) = MONTH(CURDATE()) AND YEAR(t.created_at) = YEAR(CURDATE())";
} elseif ($token_filter === 'custom') {
    $token_date_filter = "DATE(t.created_at) BETWEEN '$start_date' AND '$end_date'";
}

// Add token type filter
$token_type_filter = "";
if ($token_type !== 'all') {
    $token_type_filter = " AND t.type = '$token_type'";
}

// Get bills
$query = "SELECT bill_group_id, patient_id, SUM(amount) as total_amount, SUM(discount) as total_discount, 
                 SUM(paid_amount) as total_paid, status, MAX(created_at) as created_at 
          FROM billing 
          WHERE $date_filter
          GROUP BY bill_group_id 
          ORDER BY created_at DESC";
$result = $conn->query($query);

// Get bill statistics
$stats_query = "SELECT 
                    COUNT(DISTINCT bill_group_id) as total_bills,
                    SUM(CASE WHEN status = 'paid' THEN paid_amount ELSE 0 END) as total_revenue,
                    SUM(CASE WHEN status = 'refund' THEN paid_amount ELSE 0 END) as total_refund,
                    COUNT(CASE WHEN status = 'refund' THEN 1 END) as refund_count
                FROM billing 
                WHERE $date_filter";
$stats_result = $conn->query($stats_query);
$stats = $stats_result->fetch_assoc();

// Get tokens with filter
$token_query = "SELECT t.*, p.name as patient_name, s.name as doctor_name, ts.test_name 
                FROM tokens t 
                JOIN patients p ON t.patient_id = p.id 
                LEFT JOIN staff s ON t.doctor_id = s.id 
                LEFT JOIN tests ts ON t.test_id = ts.id 
                WHERE $token_date_filter $token_type_filter
                ORDER BY t.created_at DESC";
$token_result = $conn->query($token_query);

// Get token statistics
$token_stats_query = "SELECT 
                        COUNT(*) as total_tokens,
                        COUNT(CASE WHEN status = 'waiting' THEN 1 END) as waiting_tokens,
                        COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_tokens,
                        COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled_tokens,
                        COUNT(CASE WHEN type = 'doctor' THEN 1 END) as doctor_tokens,
                        COUNT(CASE WHEN type = 'lab' THEN 1 END) as lab_tokens
                      FROM tokens t
                      WHERE $token_date_filter $token_type_filter";
$token_stats_result = $conn->query($token_stats_query);
$token_stats = $token_stats_result->fetch_assoc();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Records & Token Management - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <?php include __DIR__ . '/../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Bill Records & Token Management</h1>
            <p class="text-gray-600">Comprehensive view of billing records and token management</p>
        </div>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
                <button onclick="showTab('bills')" id="bills-tab" class="tab-btn py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Bill Records
                </button>
                <button onclick="showTab('tokens')" id="tokens-tab" class="tab-btn py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                    <i class="fas fa-ticket-alt mr-2"></i>Token Management
                </button>
            </nav>
        </div>

        <!-- Bills Tab Content -->
        <div id="bills-content" class="tab-content">
            <!-- Bill Filters -->
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
                <div class="bg-indigo-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-filter mr-2"></i>
                        Filter Bills
                    </h2>
                </div>
                <div class="p-6">
                    <form method="get" action="bill_records.php" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="hidden" name="tab" value="bills">
                        <div>
                            <label for="filter" class="block text-gray-700 font-medium mb-2">Date Range</label>
                            <select id="filter" name="filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="toggleDateFields()">
                                <option value="today" <?php echo $filter === 'today' ? 'selected' : ''; ?>>Today</option>
                                <option value="yesterday" <?php echo $filter === 'yesterday' ? 'selected' : ''; ?>>Yesterday</option>
                                <option value="this_week" <?php echo $filter === 'this_week' ? 'selected' : ''; ?>>This Week</option>
                                <option value="this_month" <?php echo $filter === 'this_month' ? 'selected' : ''; ?>>This Month</option>
                                <option value="custom" <?php echo $filter === 'custom' ? 'selected' : ''; ?>>Custom Range</option>
                            </select>
                        </div>
                        
                        <div id="start-date-field" class="<?php echo $filter !== 'custom' ? 'hidden' : ''; ?>">
                            <label for="start_date" class="block text-gray-700 font-medium mb-2">Start Date</label>
                            <input type="date" id="start_date" name="start_date" value="<?php echo $start_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div id="end-date-field" class="<?php echo $filter !== 'custom' ? 'hidden' : ''; ?>">
                            <label for="end_date" class="block text-gray-700 font-medium mb-2">End Date</label>
                            <input type="date" id="end_date" name="end_date" value="<?php echo $end_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-search mr-2"></i>Apply Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Bill Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                            <i class="fas fa-file-invoice-dollar text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Total Bills</h2>
                            <p class="text-2xl font-bold"><?php echo $stats['total_bills'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100 text-green-500">
                            <i class="fas fa-money-bill-wave text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Total Revenue</h2>
                            <p class="text-2xl font-bold"><?php echo formatCurrency($stats['total_revenue'] ?: 0); ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-red-100 text-red-500">
                            <i class="fas fa-undo text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Total Refunds</h2>
                            <p class="text-2xl font-bold"><?php echo formatCurrency($stats['total_refund'] ?: 0); ?></p>
                            <p class="text-sm text-gray-500"><?php echo $stats['refund_count'] ?: 0; ?> refunds</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                            <i class="fas fa-chart-pie text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <h2 class="text-lg font-semibold text-gray-700">Net Revenue</h2>
                            <p class="text-2xl font-bold"><?php echo formatCurrency(($stats['total_revenue'] ?: 0) - ($stats['total_refund'] ?: 0)); ?></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bills Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="bg-indigo-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center justify-between">
                        <span><i class="fas fa-list-alt mr-2"></i>Billing Records</span>
                        <a href="billing.php" class="bg-indigo-700 hover:bg-indigo-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i>New Bill
                        </a>
                    </h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php if ($result->num_rows > 0): ?>
                                <?php while ($row = $result->fetch_assoc()): ?>
                                    <?php $patient = getPatient($row['patient_id']); ?>
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="font-medium text-gray-900"><?php echo $row['bill_group_id']; ?></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900"><?php echo $patient['name']; ?></div>
                                            <div class="text-sm text-gray-500">ID: <?php echo $patient['id']; ?></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <?php echo date('d M Y', strtotime($row['created_at'])); ?>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <?php echo formatCurrency($row['total_amount']); ?>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <?php echo formatCurrency($row['total_paid']); ?>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php 
                                                if ($row['status'] === 'paid') echo 'bg-green-100 text-green-800';
                                                elseif ($row['status'] === 'unpaid') echo 'bg-yellow-100 text-yellow-800';
                                                else echo 'bg-red-100 text-red-800';
                                            ?>">
                                                <?php echo ucfirst($row['status']); ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <a href="bill_details.php?bill_group_id=<?php echo $row['bill_group_id']; ?>" 
                                               class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mr-2">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <?php if ($row['status'] !== 'refund'): ?>
                                            <button onclick="confirmRefund('<?php echo $row['bill_group_id']; ?>')"
                                                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endwhile; ?>
                            <?php else: ?>
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center">
                                        <i class="fas fa-file-invoice text-gray-400 text-4xl mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-1">No bills found</h3>
                                        <p class="text-gray-500">No bills found for the selected criteria</p>
                                    </td>
                                </tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tokens Tab Content -->
        <div id="tokens-content" class="tab-content hidden">
            <!-- Token Filters -->
            <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
                <div class="bg-green-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-filter mr-2"></i>
                        Filter Tokens
                    </h2>
                </div>
                <div class="p-6">
                    <form method="get" action="bill_records.php" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input type="hidden" name="tab" value="tokens">
                        <div>
                            <label for="token_filter" class="block text-gray-700 font-medium mb-2">Date Range</label>
                            <select id="token_filter" name="token_filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="today" <?php echo $token_filter === 'today' ? 'selected' : ''; ?>>Today</option>
                                <option value="yesterday" <?php echo $token_filter === 'yesterday' ? 'selected' : ''; ?>>Yesterday</option>
                                <option value="this_week" <?php echo $token_filter === 'this_week' ? 'selected' : ''; ?>>This Week</option>
                                <option value="this_month" <?php echo $token_filter === 'this_month' ? 'selected' : ''; ?>>This Month</option>
                                <option value="custom" <?php echo $token_filter === 'custom' ? 'selected' : ''; ?>>Custom Range</option>
                            </select>
                        </div>

                        <div>
                            <label for="token_type" class="block text-gray-700 font-medium mb-2">Token Type</label>
                            <select id="token_type" name="token_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="all" <?php echo $token_type === 'all' ? 'selected' : ''; ?>>All Tokens</option>
                                <option value="doctor" <?php echo $token_type === 'doctor' ? 'selected' : ''; ?>>Doctor Only</option>
                                <option value="lab" <?php echo $token_type === 'lab' ? 'selected' : ''; ?>>Lab Only</option>
                            </select>
                        </div>
                        
                        <div id="token-start-date-field" class="<?php echo $token_filter !== 'custom' ? 'hidden' : ''; ?>">
                            <label for="token_start_date" class="block text-gray-700 font-medium mb-2">Start Date</label>
                            <input type="date" id="token_start_date" name="start_date" value="<?php echo $start_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div id="token-end-date-field" class="<?php echo $token_filter !== 'custom' ? 'hidden' : ''; ?>">
                            <label for="token_end_date" class="block text-gray-700 font-medium mb-2">End Date</label>
                            <input type="date" id="token_end_date" name="end_date" value="<?php echo $end_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                                <i class="fas fa-search mr-2"></i>Apply Filter
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Token Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-blue-100 text-blue-500">
                            <i class="fas fa-ticket-alt text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Total</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['total_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-yellow-100 text-yellow-500">
                            <i class="fas fa-clock text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Waiting</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['waiting_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-green-100 text-green-500">
                            <i class="fas fa-check-circle text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Completed</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['completed_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-red-100 text-red-500">
                            <i class="fas fa-times-circle text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Cancelled</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['cancelled_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-purple-100 text-purple-500">
                            <i class="fas fa-user-md text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Doctor</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['doctor_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="flex items-center">
                        <div class="p-2 rounded-full bg-indigo-100 text-indigo-500">
                            <i class="fas fa-flask text-lg"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-gray-700">Lab</h3>
                            <p class="text-lg font-bold"><?php echo $token_stats['lab_tokens'] ?: 0; ?></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tokens Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="bg-green-600 text-white px-6 py-4">
                    <h2 class="text-xl font-semibold flex items-center justify-between">
                        <span><i class="fas fa-ticket-alt mr-2"></i>Token Records</span>
                        <a href="token.php" class="bg-green-700 hover:bg-green-800 px-3 py-1 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i>New Token
                        </a>
                    </h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <?php if ($token_result->num_rows > 0): ?>
                                <?php while ($token = $token_result->fetch_assoc()): ?>
                                    <tr class="hover:bg-gray-50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                                <?php echo $token['token_no']; ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                            <div class="text-sm text-gray-500">ID: <?php echo $token['patient_id']; ?></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                                <i class="fas fa-<?php echo $token['type'] === 'doctor' ? 'user-md' : 'flask'; ?> mr-1"></i>
                                                <?php echo ucfirst($token['type']); ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            <?php 
                                            if ($token['type'] === 'doctor' && $token['doctor_name']) {
                                                echo "Dr. " . $token['doctor_name'];
                                            } elseif ($token['type'] === 'lab' && $token['test_name']) {
                                                echo $token['test_name'];
                                            } else {
                                                echo "<span class='text-gray-500'>Not assigned</span>";
                                            }
                                            ?>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <?php echo date('d M Y, h:i A', strtotime($token['created_at'])); ?>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php 
                                                if ($token['status'] === 'waiting') echo 'bg-yellow-100 text-yellow-800';
                                                elseif ($token['status'] === 'completed') echo 'bg-green-100 text-green-800';
                                                else echo 'bg-red-100 text-red-800';
                                            ?>">
                                                <i class="fas fa-<?php 
                                                    if ($token['status'] === 'waiting') echo 'clock';
                                                    elseif ($token['status'] === 'completed') echo 'check-circle';
                                                    else echo 'times-circle';
                                                ?> mr-1"></i>
                                                <?php echo ucfirst($token['status']); ?>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="printToken('<?php echo $token['token_no']; ?>', '<?php echo $token['patient_id']; ?>', '<?php echo $token['patient_name']; ?>', '<?php echo $token['type']; ?>', '<?php echo ($token['type'] === 'doctor' && $token['doctor_name']) ? "Dr. " . $token['doctor_name'] : (($token['type'] === 'lab' && $token['test_name']) ? $token['test_name'] : 'N/A'); ?>')" 
                                                    class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mr-2">
                                                <i class="fas fa-print"></i>
                                            </button>
                                            <?php if ($token['status'] === 'waiting'): ?>
                                            <button onclick="confirmTokenCancel(<?php echo $token['id']; ?>)"
                                                    class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endwhile; ?>
                            <?php else: ?>
                                <tr>
                                    <td colspan="7" class="px-6 py-12 text-center">
                                        <i class="fas fa-ticket-alt text-gray-400 text-4xl mb-4"></i>
                                        <h3 class="text-lg font-medium text-gray-900 mb-1">No tokens found</h3>
                                        <p class="text-gray-500">No tokens found for the selected criteria</p>
                                    </td>
                                </tr>
                            <?php endif; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Refund Confirmation Modal -->
    <div id="refundModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Refund
            </h2>
            <p class="mb-4">Are you sure you want to refund this bill? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeRefundModal()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                    Cancel
                </button>
                <form method="post" action="process_refund.php" style="display: inline;">
                    <input type="hidden" id="refund_bill_id" name="bill_group_id">
                    <button type="submit" 
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        <i class="fas fa-undo mr-2"></i>Confirm Refund
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Token Cancel Confirmation Modal -->
    <div id="tokenCancelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-md">
            <h2 class="text-xl font-semibold mb-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>Cancel Token
            </h2>
            <p class="mb-4">Are you sure you want to cancel this token? This will also refund the associated payment.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeTokenCancelModal()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                    Cancel
                </button>
                <form method="post" action="process_refund.php" style="display: inline;">
                    <input type="hidden" id="cancel_token_id" name="token_id">
                    <button type="submit" name="cancel_token"
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        <i class="fas fa-times mr-2"></i>Cancel Token
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Hidden Token Print Template -->
    <div id="tokenTemplate" style="display: none;">
        <div style="width: 300px; padding: 15px; font-family: monospace; font-size: 12px;">
            <div style="text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; margin-bottom: 10px;">
                <h3 style="font-weight: bold; font-size: 14px; margin: 0;">HOSPITAL MANAGEMENT SYSTEM</h3>
                <p style="font-size: 10px; margin: 0;">123 Medical Street, Lahore</p>
                <p style="font-size: 10px; margin: 0;">Phone: 0300-1234567</p>
            </div>
            <div style="margin: 10px 0;">
                <div><strong>TOKEN NO:</strong> <span id="printTokenNo"></span></div>
                <div><strong>DATE:</strong> <span id="printDate"></span></div>
                <div><strong>TIME:</strong> <span id="printTime"></span></div>
            </div>
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin: 10px 0;">
                <div><strong>TYPE:</strong> <span id="printType"></span></div>
                <div><strong>ASSIGNED TO:</strong> <span id="printAssignedTo"></span></div>
            </div>
            <div style="margin: 10px 0;">
                <div style="font-weight: bold; text-decoration: underline;">PATIENT DETAILS:</div>
                <div><strong>ID:</strong> <span id="printPatientId"></span></div>
                <div><strong>NAME:</strong> <span id="printPatientName"></span></div>
            </div>
            <div style="text-align: center; margin-top: 15px; border-top: 1px dashed #000; padding-top: 5px; font-size: 10px;">
                <div>Please wait for your turn</div>
                <div>Thank you for visiting</div>
            </div>
        </div>
    </div>

    <script>
        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.add('hidden'));
            
            // Remove active styling from all tabs
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.classList.remove('border-blue-500', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active styling to selected tab
            const activeTab = document.getElementById(tabName + '-tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-blue-500', 'text-blue-600');
        }

        // Initialize tab from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab') || 'bills';
        showTab(activeTab);

        // Date field toggles for bills
        function toggleDateFields() {
            const filter = document.getElementById('filter').value;
            const startField = document.getElementById('start-date-field');
            const endField = document.getElementById('end-date-field');
            
            if (filter === 'custom') {
                startField.classList.remove('hidden');
                endField.classList.remove('hidden');
            } else {
                startField.classList.add('hidden');
                endField.classList.add('hidden');
            }
        }

        // Date field toggles for tokens
        document.getElementById('token_filter').addEventListener('change', function() {
            const filter = this.value;
            const startField = document.getElementById('token-start-date-field');
            const endField = document.getElementById('token-end-date-field');
            
            if (filter === 'custom') {
                startField.classList.remove('hidden');
                endField.classList.remove('hidden');
            } else {
                startField.classList.add('hidden');
                endField.classList.add('hidden');
            }
        });

        // Refund modal functions
        function confirmRefund(billGroupId) {
            document.getElementById('refund_bill_id').value = billGroupId;
            document.getElementById('refundModal').classList.remove('hidden');
        }

        function closeRefundModal() {
            document.getElementById('refundModal').classList.add('hidden');
        }

        // Token cancel modal functions
        function confirmTokenCancel(tokenId) {
            document.getElementById('cancel_token_id').value = tokenId;
            document.getElementById('tokenCancelModal').classList.remove('hidden');
        }

        function closeTokenCancelModal() {
            document.getElementById('tokenCancelModal').classList.add('hidden');
        }

        // Print token function
        function printToken(tokenNo, patientId, patientName, tokenType, assignedTo) {
            const currentDate = new Date().toLocaleDateString();
            const currentTime = new Date().toLocaleTimeString();
            const tokenTypeFormatted = tokenType.charAt(0).toUpperCase() + tokenType.slice(1);
            
            // Create a new window for printing
            const printWindow = window.open('', '_blank');
            
            // Get the template HTML
            const template = document.getElementById('tokenTemplate').innerHTML;
            
            // Create the complete HTML document
            let printContent = '<!DOCTYPE html>';
            printContent += '<html><head><title>Token - ' + tokenNo + '</title>';
            printContent += '<style>body { margin: 0; padding: 0; font-family: monospace; }</style>';
            printContent += '</head><body>';
            printContent += template;
            printContent += '<script>';
            printContent += 'document.getElementById("printTokenNo").textContent = "' + tokenNo + '";';
            printContent += 'document.getElementById("printDate").textContent = "' + currentDate + '";';
            printContent += 'document.getElementById("printTime").textContent = "' + currentTime + '";';
            printContent += 'document.getElementById("printType").textContent = "' + tokenTypeFormatted + '";';
            printContent += 'document.getElementById("printAssignedTo").textContent = "' + assignedTo + '";';
            printContent += 'document.getElementById("printPatientId").textContent = "' + patientId + '";';
            printContent += 'document.getElementById("printPatientName").textContent = "' + patientName + '";';
            printContent += 'window.onload = function() { window.print(); setTimeout(function() { window.close(); }, 500); }';
            printContent += '<\/script></body></html>';
            
            printWindow.document.write(printContent);
            printWindow.document.close();
        }
    </script>
</body>
</html>
=== END: bill_records.txt ===

=== START: birth_certificates.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get record ID from URL
$record_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($record_id <= 0) {
    header('Location: /lch/modules/reception/view_birth_records.php?error=invalid_id');
    exit;
}

// Get birth record details
$record = getBirthRecord($record_id);

if (!$record) {
    header('Location: /lch/modules/reception/view_birth_records.php?error=record_not_found');
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Birth Certificate - <?php echo htmlspecialchars($record['newborn_name']); ?></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { margin: 0; padding: 0; }
            .certificate { margin: 0 !important; }
        }
        
        .certificate-border {
            border: 8px solid #1e40af;
            border-image: linear-gradient(45deg, #1e40af, #3b82f6, #60a5fa, #3b82f6, #1e40af) 1;
            position: relative;
        }
        
        .certificate-border::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706, #f59e0b, #fbbf24);
            z-index: -1;
            border-radius: 12px;
        }
        
        .ornament {
            background: radial-gradient(circle, #fbbf24, #f59e0b);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-block;
        }
        
        .seal {
            width: 100px;
            height: 100px;
            border: 3px solid #dc2626;
            border-radius: 50%;
            background: radial-gradient(circle, #fecaca, #dc2626);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dc2626;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Print Button -->
    <div class="no-print p-4 text-center">
        <button onclick="window.print()" class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 mr-4">
            <i class="fas fa-print mr-2"></i> Print Certificate
        </button>
        <a href="birth_record_details.php?id=<?php echo $record['id']; ?>" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 mr-4">
            <i class="fas fa-arrow-left mr-2"></i> Back to Details
        </a>
        <a href="view_birth_records.php" class="bg-gray-600 text-white py-2 px-6 rounded hover:bg-gray-700">
            <i class="fas fa-list mr-2"></i> All Records
        </a>
    </div>

    <!-- Birth Certificate -->
    <div class="certificate max-w-4xl mx-auto my-8 p-8">
        <div class="certificate-border bg-white p-8 relative">
            <!-- Ornamental corners -->
            <div class="absolute top-4 left-4"><div class="ornament"></div></div>
            <div class="absolute top-4 right-4"><div class="ornament"></div></div>
            <div class="absolute bottom-4 left-4"><div class="ornament"></div></div>
            <div class="absolute bottom-4 right-4"><div class="ornament"></div></div>
            
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-blue-800 text-2xl font-bold mb-2">ISLAMIC REPUBLIC OF PAKISTAN</div>
                <div class="text-lg font-semibold mb-2">GOVERNMENT OF KHYBER PAKHTUNKHWA</div>
                <div class="text-base mb-4">Union Council - Haripur District</div>
                <div class="border-t-2 border-b-2 border-blue-600 py-3 my-4">
                    <h1 class="text-3xl font-bold text-blue-800">BIRTH CERTIFICATE</h1>
                    <div class="text-sm text-gray-600 mt-1">شہادت پیدائش</div>
                </div>
            </div>

            <!-- Certificate Content -->
            <div class="grid grid-cols-3 gap-8">
                <!-- Left Column - Details -->
                <div class="col-span-2 space-y-4">
                    <div class="text-center mb-6">
                        <p class="text-lg">This is to certify that according to the record of</p>
                        <p class="text-xl font-bold text-blue-800">LIFE CARE HOSPITAL</p>
                        <p>Haripur, Khyber Pakhtunkhwa, Pakistan</p>
                    </div>

                    <div class="space-y-3 text-sm">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="font-semibold">Name of Child:</span>
                                <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                    <span class="text-lg font-bold text-blue-800"><?php echo htmlspecialchars($record['newborn_name']); ?></span>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold">Sex:</span>
                                <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                    <span class="text-lg font-bold"><?php echo $record['gender']; ?></span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Date of Birth:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold text-blue-800"><?php echo date('d F Y', strtotime($record['date_of_birth'])); ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Place of Birth:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold">Life Care Hospital, Haripur, KPK, Pakistan</span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Father's Name:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['father_name']); ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Father's NIC:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['father_nic']); ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Permanent Address:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="font-medium"><?php echo htmlspecialchars($record['address']); ?></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Seal and Signatures -->
                <div class="text-center space-y-6">
                    <div class="mx-auto seal">
                        <div>
                            OFFICIAL<br>
                            SEAL<br>
                            <i class="fas fa-certificate text-lg"></i>
                        </div>
                    </div>
                    
                    <div class="space-y-4 text-xs">
                        <div>
                            <div class="border-t border-gray-400 pt-2 mt-8">
                                <span class="font-semibold">Medical Officer</span><br>
                                <?php echo $record['doctor_name'] ? 'Dr. ' . htmlspecialchars($record['doctor_name']) : 'Medical Officer'; ?>
                            </div>
                        </div>
                        
                        <div>
                            <div class="border-t border-gray-400 pt-2 mt-8">
                                <span class="font-semibold">Registrar</span><br>
                                Life Care Hospital
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Information -->
            <div class="mt-8 pt-4 border-t-2 border-gray-300">
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <div><span class="font-semibold">Certificate No:</span> <?php echo $record['certificate_number']; ?></div>
                        <div><span class="font-semibold">Registration Date:</span> <?php echo date('d F Y', strtotime($record['created_at'])); ?></div>
                        <div><span class="font-semibold">Issued By:</span> <?php echo htmlspecialchars($record['issued_by']); ?></div>
                    </div>
                    <div class="text-right">
                        <div><span class="font-semibold">Time of Birth:</span> <?php echo date('h:i A', strtotime($record['time_of_birth'])); ?></div>
                        <div><span class="font-semibold">Weight:</span> <?php echo $record['weight'] ? $record['weight'] . ' kg' : 'Not recorded'; ?></div>
                        <div><span class="font-semibold">Delivery Type:</span> <?php echo $record['delivery_type']; ?></div>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-xs text-gray-600">
                    <p><span class="font-semibold">Life Care Hospital</span> - Maternity Home & Pain Clinic</p>
                    <p>Naseem Town Opposite Utman Marriage Hall Haripur, KPK, Pakistan</p>
                    <p>Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
                </div>
            </div>

            <!-- Legal Notice -->
            <div class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded text-xs">
                <p class="text-center font-semibold">IMPORTANT LEGAL NOTICE</p>
                <p class="text-center">This certificate is issued under the authority of Birth Registration Act. Any false information or tampering with this document is a punishable offense under the law.</p>
            </div>
        </div>
    </div>

    <script>
        // Auto-print when page loads (optional)
        // window.onload = function() { window.print(); }
    </script>
</body>
</html>
=== END: birth_certificates.txt ===

=== START: birth_death_records.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get recent records for dashboard
$recent_births = getBirthRecordsByDateRange(date('Y-m-d', strtotime('-30 days')), date('Y-m-d'));
$recent_deaths = getDeathRecordsByDateRange(date('Y-m-d', strtotime('-30 days')), date('Y-m-d'));

// Get statistics for current month
$start_of_month = date('Y-m-01');
$end_of_month = date('Y-m-d');
$birth_stats = getBirthStatistics($start_of_month, $end_of_month);
$death_stats = getDeathStatistics($start_of_month, $end_of_month);
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Birth & Death Records</h1>
    <p class="text-gray-600">Manage hospital birth and death certificates</p>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-baby text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Births This Month</h2>
                <p class="text-2xl font-bold"><?php echo $birth_stats['total_births'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-venus-mars text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Gender Ratio</h2>
                <p class="text-sm">Male: <?php echo $birth_stats['male_births'] ?: 0; ?> | Female: <?php echo $birth_stats['female_births'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-500">
                <i class="fas fa-heart-broken text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Deaths This Month</h2>
                <p class="text-2xl font-bold"><?php echo $death_stats['total_deaths'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-chart-line text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Avg Age at Death</h2>
                <p class="text-2xl font-bold"><?php echo $death_stats['avg_age_at_death'] ? round($death_stats['avg_age_at_death']) : 0; ?></p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Birth Records</h2>
        <div class="space-y-3">
            <a href="add_birth_record.php" class="block w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 text-center transition">
                <i class="fas fa-plus mr-2"></i> Add Birth Record
            </a>
            <a href="view_birth_records.php" class="block w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 text-center transition">
                <i class="fas fa-list mr-2"></i> View All Birth Records
            </a>
            <a href="birth_certificates.php" class="block w-full bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 text-center transition">
                <i class="fas fa-certificate mr-2"></i> Generate Birth Certificates
            </a>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Death Records</h2>
        <div class="space-y-3">
            <a href="add_death_record.php" class="block w-full bg-red-600 text-white py-3 px-4 rounded-md hover:bg-red-700 text-center transition">
                <i class="fas fa-plus mr-2"></i> Add Death Record
            </a>
            <a href="view_death_records.php" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-md hover:bg-gray-700 text-center transition">
                <i class="fas fa-list mr-2"></i> View All Death Records
            </a>
            <a href="death_certificates.php" class="block w-full bg-black text-white py-3 px-4 rounded-md hover:bg-gray-800 text-center transition">
                <i class="fas fa-certificate mr-2"></i> Generate Death Certificates
            </a>
        </div>
    </div>
</div>

<!-- Recent Records -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Recent Births -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Births (Last 30 Days)</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Newborn</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mother</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php if ($recent_births->num_rows > 0): ?>
                        <?php while ($birth = $recent_births->fetch_assoc()): ?>
                            <tr>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><?php echo htmlspecialchars($birth['newborn_name']); ?></td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm"><?php echo htmlspecialchars($birth['mother_name']); ?></td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm"><?php echo date('d M Y', strtotime($birth['date_of_birth'])); ?></td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php echo $birth['gender'] === 'Male' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'; ?>">
                                        <?php echo $birth['gender']; ?>
                                    </span>
                                </td>
                            </tr>
                        <?php endwhile; ?>
                    <?php else: ?>
                        <tr>
                            <td colspan="4" class="px-4 py-4 text-center text-gray-500">No recent births</td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Recent Deaths -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800">Recent Deaths (Last 30 Days)</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <?php if ($recent_deaths->num_rows > 0): ?>
                        <?php while ($death = $recent_deaths->fetch_assoc()): ?>
                            <tr>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium"><?php echo htmlspecialchars($death['deceased_name']); ?></td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm"><?php echo date('d M Y', strtotime($death['date_of_death'])); ?></td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm"><?php echo $death['age_at_death']; ?> years</td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                        <?php echo $death['certificate_number'] ? 'Certified' : 'Pending'; ?>
                                    </span>
                                </td>
                            </tr>
                        <?php endwhile; ?>
                    <?php else: ?>
                        <tr>
                            <td colspan="4" class="px-4 py-4 text-center text-gray-500">No recent deaths</td>
                        </tr>
                    <?php endif; ?>
                </tbody>
            </table>
        </div>
    </div>
</div>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: birth_death_records.txt ===

=== START: birth_record_details.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get record ID from URL
$record_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($record_id <= 0) {
    header('Location: /lch/modules/reception/view_birth_records.php?error=invalid_id');
    exit;
}

// Get birth record details
$record = getBirthRecord($record_id);

if (!$record) {
    header('Location: /lch/modules/reception/view_birth_records.php?error=record_not_found');
    exit;
}
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Birth Record Details</h1>
            <p class="text-gray-600">Certificate No: <?php echo $record['certificate_number']; ?></p>
        </div>
        <div class="space-x-3">
            <a href="birth_certificates.php?id=<?php echo $record['id']; ?>" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                <i class="fas fa-certificate mr-2"></i> Print Certificate
            </a>
            <a href="view_birth_records.php" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                <i class="fas fa-arrow-left mr-2"></i> Back to Records
            </a>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Newborn Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Newborn Information</h2>
        <div class="space-y-3">
            <div>
                <label class="text-sm font-medium text-gray-600">Name:</label>
                <p class="text-lg font-semibold text-green-600"><?php echo htmlspecialchars($record['newborn_name']); ?></p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">Gender:</label>
                    <p class="font-medium">
                        <span class="px-2 py-1 rounded-full text-xs <?php echo $record['gender'] === 'Male' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'; ?>">
                            <?php echo $record['gender']; ?>
                        </span>
                    </p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Delivery Type:</label>
                    <p class="font-medium"><?php echo $record['delivery_type']; ?></p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">Weight:</label>
                    <p class="font-medium"><?php echo $record['weight'] ? $record['weight'] . ' kg' : 'Not recorded'; ?></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">Length:</label>
                    <p class="font-medium"><?php echo $record['length'] ? $record['length'] . ' cm' : 'Not recorded'; ?></p>
                </div>
            </div>
            <div>
                <label class="text-sm font-medium text-gray-600">Date & Time of Birth:</label>
                <p class="font-medium"><?php echo date('d M Y', strtotime($record['date_of_birth'])); ?> at <?php echo date('h:i A', strtotime($record['time_of_birth'])); ?></p>
            </div>
        </div>
    </div>

    <!-- Parents Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Parents Information</h2>
        <div class="space-y-4">
            <div>
                <h3 class="text-md font-medium text-gray-700 mb-2">Father</h3>
                <div class="bg-blue-50 p-3 rounded">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Name:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['father_name']); ?></p>
                    </div>
                    <div class="mt-2">
                        <label class="text-sm font-medium text-gray-600">NIC:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['father_nic']); ?></p>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-md font-medium text-gray-700 mb-2">Mother</h3>
                <div class="bg-pink-50 p-3 rounded">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Name:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['mother_name']); ?></p>
                    </div>
                    <div class="mt-2">
                        <label class="text-sm font-medium text-gray-600">NIC:</label>
                        <p class="font-medium"><?php echo $record['mother_nic'] ? htmlspecialchars($record['mother_nic']) : 'Not provided'; ?></p>
                    </div>
                    <?php if ($record['mother_patient_name']): ?>
                    <div class="mt-2">
                        <label class="text-sm font-medium text-gray-600">Patient Record:</label>
                        <p class="font-medium text-blue-600"><?php echo htmlspecialchars($record['mother_patient_name']); ?></p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical & Additional Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Medical Information</h2>
        <div class="space-y-3">
            <div>
                <label class="text-sm font-medium text-gray-600">Attending Doctor:</label>
                <p class="font-medium"><?php echo $record['doctor_name'] ? 'Dr. ' . htmlspecialchars($record['doctor_name']) : 'Not assigned'; ?></p>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Birth Complications:</label>
                <div class="bg-gray-50 p-3 rounded mt-1">
                    <p class="text-sm"><?php echo $record['birth_complications'] ? nl2br(htmlspecialchars($record['birth_complications'])) : 'No complications reported'; ?></p>
                </div>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Certificate Information:</label>
                <div class="bg-green-50 p-3 rounded mt-1">
                    <div class="text-sm">
                        <div><strong>Certificate No:</strong> <?php echo $record['certificate_number']; ?></div>
                        <div><strong>Issued By:</strong> <?php echo htmlspecialchars($record['issued_by']); ?></div>
                        <div><strong>Issue Date:</strong> <?php echo date('d M Y, h:i A', strtotime($record['created_at'])); ?></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Information -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Address Information</h2>
    <div class="bg-gray-50 p-4 rounded">
        <p><?php echo nl2br(htmlspecialchars($record['address'])); ?></p>
    </div>
</div>

<!-- Actions -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions</h2>
    <div class="flex space-x-4">
        <a href="birth_certificates.php?id=<?php echo $record['id']; ?>" class="bg-green-600 text-white py-2 px-6 rounded hover:bg-green-700 transition">
            <i class="fas fa-certificate mr-2"></i> Generate Birth Certificate
        </a>
        <a href="view_birth_records.php" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 transition">
            <i class="fas fa-list mr-2"></i> Back to All Records
        </a>
        <a href="birth_death_records.php" class="bg-gray-600 text-white py-2 px-6 rounded hover:bg-gray-700 transition">
            <i class="fas fa-home mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: birth_record_details.txt ===

=== START: check_patient_doctor_token.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');

if (isset($_GET['patient_id'])) {
    $patient_id = $_GET['patient_id'];
    
    // Check if patient already has a waiting doctor token
    $check_query = "SELECT token_no FROM tokens 
                   WHERE patient_id = $patient_id 
                   AND type = 'doctor' 
                   AND status = 'waiting'";
    $result = $conn->query($check_query);
    
    if ($result->num_rows > 0) {
        $row = $result->fetch_assoc();
        echo json_encode([
            'hasToken' => true,
            'tokenNo' => $row['token_no']
        ]);
    } else {
        echo json_encode(['hasToken' => false]);
    }
}
?>
=== END: check_patient_doctor_token.txt ===

=== START: check_patient_room.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');

if (isset($_GET['patient_id'])) {
    $patient_id = $_GET['patient_id'];
    
    $check_assignment_query = "SELECT ra.*, r.room_name 
                             FROM room_assignments ra 
                             JOIN rooms r ON ra.room_id = r.id 
                             WHERE ra.patient_id = $patient_id";
    $result = $conn->query($check_assignment_query);
    
    if ($result->num_rows > 0) {
        $assignment = $result->fetch_assoc();
        echo json_encode([
            'hasRoom' => true,
            'roomName' => $assignment['room_name']
        ]);
    } else {
        echo json_encode(['hasRoom' => false]);
    }
}
?>
=== END: check_patient_room.txt ===

=== START: death_certificates.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get record ID from URL
$record_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($record_id <= 0) {
    header('Location: /lch/modules/reception/view_death_records.php?error=invalid_id');
    exit;
}

// Get death record details
$record = getDeathRecord($record_id);

if (!$record) {
    header('Location: /lch/modules/reception/view_death_records.php?error=record_not_found');
    exit;
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death Certificate - <?php echo htmlspecialchars($record['deceased_name']); ?></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { margin: 0; padding: 0; }
            .certificate { margin: 0 !important; }
        }
        
        .certificate-border {
            border: 8px solid #7f1d1d;
            border-image: linear-gradient(45deg, #7f1d1d, #dc2626, #ef4444, #dc2626, #7f1d1d) 1;
            position: relative;
        }
        
        .certificate-border::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, #374151, #6b7280, #9ca3af, #6b7280, #374151);
            z-index: -1;
            border-radius: 12px;
        }
        
        .ornament {
            background: radial-gradient(circle, #374151, #6b7280);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-block;
        }
        
        .seal {
            width: 100px;
            height: 100px;
            border: 3px solid #7f1d1d;
            border-radius: 50%;
            background: radial-gradient(circle, #fecaca, #7f1d1d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f1d1d;
            font-weight: bold;
            font-size: 10px;
            text-align: center;
            line-height: 1.2;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Print Button -->
    <div class="no-print p-4 text-center">
        <button onclick="window.print()" class="bg-red-600 text-white py-2 px-6 rounded hover:bg-red-700 mr-4">
            <i class="fas fa-print mr-2"></i> Print Certificate
        </button>
        <a href="death_record_details.php?id=<?php echo $record['id']; ?>" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 mr-4">
            <i class="fas fa-arrow-left mr-2"></i> Back to Details
        </a>
        <a href="view_death_records.php" class="bg-gray-600 text-white py-2 px-6 rounded hover:bg-gray-700">
            <i class="fas fa-list mr-2"></i> All Records
        </a>
    </div>

    <!-- Death Certificate -->
    <div class="certificate max-w-4xl mx-auto my-8 p-8">
        <div class="certificate-border bg-white p-8 relative">
            <!-- Ornamental corners -->
            <div class="absolute top-4 left-4"><div class="ornament"></div></div>
            <div class="absolute top-4 right-4"><div class="ornament"></div></div>
            <div class="absolute bottom-4 left-4"><div class="ornament"></div></div>
            <div class="absolute bottom-4 right-4"><div class="ornament"></div></div>
            
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="text-red-800 text-2xl font-bold mb-2">ISLAMIC REPUBLIC OF PAKISTAN</div>
                <div class="text-lg font-semibold mb-2">GOVERNMENT OF KHYBER PAKHTUNKHWA</div>
                <div class="text-base mb-4">Union Council - Haripur District</div>
                <div class="border-t-2 border-b-2 border-red-600 py-3 my-4">
                    <h1 class="text-3xl font-bold text-red-800">DEATH CERTIFICATE</h1>
                    <div class="text-sm text-gray-600 mt-1">شہادت وفات</div>
                </div>
            </div>

            <!-- Certificate Content -->
            <div class="grid grid-cols-3 gap-8">
                <!-- Left Column - Details -->
                <div class="col-span-2 space-y-4">
                    <div class="text-center mb-6">
                        <p class="text-lg">This is to certify that according to the record of</p>
                        <p class="text-xl font-bold text-red-800">LIFE CARE HOSPITAL</p>
                        <p>Haripur, Khyber Pakhtunkhwa, Pakistan</p>
                    </div>

                    <div class="space-y-3 text-sm">
                        <div>
                            <span class="font-semibold">Name of Deceased:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold text-red-800"><?php echo htmlspecialchars($record['deceased_name']); ?></span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <span class="font-semibold">Date of Death:</span>
                                <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                    <span class="text-lg font-bold text-red-800"><?php echo date('d F Y', strtotime($record['date_of_death'])); ?></span>
                                </div>
                            </div>
                            <div>
                                <span class="font-semibold">Time of Death:</span>
                                <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                    <span class="text-lg font-bold"><?php echo date('h:i A', strtotime($record['time_of_death'])); ?></span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Age at Death:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo $record['age_at_death']; ?> years</span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Place of Death:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['place_of_death']); ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Father's Name:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['father_name']); ?></span>
                            </div>
                        </div>

                        <?php if ($record['mother_name']): ?>
                        <div>
                            <span class="font-semibold">Mother's Name:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['mother_name']); ?></span>
                            </div>
                        </div>
                        <?php endif; ?>

                        <?php if ($record['spouse_name']): ?>
                        <div>
                            <span class="font-semibold">Spouse Name:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo htmlspecialchars($record['spouse_name']); ?></span>
                            </div>
                        </div>
                        <?php endif; ?>

                        <div>
                            <span class="font-semibold">NIC Number:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="text-lg font-bold"><?php echo $record['deceased_nic'] ?: 'Not Available'; ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Cause of Death:</span>
                            <div class="border border-gray-400 mt-1 p-2 bg-gray-50">
                                <span class="font-medium"><?php echo nl2br(htmlspecialchars($record['cause_of_death'])); ?></span>
                            </div>
                        </div>

                        <div>
                            <span class="font-semibold">Permanent Address:</span>
                            <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                                <span class="font-medium"><?php echo htmlspecialchars($record['address']); ?></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Seal and Signatures -->
                <div class="text-center space-y-6">
                    <div class="mx-auto seal">
                        <div>
                            OFFICIAL<br>
                            SEAL<br>
                            <i class="fas fa-certificate text-lg"></i>
                        </div>
                    </div>
                    
                    <div class="space-y-4 text-xs">
                        <div>
                            <div class="border-t border-gray-400 pt-2 mt-8">
                                <span class="font-semibold">Medical Officer</span><br>
                                <?php echo $record['doctor_name'] ? 'Dr. ' . htmlspecialchars($record['doctor_name']) : 'Medical Officer'; ?>
                            </div>
                        </div>
                        
                        <div>
                            <div class="border-t border-gray-400 pt-2 mt-8">
                                <span class="font-semibold">Registrar</span><br>
                                Life Care Hospital
                            </div>
                        </div>

                        <?php if ($record['autopsy_required']): ?>
                        <div class="mt-4 p-2 bg-yellow-100 border border-yellow-400 rounded text-xs">
                            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
                            <div class="font-semibold text-yellow-800">AUTOPSY REQUIRED</div>
                        </div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>

            <!-- Next of Kin Information -->
            <div class="mt-6 pt-4 border-t border-gray-300">
                <h3 class="font-semibold text-sm mb-3">NEXT OF KIN INFORMATION</h3>
                <div class="grid grid-cols-3 gap-4 text-xs">
                    <div>
                        <span class="font-semibold">Name:</span>
                        <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                            <?php echo htmlspecialchars($record['next_of_kin']); ?>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold">Relation:</span>
                        <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                            <?php echo htmlspecialchars($record['next_of_kin_relation']); ?>
                        </div>
                    </div>
                    <div>
                        <span class="font-semibold">Contact:</span>
                        <div class="border-b border-dotted border-gray-400 mt-1 pb-1">
                            <?php echo htmlspecialchars($record['next_of_kin_contact']); ?>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Information -->
            <div class="mt-6 pt-4 border-t-2 border-gray-300">
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div>
                        <div><span class="font-semibold">Certificate No:</span> <?php echo $record['certificate_number']; ?></div>
                        <div><span class="font-semibold">Registration Date:</span> <?php echo date('d F Y', strtotime($record['created_at'])); ?></div>
                        <div><span class="font-semibold">Issued By:</span> <?php echo htmlspecialchars($record['issued_by']); ?></div>
                    </div>
                    <div class="text-right">
                        <div><span class="font-semibold">Registration Time:</span> <?php echo date('h:i A', strtotime($record['created_at'])); ?></div>
                        <div><span class="font-semibold">Document Type:</span> Official Death Certificate</div>
                        <div><span class="font-semibold">Status:</span> Certified Copy</div>
                    </div>
                </div>
                
                <div class="text-center mt-4 text-xs text-gray-600">
                    <p><span class="font-semibold">Life Care Hospital</span> - Maternity Home & Pain Clinic</p>
                    <p>Naseem Town Opposite Utman Marriage Hall Haripur, KPK, Pakistan</p>
                    <p>Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
                </div>
            </div>

            <!-- Legal Notice -->
            <div class="mt-6 p-3 bg-red-50 border border-red-200 rounded text-xs">
                <p class="text-center font-semibold text-red-800">IMPORTANT LEGAL NOTICE</p>
                <p class="text-center">This certificate is issued under the authority of Death Registration Act. Any false information or tampering with this document is a punishable offense under the law. This document is required for legal proceedings, insurance claims, and inheritance matters.</p>
            </div>
        </div>
    </div>

    <script>
        // Auto-print when page loads (optional)
        // window.onload = function() { window.print(); }
    </script>
</body>
</html>
=== END: death_certificates.txt ===

=== START: death_record_details.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get record ID from URL
$record_id = isset($_GET['id']) ? intval($_GET['id']) : 0;

if ($record_id <= 0) {
    header('Location: /lch/modules/reception/view_death_records.php?error=invalid_id');
    exit;
}

// Get death record details
$record = getDeathRecord($record_id);

if (!$record) {
    header('Location: /lch/modules/reception/view_death_records.php?error=record_not_found');
    exit;
}
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Death Record Details</h1>
            <p class="text-gray-600">Certificate No: <?php echo $record['certificate_number']; ?></p>
        </div>
        <div class="space-x-3">
            <a href="death_certificates.php?id=<?php echo $record['id']; ?>" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                <i class="fas fa-certificate mr-2"></i> Print Certificate
            </a>
            <a href="view_death_records.php" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                <i class="fas fa-arrow-left mr-2"></i> Back to Records
            </a>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Deceased Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Deceased Information</h2>
        <div class="space-y-3">
            <div>
                <label class="text-sm font-medium text-gray-600">Name:</label>
                <p class="text-lg font-semibold text-red-600"><?php echo htmlspecialchars($record['deceased_name']); ?></p>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">Age at Death:</label>
                    <p class="font-medium text-lg"><?php echo $record['age_at_death']; ?> years</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">NIC Number:</label>
                    <p class="font-medium"><?php echo $record['deceased_nic'] ? htmlspecialchars($record['deceased_nic']) : 'Not available'; ?></p>
                </div>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Date & Time of Death:</label>
                <p class="font-medium"><?php echo date('d M Y', strtotime($record['date_of_death'])); ?> at <?php echo date('h:i A', strtotime($record['time_of_death'])); ?></p>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Place of Death:</label>
                <p class="font-medium"><?php echo htmlspecialchars($record['place_of_death']); ?></p>
            </div>
            
            <?php if ($record['patient_name']): ?>
            <div>
                <label class="text-sm font-medium text-gray-600">Patient Record:</label>
                <p class="font-medium text-blue-600"><?php echo htmlspecialchars($record['patient_name']); ?></p>
            </div>
            <?php endif; ?>
        </div>
    </div>

    <!-- Family Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Family Information</h2>
        <div class="space-y-4">
            <div>
                <h3 class="text-md font-medium text-gray-700 mb-2">Parents</h3>
                <div class="bg-gray-50 p-3 rounded space-y-2">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Father's Name:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['father_name']); ?></p>
                    </div>
                    <?php if ($record['mother_name']): ?>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Mother's Name:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['mother_name']); ?></p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            
            <?php if ($record['spouse_name']): ?>
            <div>
                <h3 class="text-md font-medium text-gray-700 mb-2">Spouse</h3>
                <div class="bg-blue-50 p-3 rounded">
                    <p class="font-medium"><?php echo htmlspecialchars($record['spouse_name']); ?></p>
                </div>
            </div>
            <?php endif; ?>
            
            <div>
                <h3 class="text-md font-medium text-gray-700 mb-2">Next of Kin</h3>
                <div class="bg-green-50 p-3 rounded space-y-2">
                    <div>
                        <label class="text-sm font-medium text-gray-600">Name:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['next_of_kin']); ?></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Relation:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['next_of_kin_relation']); ?></p>
                    </div>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Contact:</label>
                        <p class="font-medium"><?php echo htmlspecialchars($record['next_of_kin_contact']); ?></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical Information -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Medical Information</h2>
        <div class="space-y-4">
            <div>
                <label class="text-sm font-medium text-gray-600">Attending Doctor:</label>
                <p class="font-medium"><?php echo $record['doctor_name'] ? 'Dr. ' . htmlspecialchars($record['doctor_name']) : 'Not assigned'; ?></p>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Cause of Death:</label>
                <div class="bg-red-50 p-3 rounded mt-1">
                    <p class="text-sm"><?php echo nl2br(htmlspecialchars($record['cause_of_death'])); ?></p>
                </div>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Autopsy Information:</label>
                <div class="bg-yellow-50 p-3 rounded mt-1">
                    <div class="flex items-center mb-2">
                        <span class="text-sm font-medium">Autopsy Required:</span>
                        <span class="ml-2 px-2 py-1 rounded text-xs <?php echo $record['autopsy_required'] ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'; ?>">
                            <?php echo $record['autopsy_required'] ? 'Yes' : 'No'; ?>
                        </span>
                    </div>
                    <?php if ($record['autopsy_required'] && $record['autopsy_notes']): ?>
                    <div>
                        <label class="text-sm font-medium text-gray-600">Autopsy Notes:</label>
                        <p class="text-sm mt-1"><?php echo nl2br(htmlspecialchars($record['autopsy_notes'])); ?></p>
                    </div>
                    <?php endif; ?>
                </div>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-600">Certificate Information:</label>
                <div class="bg-gray-50 p-3 rounded mt-1">
                    <div class="text-sm space-y-1">
                        <div><strong>Certificate No:</strong> <?php echo $record['certificate_number']; ?></div>
                        <div><strong>Issued By:</strong> <?php echo htmlspecialchars($record['issued_by']); ?></div>
                        <div><strong>Issue Date:</strong> <?php echo date('d M Y, h:i A', strtotime($record['created_at'])); ?></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Information -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Address Information</h2>
    <div class="bg-gray-50 p-4 rounded">
        <p><?php echo nl2br(htmlspecialchars($record['address'])); ?></p>
    </div>
</div>

<!-- Actions -->
<div class="mt-6 bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Actions</h2>
    <div class="flex space-x-4">
        <a href="death_certificates.php?id=<?php echo $record['id']; ?>" class="bg-red-600 text-white py-2 px-6 rounded hover:bg-red-700 transition">
            <i class="fas fa-certificate mr-2"></i> Generate Death Certificate
        </a>
        <a href="view_death_records.php" class="bg-blue-600 text-white py-2 px-6 rounded hover:bg-blue-700 transition">
            <i class="fas fa-list mr-2"></i> Back to All Records
        </a>
        <a href="birth_death_records.php" class="bg-gray-600 text-white py-2 px-6 rounded hover:bg-gray-700 transition">
            <i class="fas fa-home mr-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: death_record_details.txt ===

=== START: generate_bill.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get patient ID from URL
$patient_id = isset($_GET['patient_id']) ? $_GET['patient_id'] : '';
$bill_group_id = isset($_GET['bill_group_id']) ? $_GET['bill_group_id'] : '';

// Validate inputs
if (empty($patient_id)) {
    header('Location: billing.php?error=missing_patient_id');
    exit;
}

// Get patient details
$patient = getPatient($patient_id);

// Get bill details
if ($bill_group_id) {
    $query = "SELECT * FROM billing WHERE bill_group_id = '$bill_group_id'";
    $result = $conn->query($query);
    
    $bill_items = [];
    $total_amount = 0;
    $total_discount = 0;
    $total_paid = 0;
    
    while ($row = $result->fetch_assoc()) {
        $bill_items[] = $row;
        $total_amount += $row['amount'];
        $total_discount += $row['discount'];
        $total_paid += $row['paid_amount'];
    }
} else {
    // Get all bills for this patient
    $bills = getPatientBills($patient_id);
    
    $bill_items = [];
    $total_amount = 0;
    $total_discount = 0;
    $total_paid = 0;
    
    while ($bill = $bills->fetch_assoc()) {
        $bill_items[] = $bill;
        $total_amount += $bill['amount'];
        $total_discount += $bill['discount'];
        $total_paid += $bill['paid_amount'];
    }
}

// Generate PDF content
$pdf_content = '
<!DOCTYPE html>
<html>
<head>
    <title>Bill - Hospital Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .header p {
            margin: 5px 0;
            font-size: 14px;
        }
        .info-box {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
        }
        .info-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .totals {
            text-align: right;
            margin-top: 20px;
        }
        .signature {
            margin-top: 50px;
            display: flex;
            justify-content: space-between;
        }
        .signature-box {
            width: 200px;
            text-align: center;
        }
        .signature-box .line {
            border-bottom: 1px solid #000;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>HOSPITAL MANAGEMENT SYSTEM</h1>
        <p>123 Medical Street, Lahore</p>
        <p>Phone: 0300-1234567</p>
    </div>
    
    <div class="info-box">
        <h3>Patient Information</h3>
        <div class="info-row">
            <span>Patient ID:</span>
            <span>' . $patient['id'] . '</span>
        </div>
        <div class="info-row">
            <span>Name:</span>
            <span>' . $patient['name'] . '</span>
        </div>
        <div class="info-row">
            <span>Age:</span>
            <span>' . $patient['age'] . '</span>
        </div>
        <div class="info-row">
            <span>Gender:</span>
            <span>' . $patient['gender'] . '</span>
        </div>
        <div class="info-row">
            <span>Contact:</span>
            <span>' . $patient['contact'] . '</span>
        </div>
        <div class="info-row">
            <span>Emergency Contact:</span>
            <span>' . ($patient['emergency_contact'] ?: 'N/A') . '</span>
        </div>
        <div class="info-row">
            <span>Relative Name:</span>
            <span>' . ($patient['relative_name'] ?: 'N/A') . '</span>
        </div>
        <div class="info-row">
            <span>NIC:</span>
            <span>' . ($patient['nic'] ?: 'N/A') . '</span>
        </div>
        <div class="info-row">
            <span>Address:</span>
            <span>' . ($patient['address'] ?: 'N/A') . '</span>
        </div>
    </div>
    
    <h3>Bill Details</h3>
    <table>
        <thead>
            <tr>
                <th>Service</th>
                <th>Amount</th>
                <th>Discount</th>
                <th>Paid</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>';

foreach ($bill_items as $item) {
    $pdf_content .= '
            <tr>
                <td>' . $item['service_name'] . '</td>
                <td>' . formatCurrency($item['amount']) . '</td>
                <td>' . formatCurrency($item['discount']) . '</td>
                <td>' . formatCurrency($item['paid_amount']) . '</td>
                <td>' . ucfirst($item['status']) . '</td>
            </tr>';
}

$pdf_content .= '
        </tbody>
    </table>
    
    <div class="totals">
        <div class="info-row">
            <span>Total Amount:</span>
            <span>' . formatCurrency($total_amount) . '</span>
        </div>
        <div class="info-row">
            <span>Total Discount:</span>
            <span>' . formatCurrency($total_discount) . '</span>
        </div>
        <div class="info-row">
            <span>Total Paid:</span>
            <span>' . formatCurrency($total_paid) . '</span>
        </div>
        <div class="info-row">
            <span>Balance:</span>
            <span>' . formatCurrency($total_amount - $total_discount - $total_paid) . '</span>
        </div>
    </div>
    
    <div class="signature">
        <div class="signature-box">
            <div class="line"></div>
            <p>Patient Signature</p>
        </div>
        <div class="signature-box">
            <div class="line"></div>
            <p>Hospital Signature</p>
        </div>
    </div>
</body>
</html>';

// Save PDF to file
$filename = 'bill_' . $patient_id . '_' . time() . '.pdf';
$file_path = '../../uploads/bills/' . $filename;

// In a real application, you would use a PDF library like TCPDF or mPDF
// For this example, we'll just save the HTML content
file_put_contents($file_path, $pdf_content);

// Redirect to billing page with success message
header('Location: billing.php?success=1&file=' . $filename);
exit;
?>
=== END: generate_bill.txt ===

=== START: get_patient_details.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');

if (isset($_GET['patient_id'])) {
    $patient_id = $_GET['patient_id'];
    
    $query = "SELECT * FROM patients WHERE id = ?";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("i", $patient_id);
    $stmt->execute();
    $result = $stmt->get_result();
    
    if ($patient = $result->fetch_assoc()) {
        echo json_encode($patient);
    } else {
        echo json_encode(['success' => false]);
    }
} else {
    echo json_encode(['success' => false]);
}
?>
=== END: get_patient_details.txt ===

=== START: patient_list.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');

// Process form submission to update patient
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_patient'])) {
    $patient_id = $_POST['patient_id'];
    $name = $_POST['name'];
    $age = $_POST['age'];
    $gender = $_POST['gender'];
    $contact = $_POST['contact'];
    $emergency_contact = $_POST['emergency_contact'];
    $relative_name = $_POST['relative_name'];
    $nic = $_POST['nic'];
    $address = $_POST['address'];
    
    // Update patient using prepared statement
    $query = "UPDATE patients SET name = ?, age = ?, gender = ?, contact = ?, 
              emergency_contact = ?, relative_name = ?, nic = ?, address = ? 
              WHERE id = ?";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("sissssssi", $name, $age, $gender, $contact, $emergency_contact, 
                      $relative_name, $nic, $address, $patient_id);
    
    if ($stmt->execute()) {
        $success = "Patient updated successfully";
    } else {
        $error = "Error updating patient: " . $stmt->error;
    }
}

// Get all patients
$patients = getAllPatients();
?>
<?php include '../../includes/header.php'; ?>

<!-- Success/Error Messages -->
<?php if (isset($success)): ?>
    <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <?php echo $success; ?>
        </div>
    </div>
<?php endif; ?>

<?php if (isset($error)): ?>
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <?php echo $error; ?>
        </div>
    </div>
<?php endif; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Patient List</h1>
    <p class="text-gray-600">View all registered patients</p>
</div>

<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <div class="relative">
            <input type="text" id="search" placeholder="Search patients..." class="pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
        </div>
        <a href="add_patient.php" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
            <i class="fas fa-plus mr-2"></i>Add New Patient
        </a>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registered</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="patient-table-body">
                <?php if ($patients->num_rows > 0): ?>
                    <?php while ($patient = $patients->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $patient['id']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap font-medium"><?php echo $patient['name']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $patient['age']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $patient['gender']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo $patient['contact']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo date('d M Y', strtotime($patient['created_at'])); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <a href="../doctor/view_patient.php?id=<?php echo $patient['id']; ?>" class="text-blue-600 hover:text-blue-900 mr-3">View</a>
                                <button onclick="openEditModal(<?php echo $patient['id']; ?>)" class="text-yellow-600 hover:text-yellow-900 mr-3">Edit</button>
                                <a href="token.php?patient_id=<?php echo $patient['id']; ?>" class="text-green-600 hover:text-green-900 mr-3">Token</a>
                                <a href="billing.php?patient_id=<?php echo $patient['id']; ?>" class="text-purple-600 hover:text-purple-900">Bill</a>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">No patients found</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Patient Modal -->
<div id="editPatientModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-user-edit mr-2 text-yellow-600"></i>
                    Edit Patient
                </h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editPatientForm" method="POST" class="space-y-4">
                <input type="hidden" name="update_patient" value="1">
                <input type="hidden" name="patient_id" id="edit_patient_id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                        <input type="text" name="name" id="edit_name" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Age *</label>
                        <input type="number" name="age" id="edit_age" required min="0" max="150"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender *</label>
                        <select name="gender" id="edit_gender" required 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number *</label>
                        <input type="tel" name="contact" id="edit_contact" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact</label>
                        <input type="tel" name="emergency_contact" id="edit_emergency_contact" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Husband/Father/Guardian Name</label>
                        <input type="text" name="relative_name" id="edit_relative_name" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NIC Number</label>
                        <input type="text" name="nic" id="edit_nic" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                    <textarea name="address" id="edit_address" rows="3" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeEditModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Update Patient
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Search functionality
    document.getElementById('search').addEventListener('keyup', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll('#patient-table-body tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });

    function openEditModal(patientId) {
        // Fetch patient data via AJAX
        fetch('get_patient_details.php?patient_id=' + patientId)
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    // Populate form fields
                    document.getElementById('edit_patient_id').value = patientId;
                    document.getElementById('edit_name').value = data.name || '';
                    document.getElementById('edit_age').value = data.age || '';
                    document.getElementById('edit_gender').value = data.gender || '';
                    document.getElementById('edit_contact').value = data.contact || '';
                    document.getElementById('edit_emergency_contact').value = data.emergency_contact || '';
                    document.getElementById('edit_relative_name').value = data.relative_name || '';
                    document.getElementById('edit_nic').value = data.nic || '';
                    document.getElementById('edit_address').value = data.address || '';
                    
                    // Show modal
                    document.getElementById('editPatientModal').classList.remove('hidden');
                } else {
                    alert('Error loading patient data');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading patient data');
            });
    }
    
    function closeEditModal() {
        document.getElementById('editPatientModal').classList.add('hidden');
        document.getElementById('editPatientForm').reset();
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('editPatientModal');
        if (event.target === modal) {
            closeEditModal();
        }
    }
</script>

<?php include '../../includes/footer.php'; ?>
=== END: patient_list.txt ===

=== START: process_refund.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Process refund
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $bill_group_id = $_POST['bill_group_id'];
    
    // Update all billing records with this bill_group_id to refund status
    $update_query = "UPDATE billing SET status = 'refund' WHERE bill_group_id = '$bill_group_id'";
    
    if ($conn->query($update_query) === TRUE) {
        // Redirect back to bill records with success message
        header('Location: bill_records.php?success=refund');
        exit;
    } else {
        // Redirect back with error message
        header('Location: bill_records.php?error=refund');
        exit;
    }
} else {
    // Redirect back if not POST request
    header('Location: bill_records.php');
    exit;
}
?>
=== END: process_refund.txt ===

=== START: room_allotment.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');

// First, let's create the room_assignments table if it doesn't exist
$create_table_query = "CREATE TABLE IF NOT EXISTS room_assignments (
    id INT(11) NOT NULL AUTO_INCREMENT,
    room_id INT(11) NOT NULL,
    patient_id INT(11) NOT NULL,
    days INT(11) NOT NULL,
    assigned_date DATE NOT NULL,
    billing_id INT(11) DEFAULT NULL,
    PRIMARY KEY (id),
    FOREIGN KEY (room_id) REFERENCES rooms(id),
    FOREIGN KEY (patient_id) REFERENCES patients(id),
    FOREIGN KEY (billing_id) REFERENCES billing(id)
)";
$conn->query($create_table_query);

// Process form submission for room allotment
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['allot_room'])) {
    $patient_id = $_POST['patient_id'];
    $room_id = $_POST['room_id'];
    $days = $_POST['days'];
    
    // Check if patient already has a room assigned
    $check_assignment_query = "SELECT ra.*, r.room_name, p.name as patient_name 
                             FROM room_assignments ra 
                             JOIN rooms r ON ra.room_id = r.id 
                             JOIN patients p ON ra.patient_id = p.id 
                             WHERE ra.patient_id = $patient_id";
    $check_result = $conn->query($check_assignment_query);
    
    if ($check_result->num_rows > 0) {
        $existing_assignment = $check_result->fetch_assoc();
        $error = "Patient already assigned to " . $existing_assignment['room_name'] . ". Unassign first to assign a new room.";
    } else {
        // Get room details
        $room = getRoom($room_id);
        $room_name = $room['room_name'];
        $price_per_day = $room['price'];
        $total_amount = $price_per_day * $days;
        
        // Update room status to occupied
        $update_query = "UPDATE rooms SET status = 'occupied' WHERE id = $room_id";
        $conn->query($update_query);
        
        // Create billing record
        $billing_query = "INSERT INTO billing (patient_id, service_name, amount, paid_amount, status) 
                          VALUES ($patient_id, '$room_name ($days days)', $total_amount, 0, 'unpaid')";
        
        if ($conn->query($billing_query) === TRUE) {
            $billing_id = $conn->insert_id;
            
            // Create room assignment record
            $assignment_query = "INSERT INTO room_assignments (room_id, patient_id, days, assigned_date, billing_id) 
                                VALUES ($room_id, $patient_id, $days, CURDATE(), $billing_id)";
            
            if ($conn->query($assignment_query) === TRUE) {
                $success = "Room allotted successfully";
            } else {
                $error = "Error creating room assignment: " . $conn->error;
            }
        } else {
            $error = "Error: " . $conn->error;
        }
    }
}

// Process form submission for unassigning room
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['unassign_room'])) {
    $assignment_id = $_POST['assignment_id'];
    $room_id = $_POST['room_id'];
    $billing_id = $_POST['billing_id'];
    
    // Update room status to available
    $update_room_query = "UPDATE rooms SET status = 'available' WHERE id = $room_id";
    $conn->query($update_room_query);
    
    // Update billing record to refunded
    $update_billing_query = "UPDATE billing SET status = 'refund' WHERE id = $billing_id";
    $conn->query($update_billing_query);
    
    // Delete room assignment
    $delete_assignment_query = "DELETE FROM room_assignments WHERE id = $assignment_id";
    
    if ($conn->query($delete_assignment_query) === TRUE) {
        $success = "Room unassigned successfully";
    } else {
        $error = "Error unassigning room: " . $conn->error;
    }
}

// Get all patients for dropdown
$patients = getAllPatients();
// Get available rooms
$available_rooms = getAvailableRooms();
// Get occupied rooms with assignment details
$occupied_rooms_query = "SELECT ra.id as assignment_id, ra.days, ra.assigned_date, ra.billing_id,
                          r.id as room_id, r.room_name, r.price,
                          p.id as patient_id, p.name as patient_name
                          FROM room_assignments ra 
                          JOIN rooms r ON ra.room_id = r.id 
                          JOIN patients p ON ra.patient_id = p.id 
                          ORDER BY ra.assigned_date DESC";
$occupied_rooms_result = $conn->query($occupied_rooms_query);
?>
<?php include '../../includes/header.php'; ?>
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Room Allotment</h1>
    <p class="text-gray-600">Allot rooms to patients</p>
</div>

<?php if (isset($success)): ?>
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
    <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <?php echo $success; ?>
    </div>
</div>
<?php endif; ?>

<?php if (isset($error)): ?>
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
    <div class="flex items-center">
        <i class="fas fa-exclamation-circle mr-2"></i>
        <?php echo $error; ?>
    </div>
</div>
<?php endif; ?>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Allot Room</h2>
        <form method="post" action="room_allotment.php">
            <input type="hidden" name="allot_room" value="1">
            
            <div class="mb-4">
                <label for="patient_id" class="block text-gray-700 font-medium mb-2">Select Patient</label>
                <select id="patient_id" name="patient_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select a patient</option>
                    <?php 
                    $patients->data_seek(0);
                    while ($patient = $patients->fetch_assoc()): ?>
                        <option value="<?php echo $patient['id']; ?>">
                            <?php echo $patient['name'] . ' (ID: ' . $patient['id'] . ')'; ?>
                        </option>
                    <?php endwhile; ?>
                </select>
            </div>
            
            <div class="mb-4">
                <label for="room_id" class="block text-gray-700 font-medium mb-2">Select Room</label>
                <select id="room_id" name="room_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    <option value="">Select a room</option>
                    <?php 
                    $available_rooms->data_seek(0);
                    while ($room = $available_rooms->fetch_assoc()): ?>
                        <option value="<?php echo $room['id']; ?>">
                            <?php echo $room['room_name'] . ' - ' . formatCurrency($room['price']) . '/day'; ?>
                        </option>
                    <?php endwhile; ?>
                </select>
            </div>
            
            <div class="mb-6">
                <label for="days" class="block text-gray-700 font-medium mb-2">Number of Days</label>
                <input type="number" id="days" name="days" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            
            <div class="flex justify-end">
                <button type="submit" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                    <i class="fas fa-bed mr-2"></i>Allot Room
                </button>
            </div>
        </form>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Room Status</h2>
        
        <div class="mb-6">
            <h3 class="font-medium text-gray-700 mb-2">Available Rooms</h3>
            <div class="space-y-2">
                <?php 
                $available_rooms->data_seek(0);
                if ($available_rooms->num_rows > 0) {
                    while ($room = $available_rooms->fetch_assoc()): ?>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-md">
                            <div>
                                <div class="font-medium"><?php echo $room['room_name']; ?></div>
                                <div class="text-sm text-gray-600"><?php echo formatCurrency($room['price']); ?>/day</div>
                            </div>
                            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Available</span>
                        </div>
                    <?php endwhile;
                } else {
                    echo "<p class='text-gray-500'>No available rooms</p>";
                }
                ?>
            </div>
        </div>
        
        <div>
            <h3 class="font-medium text-gray-700 mb-2">Occupied Rooms</h3>
            <div class="space-y-2">
                <?php 
                if ($occupied_rooms_result->num_rows > 0) {
                    while ($room = $occupied_rooms_result->fetch_assoc()): ?>
                        <div class="p-3 bg-red-50 rounded-md">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="font-medium"><?php echo $room['room_name']; ?></div>
                                    <div class="text-sm text-gray-600"><?php echo formatCurrency($room['price']); ?>/day</div>
                                </div>
                                <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">Occupied</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div>
                                    <span class="text-gray-600">Patient:</span>
                                    <span class="font-medium"><?php echo $room['patient_name']; ?> (ID: <?php echo $room['patient_id']; ?>)</span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Days:</span>
                                    <span class="font-medium"><?php echo $room['days']; ?></span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Assigned:</span>
                                    <span class="font-medium"><?php echo date('d M Y', strtotime($room['assigned_date'])); ?></span>
                                </div>
                                <div>
                                    <span class="text-gray-600">Status:</span>
                                    <span class="font-medium">Active</span>
                                </div>
                            </div>
                            
                            <form method="post" action="room_allotment.php" onsubmit="return confirm('Are you sure you want to unassign this room? This will also mark the billing as refunded.');">
                                <input type="hidden" name="unassign_room" value="1">
                                <input type="hidden" name="assignment_id" value="<?php echo $room['assignment_id']; ?>">
                                <input type="hidden" name="room_id" value="<?php echo $room['room_id']; ?>">
                                <input type="hidden" name="billing_id" value="<?php echo $room['billing_id']; ?>">
                                <button type="submit" class="w-full bg-yellow-600 text-white py-1 px-3 rounded-md hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition text-sm">
                                    <i class="fas fa-door-open mr-1"></i> Unassign Room
                                </button>
                            </form>
                        </div>
                    <?php endwhile;
                } else {
                    echo "<p class='text-gray-500'>No occupied rooms</p>";
                }
                ?>
            </div>
        </div>
    </div>
</div>

<script>
// Add JavaScript to prevent form submission if patient already has a room
document.querySelector('form').addEventListener('submit', function(e) {
    const patientId = document.getElementById('patient_id').value;
    
    if (patientId) {
        // Check if patient already has a room assigned via AJAX
        fetch(`check_patient_room.php?patient_id=${patientId}`)
            .then(response => response.json())
            .then(data => {
                if (data.hasRoom) {
                    e.preventDefault();
                    alert(`Patient already assigned to ${data.roomName}. Unassign first to assign a new room.`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
});
</script>

<?php include '../../includes/footer.php'; ?>
=== END: room_allotment.txt ===

=== START: token.txt ===
<?php
require_once '../../includes/functions.php';
requireRole('reception');
// Enable error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);
// Get current user information
try {
    $current_user = getUser($_SESSION['user_id']);
    $current_username = $current_user['username'];
} catch (Exception $e) {
    $current_username = 'Unknown';
}
// Get filter parameters
$token_type_filter = isset($_GET['token_type_filter']) ? $_GET['token_type_filter'] : 'all';
$pending_from_date = isset($_GET['pending_from_date']) ? $_GET['pending_from_date'] : date('Y-m-d', strtotime('-7 days'));
$pending_to_date = isset($_GET['pending_to_date']) ? $_GET['pending_to_date'] : date('Y-m-d');
// Process form submission to generate token
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['generate_token'])) {
    // Check if required fields are set
    if (!isset($_POST['patient_id']) || empty($_POST['patient_id'])) {
        $error = "Please select a patient";
    } elseif (!isset($_POST['token_type']) || empty($_POST['token_type'])) {
        $error = "Please select a token type";
    } else {
        $patient_id = $_POST['patient_id'];
        $token_type = $_POST['token_type'];
        $doctor_id = isset($_POST['doctor_id']) ? $_POST['doctor_id'] : null;
        $test_id = isset($_POST['test_id']) ? $_POST['test_id'] : null;
        
        // Validate lab token has test selected
        if ($token_type === 'lab' && !$test_id) {
            $error = "Please select a test for lab token";
        } else {
            // For doctor tokens, check if patient already has a waiting doctor token
            if ($token_type === 'doctor') {
                $check_doctor_token_query = "SELECT id FROM tokens 
                                           WHERE patient_id = $patient_id 
                                           AND type = 'doctor' 
                                           AND status = 'waiting'";
                $check_result = $conn->query($check_doctor_token_query);
                
                if ($check_result->num_rows > 0) {
                    $error = "Patient already has a waiting doctor token. Please complete or cancel the existing token first.";
                }
            }
            
            // Only proceed if no error
            if (!isset($error)) {
                // Create billing record first and mark as paid immediately
                if ($token_type === 'doctor' && $doctor_id) {
                    $doctor = getStaff($doctor_id);
                    $service_name = "Doctor Consultation - Dr. " . $doctor['name'];
                    $amount = 1000; // Default fee
                } elseif ($token_type === 'lab' && $test_id) {
                    $test = getTest($test_id);
                    $service_name = "Lab Test - " . $test['test_name'];
                    $amount = $test['price'];
                } else {
                    $service_name = ($token_type === 'doctor') ? 'Doctor Consultation' : 'Lab Test';
                    $amount = ($token_type === 'doctor') ? 1000 : 500; // Default fees
                }
                
                // Insert billing record as PAID
                $billing_query = "INSERT INTO billing (patient_id, service_name, amount, paid_amount, status) 
                                  VALUES ($patient_id, '$service_name', $amount, $amount, 'paid')";
                
                if ($conn->query($billing_query) === TRUE) {
                    $bill_id = $conn->insert_id;
                    
                    // Generate token number
                    $token_no = generateToken($token_type);
                    
                    // Insert token into database
                    $query = "INSERT INTO tokens (patient_id, type, token_no, status, doctor_id, test_id) 
                              VALUES ($patient_id, '$token_type', '$token_no', 'waiting', " . ($doctor_id ? "'$doctor_id'" : "NULL") . ", " . ($test_id ? "'$test_id'" : "NULL") . ")";
                    
                    if ($conn->query($query) === TRUE) {
                        $token_id = $conn->insert_id;
                        
                        // Update billing record with token_id
                        $update_billing_query = "UPDATE billing SET token_id = $token_id WHERE id = $bill_id";
                        $conn->query($update_billing_query);
                        
                        $success = "Token generated successfully: $token_no (Bill ID: $bill_id)";
                        
                        // Get patient details
                        $patient = getPatient($patient_id);
                        
                        // Store token details for printing
                        $print_token_data = [
                            'token_no' => $token_no,
                            'patient_id' => $patient_id,
                            'patient_name' => $patient['name'],
                            'token_type' => $token_type,
                            'assigned_to' => ($token_type === 'doctor' && $doctor_id) ? $doctor['name'] : (($token_type === 'lab' && $test_id) ? getTest($test_id)['test_name'] : 'N/A'),
                            'bill_id' => $bill_id,
                            'generated_by' => $current_username,
                            'amount' => $amount
                        ];
                    } else {
                        $error = "Error creating token: " . $conn->error;
                    }
                } else {
                    $error = "Error creating billing record: " . $conn->error;
                }
            }
        }
    }
}
// Process form submission to update token
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['update_token'])) {
    $token_id = $_POST['token_id'];
    $doctor_id = isset($_POST['edit_doctor_id']) ? $_POST['edit_doctor_id'] : null;
    $test_id = isset($_POST['edit_test_id']) ? $_POST['edit_test_id'] : null;
    
    // Update token
    $update_query = "UPDATE tokens SET doctor_id = " . ($doctor_id ? "'$doctor_id'" : "NULL") . ", 
                     test_id = " . ($test_id ? "'$test_id'" : "NULL") . " 
                     WHERE id = $token_id";
    
    if ($conn->query($update_query) === TRUE) {
        // Update billing record
        $billing_query = "UPDATE billing SET service_name = " . 
                          ($doctor_id ? "'Doctor Consultation - Dr. " . getStaff($doctor_id)['name'] . "'" : 
                          ($test_id ? "'Lab Test - " . getTest($test_id)['test_name'] . "'" : "'Service'")) . 
                          " WHERE token_id = $token_id";
        
        if ($conn->query($billing_query) === TRUE) {
            $success = "Token updated successfully";
        } else {
            $error = "Error updating billing record: " . $conn->error;
        }
    } else {
        $error = "Error updating token: " . $conn->error;
    }
}
// Process form submission to refund token
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['refund_token'])) {
    $token_id = $_POST['token_id'];
    
    // Update token status to cancelled
    $update_token_query = "UPDATE tokens SET status = 'cancelled' WHERE id = $token_id";
    $conn->query($update_token_query);
    
    // Update corresponding billing record to refund
    $update_billing_query = "UPDATE billing SET status = 'refund' WHERE token_id = $token_id";
    if ($conn->query($update_billing_query) === TRUE) {
        $success = "Token cancelled successfully";
    } else {
        $error = "Error cancelling token: " . $conn->error;
    }
}
// Get all patients for dropdown
$patients = getAllPatients();
// Get all doctors for dropdown (from users with role 'doctor')
$doctor_query = "SELECT u.id as user_id, s.id as staff_id, s.name FROM users u JOIN staff s ON u.staff_id = s.id WHERE u.role = 'doctor'";
$doctors = $conn->query($doctor_query);
// Get all tests for dropdown
$tests = getAllTests();
// Get today's tokens with filter
$today = date('Y-m-d');
$token_filter_clause = "";
if ($token_type_filter !== 'all') {
    $token_filter_clause = " AND t.type = '$token_type_filter'";
}
$today_tokens_query = "SELECT t.*, p.name as patient_name, 
                      CASE WHEN t.doctor_id IS NOT NULL THEN s.name ELSE NULL END as doctor_name,
                      CASE WHEN t.test_id IS NOT NULL THEN ts.test_name ELSE NULL END as test_name,
                      b.id as bill_id, b.status as bill_status
                      FROM tokens t 
                      JOIN patients p ON t.patient_id = p.id 
                      LEFT JOIN staff s ON t.doctor_id = s.id 
                      LEFT JOIN tests ts ON t.test_id = ts.id 
                      LEFT JOIN billing b ON t.id = b.token_id
                      WHERE DATE(t.created_at) = '$today' AND t.status != 'cancelled' $token_filter_clause
                      ORDER BY t.created_at DESC";
$today_tokens = $conn->query($today_tokens_query);
// Get refunded tokens with filter
$refunded_tokens_query = "SELECT t.*, p.name as patient_name, 
                         CASE WHEN t.doctor_id IS NOT NULL THEN s.name ELSE NULL END as doctor_name,
                         CASE WHEN t.test_id IS NOT NULL THEN ts.test_name ELSE NULL END as test_name
                         FROM tokens t 
                         JOIN patients p ON t.patient_id = p.id 
                         LEFT JOIN staff s ON t.doctor_id = s.id 
                         LEFT JOIN tests ts ON t.test_id = ts.id 
                         WHERE DATE(t.created_at) = '$today' AND t.status = 'cancelled' $token_filter_clause
                         ORDER BY t.created_at DESC";
$refunded_tokens = $conn->query($refunded_tokens_query);
// Get token statistics
$stats_query = "SELECT 
                    COUNT(*) as total_tokens,
                    COUNT(CASE WHEN status = 'waiting' THEN 1 END) as waiting_tokens,
                    COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed_tokens,
                    COUNT(CASE WHEN status = 'cancelled' THEN 1 END) as cancelled_tokens,
                    COUNT(CASE WHEN type = 'doctor' THEN 1 END) as doctor_tokens,
                    COUNT(CASE WHEN type = 'lab' THEN 1 END) as lab_tokens
                FROM tokens t
                WHERE DATE(t.created_at) = '$today' $token_filter_clause";
$stats_result = $conn->query($stats_query);
$token_stats = $stats_result->fetch_assoc();
// Get pending tokens with date filter
$pending_date_filter = " AND DATE(t.created_at) BETWEEN '$pending_from_date' AND '$pending_to_date'";
$pending_tokens_query = "SELECT t.*, p.name as patient_name, 
                        CASE WHEN t.doctor_id IS NOT NULL THEN s.name ELSE NULL END as doctor_name,
                        CASE WHEN t.test_id IS NOT NULL THEN ts.test_name ELSE NULL END as test_name,
                        b.id as bill_id
                        FROM tokens t 
                        JOIN patients p ON t.patient_id = p.id 
                        LEFT JOIN staff s ON t.doctor_id = s.id 
                        LEFT JOIN tests ts ON t.test_id = ts.id 
                        LEFT JOIN billing b ON t.id = b.token_id
                        WHERE t.status = 'waiting' $pending_date_filter
                        ORDER BY t.created_at DESC";
$pending_tokens = $conn->query($pending_tokens_query);
// Get pending token statistics
$pending_stats_query = "SELECT 
                            COUNT(*) as total_pending,
                            COUNT(CASE WHEN type = 'doctor' THEN 1 END) as pending_doctor,
                            COUNT(CASE WHEN type = 'lab' THEN 1 END) as pending_lab
                        FROM tokens t
                        WHERE t.status = 'waiting' $pending_date_filter";
$pending_stats_result = $conn->query($pending_stats_query);
$pending_stats = $pending_stats_result->fetch_assoc();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Token - Hospital Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .thermal-print {
            background: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            max-width: 300px;
            margin: 0 auto;
            font-family: 'Courier New', monospace;
            color: black;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            .thermal-print, .thermal-print * {
                visibility: visible;
            }
            .thermal-print {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <?php include '../../includes/header.php'; ?>
    
    <div class="container mx-auto px-4 py-8">
        <div class="mb-6">
            <h1 class="text-2xl font-bold text-gray-800">Token Generation & Management</h1>
            <p class="text-gray-600">Generate tokens for doctor consultations and lab tests</p>
        </div>
        
        <?php if (isset($success)): ?>
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        <?php echo $success; ?>
                    </div>
                    <?php if (isset($print_token_data)): ?>
                        <button onclick="showPrintPreview('<?php echo htmlspecialchars(json_encode($print_token_data)); ?>')" 
                                class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                            <i class="fas fa-print mr-2"></i>Print Token
                        </button>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif; ?>
        
        <?php if (isset($error)): ?>
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <?php echo $error; ?>
                </div>
            </div>
        <?php endif; ?>
        
        <!-- Generate Token Form -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-indigo-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i>
                    Generate New Token
                </h2>
            </div>
            <div class="p-6">
                <form method="post" id="tokenForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="patient_id" class="block text-gray-700 font-medium mb-2">Select Patient <span class="text-red-500">*</span></label>
                            <select name="patient_id" id="patient_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">Select Patient</option>
                                <?php 
                                if ($patients) {
                                    $patients->data_seek(0);
                                    while ($patient = $patients->fetch_assoc()): ?>
                                        <option value="<?php echo $patient['id']; ?>">
                                            <?php echo $patient['name']; ?> (ID: <?php echo $patient['id']; ?>) - <?php echo $patient['contact']; ?>
                                        </option>
                                    <?php endwhile;
                                }
                                ?>
                            </select>
                        </div>
                        
                        <div>
                            <label for="token_type" class="block text-gray-700 font-medium mb-2">Token Type <span class="text-red-500">*</span></label>
                            <select name="token_type" id="token_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">Select Token Type</option>
                                <option value="doctor">Doctor Consultation</option>
                                <option value="lab">Lab Test</option>
                            </select>
                        </div>
                        
                        <div id="doctor-dropdown" style="display: none;">
                            <label for="doctor_id" class="block text-gray-700 font-medium mb-2">Select Doctor</label>
                            <select name="doctor_id" id="doctor_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Doctor (Optional)</option>
                                <?php 
                                if ($doctors) {
                                    $doctors->data_seek(0);
                                    while ($doctor = $doctors->fetch_assoc()): ?>
                                        <option value="<?php echo $doctor['staff_id']; ?>">Dr. <?php echo $doctor['name']; ?></option>
                                    <?php endwhile;
                                }
                                ?>
                            </select>
                            <div class="mt-1 text-xs text-gray-500">Optional - Leave blank for general consultation</div>
                        </div>
                        
                        <div id="test-dropdown" style="display: none;">
                            <label for="test_id" class="block text-gray-700 font-medium mb-2">Select Test <span class="text-red-500">*</span></label>
                            <select name="test_id" id="test_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select Test</option>
                                <?php 
                                if ($tests) {
                                    $tests->data_seek(0);
                                    while ($test = $tests->fetch_assoc()): ?>
                                        <option value="<?php echo $test['id']; ?>">
                                            <?php echo $test['test_name']; ?> - <?php echo formatCurrency($test['price']); ?>
                                        </option>
                                    <?php endwhile;
                                }
                                ?>
                            </select>
                            <div class="mt-1 text-xs text-gray-500">Required for lab tokens</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex items-center justify-between">
                        <div class="text-sm text-gray-600">
                            <span class="text-red-500">*</span> Required fields
                        </div>
                        <button type="submit" name="generate_token" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-plus mr-2"></i>Generate Token
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Token Statistics -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-blue-100 text-blue-500">
                        <i class="fas fa-ticket-alt text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Total Today</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['total_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-yellow-100 text-yellow-500">
                        <i class="fas fa-clock text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Waiting</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['waiting_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-green-100 text-green-500">
                        <i class="fas fa-check-circle text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Completed</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['completed_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-red-100 text-red-500">
                        <i class="fas fa-times-circle text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Cancelled</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['cancelled_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-purple-100 text-purple-500">
                        <i class="fas fa-user-md text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Doctor</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['doctor_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-4">
                <div class="flex items-center">
                    <div class="p-2 rounded-full bg-indigo-100 text-indigo-500">
                        <i class="fas fa-flask text-lg"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-semibold text-gray-700">Lab</h3>
                        <p class="text-xl font-bold"><?php echo $token_stats['lab_tokens'] ?: 0; ?></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Today's Tokens Card -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-blue-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center justify-between">
                    <span><i class="fas fa-ticket-alt mr-2"></i>Today's Active Tokens</span>
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To / Test</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bill ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <?php if ($today_tokens && $today_tokens->num_rows > 0): ?>
                            <?php while ($token = $today_tokens->fetch_assoc()): ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                        <div class="text-sm text-gray-500">ID: <?php echo $token['patient_id']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                            <i class="fas fa-<?php echo $token['type'] === 'doctor' ? 'user-md' : 'flask'; ?> mr-1"></i>
                                            <?php echo ucfirst($token['type']); ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <?php 
                                            if ($token['type'] === 'doctor' && $token['doctor_name']) {
                                                echo "Dr. " . $token['doctor_name'];
                                            } elseif ($token['type'] === 'lab' && $token['test_name']) {
                                                echo $token['test_name'];
                                            } else {
                                                echo "<span class='text-gray-500'>Not assigned</span>";
                                            }
                                            ?>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <?php if ($token['bill_id']): ?>
                                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                #<?php echo $token['bill_id']; ?>
                                            </span>
                                        <?php else: ?>
                                            <span class="text-gray-500">-</span>
                                        <?php endif; ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php 
                                            if ($token['status'] === 'waiting') echo 'bg-yellow-100 text-yellow-800';
                                            elseif ($token['status'] === 'completed') echo 'bg-green-100 text-green-800';
                                            else echo 'bg-red-100 text-red-800';
                                        ?>">
                                            <i class="fas fa-<?php 
                                                if ($token['status'] === 'waiting') echo 'clock';
                                                elseif ($token['status'] === 'completed') echo 'check-circle';
                                                else echo 'times-circle';
                                            ?> mr-1"></i>
                                            <?php echo ucfirst($token['status']); ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('h:i A', strtotime($token['created_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="showPrintPreview('<?php echo htmlspecialchars(json_encode([
                                            'token_no' => $token['token_no'],
                                            'patient_id' => $token['patient_id'],
                                            'patient_name' => $token['patient_name'],
                                            'token_type' => $token['type'],
                                            'assigned_to' => ($token['type'] === 'doctor' && $token['doctor_name']) ? "Dr. " . $token['doctor_name'] : (($token['type'] === 'lab' && $token['test_name']) ? $token['test_name'] : 'N/A'),
                                            'bill_id' => $token['bill_id'] ?? null,
                                            'generated_by' => $current_username,
                                            'amount' => $token['type'] === 'doctor' ? 1000 : 500
                                        ])); ?>')" 
                                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mr-2 text-xs">
                                            <i class="fas fa-print"></i>
                                        </button>
                                        <button onclick="editToken(<?php echo $token['id']; ?>, '<?php echo $token['type']; ?>', <?php echo $token['doctor_id'] ?: 'null'; ?>, <?php echo $token['test_id'] ?: 'null'; ?>)" 
                                                class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 mr-2 text-xs">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="confirmRefund(<?php echo $token['id']; ?>)" 
                                                class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-xs">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        <?php else: ?>
                            <tr>
                                <td colspan="8" class="px-6 py-12 text-center">
                                    <i class="fas fa-ticket-alt text-gray-400 text-4xl mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-1">No active tokens</h3>
                                    <p class="text-gray-500">No tokens have been generated today.</p>
                                </td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Pending Tokens Section -->
        <div class="bg-white rounded-lg shadow-md mb-8 overflow-hidden">
            <div class="bg-orange-600 text-white px-6 py-4">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <h2 class="text-xl font-semibold flex items-center mb-2 md:mb-0">
                        <i class="fas fa-hourglass-half mr-2"></i>
                        All Pending Tokens
                    </h2>
                    <div class="flex items-center space-x-4">
                        <div class="text-sm">
                            Total: <span class="font-bold"><?php echo $pending_stats['total_pending'] ?: 0; ?></span>
                            (Dr: <span class="font-bold"><?php echo $pending_stats['pending_doctor'] ?: 0; ?></span>
                            | Lab: <span class="font-bold"><?php echo $pending_stats['pending_lab'] ?: 0; ?></span>)
                        </div>
                        <form method="get" class="flex items-center space-x-2">
                            <input type="hidden" name="token_type_filter" value="<?php echo $token_type_filter; ?>">
                            <input type="date" name="pending_from_date" value="<?php echo $pending_from_date; ?>" 
                                   class="px-2 py-1 border border-gray-300 rounded text-sm">
                            <span class="text-white">to</span>
                            <input type="date" name="pending_to_date" value="<?php echo $pending_to_date; ?>" 
                                   class="px-2 py-1 border border-gray-300 rounded text-sm">
                            <button type="submit" class="bg-orange-700 text-white px-3 py-1 rounded text-sm hover:bg-orange-800">
                                <i class="fas fa-filter mr-1"></i>Filter
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To / Test</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generated</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waiting Since</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <?php if ($pending_tokens && $pending_tokens->num_rows > 0): ?>
                            <?php while ($token = $pending_tokens->fetch_assoc()): 
                                $created_time = strtotime($token['created_at']);
                                $current_time = time();
                                $waiting_hours = floor(($current_time - $created_time) / 3600);
                                $waiting_days = floor($waiting_hours / 24);
                                ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                        <div class="text-sm text-gray-500">ID: <?php echo $token['patient_id']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php echo $token['type'] === 'doctor' ? 'bg-purple-100 text-purple-800' : 'bg-indigo-100 text-indigo-800'; ?>">
                                            <i class="fas fa-<?php echo $token['type'] === 'doctor' ? 'user-md' : 'flask'; ?> mr-1"></i>
                                            <?php echo ucfirst($token['type']); ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <?php 
                                            if ($token['type'] === 'doctor' && $token['doctor_name']) {
                                                echo "Dr. " . $token['doctor_name'];
                                            } elseif ($token['type'] === 'lab' && $token['test_name']) {
                                                echo $token['test_name'];
                                            } else {
                                                echo "<span class='text-gray-500'>Not assigned</span>";
                                            }
                                            ?>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('d M Y, h:i A', strtotime($token['created_at'])); ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <?php 
                                            if ($waiting_days > 0) echo 'bg-red-100 text-red-800';
                                            elseif ($waiting_hours > 2) echo 'bg-yellow-100 text-yellow-800';
                                            else echo 'bg-green-100 text-green-800';
                                        ?>">
                                            <?php 
                                            if ($waiting_days > 0) {
                                                echo $waiting_days . ' day' . ($waiting_days > 1 ? 's' : '');
                                            } elseif ($waiting_hours > 0) {
                                                echo $waiting_hours . ' hour' . ($waiting_hours > 1 ? 's' : '');
                                            } else {
                                                echo '< 1 hour';
                                            }
                                            ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <?php 
                                        // Create a safe data array for JSON encoding
                                        $token_data = [
                                            'token_no' => $token['token_no'],
                                            'patient_id' => $token['patient_id'],
                                            'patient_name' => $token['patient_name'],
                                            'token_type' => $token['type'],
                                            'assigned_to' => ($token['type'] === 'doctor' && $token['doctor_name']) ? "Dr. " . $token['doctor_name'] : (($token['type'] === 'lab' && $token['test_name']) ? $token['test_name'] : 'N/A'),
                                            'bill_id' => $token['bill_id'] ?? null,
                                            'generated_by' => $current_username,
                                            'amount' => $token['type'] === 'doctor' ? 1000 : 500
                                        ];
                                        ?>
                                        <button onclick="showPrintPreview('<?php echo htmlspecialchars(json_encode($token_data)); ?>')" 
                                                class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 mr-2 text-xs">
                                            <i class="fas fa-print"></i>
                                        </button>
                                        <button onclick="editToken(<?php echo $token['id']; ?>, '<?php echo $token['type']; ?>', <?php echo $token['doctor_id'] ?: 'null'; ?>, <?php echo $token['test_id'] ?: 'null'; ?>)" 
                                                class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700 mr-2 text-xs">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="confirmRefund(<?php echo $token['id']; ?>)" 
                                                class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-xs">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        <?php else: ?>
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center">
                                    <i class="fas fa-hourglass-end text-gray-400 text-4xl mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-1">No pending tokens</h3>
                                    <p class="text-gray-500">
                                        No pending tokens found for the selected date range.
                                    </p>
                                </td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Cancelled/Refunded Tokens Card -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-red-600 text-white px-6 py-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-undo-alt mr-2"></i>
                    Cancelled/Refunded Tokens Today
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Token No</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assigned To / Test</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cancelled At</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <?php if ($refunded_tokens && $refunded_tokens->num_rows > 0): ?>
                            <?php while ($token = $refunded_tokens->fetch_assoc()): ?>
                                <tr class="hover:bg-gray-50 transition-colors">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-red-100 text-red-800">
                                            <?php echo $token['token_no']; ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900"><?php echo $token['patient_name']; ?></div>
                                        <div class="text-sm text-gray-500">ID: <?php echo $token['patient_id']; ?></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-<?php echo $token['type'] === 'doctor' ? 'user-md' : 'flask'; ?> mr-1"></i>
                                            <?php echo ucfirst($token['type']); ?>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php 
                                        if ($token['type'] === 'doctor' && $token['doctor_name']) {
                                            echo "Dr. " . $token['doctor_name'];
                                        } elseif ($token['type'] === 'lab' && $token['test_name']) {
                                            echo $token['test_name'];
                                        } else {
                                            echo "Not assigned";
                                        }
                                        ?>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        <?php echo date('h:i A', strtotime($token['updated_at'])); ?>
                                    </td>
                                </tr>
                            <?php endwhile; ?>
                        <?php else: ?>
                            <tr>
                                <td colspan="5" class="px-6 py-12 text-center">
                                    <i class="fas fa-undo text-gray-400 text-4xl mb-4"></i>
                                    <h3 class="text-lg font-medium text-gray-900 mb-1">No cancelled tokens</h3>
                                    <p class="text-gray-500">No tokens have been cancelled today.</p>
                                </td>
                            </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Edit Token Modal -->
    <div id="editTokenModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEditModal()">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-indigo-600">
                <i class="fas fa-edit mr-2"></i>Edit Token
            </h2>
            <form method="post">
                <input type="hidden" id="edit_token_id" name="token_id">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Token Type</label>
                    <input type="text" id="edit_token_type" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                </div>
                <div id="edit_doctor_dropdown" class="mb-4">
                    <label for="edit_doctor_id" class="block text-gray-700 font-medium mb-2">Select Doctor</label>
                    <select id="edit_doctor_id" name="edit_doctor_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Doctor</option>
                        <?php 
                        if ($doctors) {
                            $doctors->data_seek(0);
                            while ($doctor = $doctors->fetch_assoc()): ?>
                                <option value="<?php echo $doctor['staff_id']; ?>">Dr. <?php echo $doctor['name']; ?></option>
                            <?php endwhile;
                        }
                        ?>
                    </select>
                </div>
                <div id="edit_test_dropdown" class="mb-4" style="display: none;">
                    <label for="edit_test_id" class="block text-gray-700 font-medium mb-2">Select Test</label>
                    <select id="edit_test_id" name="edit_test_id" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Select Test</option>
                        <?php 
                        if ($tests) {
                            $tests->data_seek(0);
                            while ($test = $tests->fetch_assoc()): ?>
                                <option value="<?php echo $test['id']; ?>"><?php echo $test['test_name']; ?> - <?php echo formatCurrency($test['price']); ?></option>
                            <?php endwhile;
                        }
                        ?>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                        Cancel
                    </button>
                    <button type="submit" name="update_token" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        <i class="fas fa-save mr-2"></i>Update Token
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Refund Confirmation Modal -->
    <div id="refundModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRefundModal()">&times;</span>
            <h2 class="text-xl font-semibold mb-4 text-red-600">
                <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Cancel
            </h2>
            <p class="mb-4">Are you sure you want to cancel this token? This will mark the token as cancelled and update the billing record to refunded status.</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeRefundModal()" 
                        class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                    Cancel
                </button>
                <form method="post" style="display: inline;">
                    <input type="hidden" id="refund_token_id" name="token_id">
                    <button type="submit" name="refund_token" 
                            class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">
                        <i class="fas fa-times mr-2"></i>Cancel Token
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Print Preview Modal -->
    <div id="printPreviewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePrintPreview()">&times;</span>
            <h3 class="text-xl font-bold mb-4">Token Preview</h3>
            <div id="thermalContent" class="thermal-print">
                <!-- Thermal print content will be inserted here -->
            </div>
            <div class="mt-4 flex justify-end space-x-3">
                <button onclick="window.print()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
                <button onclick="closePrintPreview()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Show/hide dropdowns based on token type
        document.getElementById('token_type').addEventListener('change', function() {
            const doctorDropdown = document.getElementById('doctor-dropdown');
            const testDropdown = document.getElementById('test-dropdown');
            
            if (this.value === 'doctor') {
                doctorDropdown.style.display = 'block';
                testDropdown.style.display = 'none';
                document.getElementById('test_id').removeAttribute('required');
            } else if (this.value === 'lab') {
                doctorDropdown.style.display = 'none';
                testDropdown.style.display = 'block';
                document.getElementById('test_id').setAttribute('required', 'required');
            } else {
                doctorDropdown.style.display = 'none';
                testDropdown.style.display = 'none';
                document.getElementById('test_id').removeAttribute('required');
            }
        });
        
        // Edit token function
        function editToken(tokenId, tokenType, doctorId, testId) {
            document.getElementById('edit_token_id').value = tokenId;
            document.getElementById('edit_token_type').value = tokenType.charAt(0).toUpperCase() + tokenType.slice(1);
            
            const editDoctorDropdown = document.getElementById('edit_doctor_dropdown');
            const editTestDropdown = document.getElementById('edit_test_dropdown');
            
            if (tokenType === 'doctor') {
                editDoctorDropdown.style.display = 'block';
                editTestDropdown.style.display = 'none';
                if (doctorId) {
                    document.getElementById('edit_doctor_id').value = doctorId;
                }
            } else {
                editDoctorDropdown.style.display = 'none';
                editTestDropdown.style.display = 'block';
                if (testId) {
                    document.getElementById('edit_test_id').value = testId;
                }
            }
            
            document.getElementById('editTokenModal').style.display = 'block';
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editTokenModal').style.display = 'none';
        }
        
        // Confirm refund
        function confirmRefund(tokenId) {
            document.getElementById('refund_token_id').value = tokenId;
            document.getElementById('refundModal').style.display = 'block';
        }
        
        // Close refund modal
        function closeRefundModal() {
            document.getElementById('refundModal').style.display = 'none';
        }
        
        // Close print preview
        function closePrintPreview() {
            document.getElementById('printPreviewModal').style.display = 'none';
        }
        
        // Show print preview with thermal print styling
        function showPrintPreview(tokenData) {
            const data = typeof tokenData === 'string' ? JSON.parse(tokenData) : tokenData;
            
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const currentTime = new Date().toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            const thermalHTML = `
                <div style="text-align: center; padding: 8px 0; border-bottom: 2px solid #000; margin-bottom: 8px;">
                    <div style="font-size: 14px; font-weight: bold; margin: 0; text-transform: uppercase;">LIFE CARE HOSPITAL</div>
                    <div style="font-size: 9px; margin: 1px 0; font-weight: normal;">Sector A GT road, Haripur</div>
                    <div style="font-size: 9px; margin: 1px 0; font-weight: normal;">Phone: (0995) 321234</div>
                </div>
                
                <div style="text-align: center; margin: 6px 0; padding: 4px; background: #f0f0f0; border-radius: 4px;">
                    <div style="font-size: 10px; font-weight: normal; margin: 0; color: #000;">TOKEN NUMBER</div>
                    <div style="font-size: 18px; font-weight: bold; margin: 1px 0; color: #000; letter-spacing: 1px;">${data.token_no}</div>
                    <div style="font-size: 9px; margin: 1px 0; color: #000;">
                        ${currentDate} | ${currentTime}
                    </div>
                </div>
                
                <div style="text-align: center; margin: 6px 0; padding: 4px; background: #e8f5e8; border-radius: 4px;">
                    <div style="font-size: 10px; font-weight: bold; margin: 0 0 1px 0; color: #000;">BILL INFORMATION</div>
                    <div style="font-size: 10px; font-weight: bold; margin: 1px 0; color: #000;">Bill ID: ${data.bill_id || 'N/A'}</div>
                    <div style="font-size: 10px; font-weight: bold; margin: 1px 0; color: #000;">Amount: PKR ${parseFloat(data.amount).toFixed(2)}</div>
                    <div style="font-size: 10px; font-weight: bold; margin: 1px 0; color: #000;">Status: PAID</div>
                </div>
                
                <div style="margin: 8px 0; padding: 4px; border-left: 4px solid #000; background: #f8f9fa;">
                    <div style="font-size: 10px; font-weight: bold; margin: 0 0 1px 0; color: #000;">TOKEN TYPE</div>
                    <div style="font-size: 12px; font-weight: bold; margin: 0 0 1px 0; color: #000; text-transform: uppercase;">${data.token_type.charAt(0).toUpperCase() + data.token_type.slice(1)} Token</div>
                    <div style="font-size: 9px; margin: 1px 0; color: #000;">ASSIGNED TO:</div>
                    <div style="font-size: 10px; font-weight: bold; margin: 0; color: #000;">${data.assigned_to}</div>
                </div>
                
                <div style="margin: 8px 0; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
                    <div style="font-size: 10px; font-weight: bold; margin: 0 0 4px 0; text-align: center; text-transform: uppercase; color: #000; border-bottom: 1px solid #ddd; padding-bottom: 2px;">Patient Information</div>
                    <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                        <span style="font-weight: bold; color: #000;">ID:</span>
                        <span style="font-weight: bold; color: #000;">${data.patient_id}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 2px 0;">
                        <span style="font-weight: bold; color: #000;">Name:</span>
                        <span style="font-weight: bold; color: #000; max-width: 150px; text-align: right;">${data.patient_name}</span>
                    </div>
                </div>
                
                <div style="margin: 8px 0; padding: 4px; background: #f0f8ff; border-radius: 4px;">
                    <div style="font-size: 10px; font-weight: bold; margin: 0 0 1px 0; color: #000;">GENERATED BY</div>
                    <div style="font-size: 10px; font-weight: bold; margin: 0; color: #000;">${data.generated_by}</div>
                </div>
                
                <div style="margin: 10px 0; padding: 6px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; text-align: center;">
                    <div style="font-size: 10px; font-weight: bold; margin: 0 0 3px 0; color: #000;">⚠️ IMPORTANT INSTRUCTIONS</div>
                    <div style="font-size: 8px; margin: 1px 0; color: #000;">• Please wait for your turn to be called</div>
                    <div style="font-size: 8px; margin: 1px 0; color: #000;">• Keep this token safe for verification</div>
                    <div style="font-size: 8px; margin: 1px 0; color: #000;">• Present this token when called</div>
                </div>
                
                <div style="text-align: center; margin-top: 10px; padding-top: 6px; border-top: 1px dashed #000; font-size: 8px; color: #000;">
                    <div style="font-weight: bold; margin: 0 0 1px 0;">Thank you for choosing Life Care Hospital</div>
                    <div style="margin: 0 0 1px 0;">We value your health and time</div>
                    <div style="font-size: 7px; margin: 3px 0 0 0; color: #666;">Generated on: ${new Date().toLocaleString()}</div>
                </div>
            `;
            
            document.getElementById('thermalContent').innerHTML = thermalHTML;
            document.getElementById('printPreviewModal').style.display = 'block';
        }
        
        // Form validation
        document.getElementById('tokenForm').addEventListener('submit', function(e) {
            const tokenType = document.getElementById('token_type').value;
            const testId = document.getElementById('test_id').value;
            
            if (tokenType === 'lab' && !testId) {
                e.preventDefault();
                alert('Please select a test for lab token.');
                return false;
            }
        });
        
        // Auto-focus on patient selection after page load
        window.addEventListener('load', function() {
            document.getElementById('patient_id').focus();
        });
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const editModal = document.getElementById('editTokenModal');
            const refundModal = document.getElementById('refundModal');
            const printModal = document.getElementById('printPreviewModal');
            
            if (event.target === editModal) {
                editModal.style.display = 'none';
            }
            if (event.target === refundModal) {
                refundModal.style.display = 'none';
            }
            if (event.target === printModal) {
                printModal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
=== END: token.txt ===

=== START: view_birth_records.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get filter parameters
$filter = isset($_GET['filter']) ? $_GET['filter'] : 'all';
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-01');
$end_date = isset($_GET['end_date']) ? $_GET['end_date'] : date('Y-m-d');

// Get birth records based on filter
if ($filter === 'date_range') {
    $birth_records = getBirthRecordsByDateRange($start_date, $end_date);
} else {
    $birth_records = getAllBirthRecords();
}

// Get statistics
$birth_stats = getBirthStatistics($start_date, $end_date);
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Birth Records</h1>
    <p class="text-gray-600">View and manage all birth records</p>
</div>

<!-- Filter Section -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Filter Records</h2>
    <form method="get" action="view_birth_records.php" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label for="filter" class="block text-gray-700 font-medium mb-2">Filter Type</label>
            <select id="filter" name="filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleDateFields()">
                <option value="all" <?php echo $filter === 'all' ? 'selected' : ''; ?>>All Records</option>
                <option value="date_range" <?php echo $filter === 'date_range' ? 'selected' : ''; ?>>Date Range</option>
            </select>
        </div>
        
        <div id="start-date-field" class="<?php echo $filter !== 'date_range' ? 'hidden' : ''; ?>">
            <label for="start_date" class="block text-gray-700 font-medium mb-2">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="<?php echo $start_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div id="end-date-field" class="<?php echo $filter !== 'date_range' ? 'hidden' : ''; ?>">
            <label for="end_date" class="block text-gray-700 font-medium mb-2">End Date</label>
            <input type="date" id="end_date" name="end_date" value="<?php echo $end_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                Apply Filter
            </button>
        </div>
    </form>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-500">
                <i class="fas fa-baby text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Total Births</h2>
                <p class="text-2xl font-bold"><?php echo $birth_stats['total_births'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-500">
                <i class="fas fa-mars text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Male Births</h2>
                <p class="text-2xl font-bold"><?php echo $birth_stats['male_births'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-pink-100 text-pink-500">
                <i class="fas fa-venus text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Female Births</h2>
                <p class="text-2xl font-bold"><?php echo $birth_stats['female_births'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-weight text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Avg Weight</h2>
                <p class="text-2xl font-bold"><?php echo $birth_stats['avg_weight'] ? round($birth_stats['avg_weight'], 2) . ' kg' : 'N/A'; ?></p>
            </div>
        </div>
    </div>
</div>

<!-- Birth Records Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">Birth Records</h2>
        <div class="space-x-2">
            <a href="add_birth_record.php" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Birth Record
            </a>
            <a href="birth_death_records.php" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
                <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Certificate No</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Newborn Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parents</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php if ($birth_records->num_rows > 0): ?>
                    <?php while ($record = $birth_records->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium"><?php echo $record['certificate_number']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo htmlspecialchars($record['newborn_name']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div><strong>Father:</strong> <?php echo htmlspecialchars($record['father_name']); ?></div>
                                    <div><strong>Mother:</strong> <?php echo htmlspecialchars($record['mother_name']); ?></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div><?php echo date('d M Y', strtotime($record['date_of_birth'])); ?></div>
                                    <div class="text-gray-500"><?php echo date('h:i A', strtotime($record['time_of_birth'])); ?></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full <?php echo $record['gender'] === 'Male' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'; ?>">
                                    <?php echo $record['gender']; ?>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <?php echo $record['weight'] ? $record['weight'] . ' kg' : 'N/A'; ?>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                <a href="birth_record_details.php?id=<?php echo $record['id']; ?>" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye mr-1"></i> View
                                </a>
                                <a href="birth_certificates.php?id=<?php echo $record['id']; ?>" class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-certificate mr-1"></i> Certificate
                                </a>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">No birth records found</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<script>
function toggleDateFields() {
    const filter = document.getElementById('filter').value;
    const startField = document.getElementById('start-date-field');
    const endField = document.getElementById('end-date-field');
    
    if (filter === 'date_range') {
        startField.classList.remove('hidden');
        endField.classList.remove('hidden');
    } else {
        startField.classList.add('hidden');
        endField.classList.add('hidden');
    }
}
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: view_birth_records.txt ===

=== START: view_death_records.txt ===
<?php
require_once __DIR__ . '/../../includes/functions.php';
requireRole('reception');

// Get filter parameters
$filter = isset($_GET['filter']) ? $_GET['filter'] : 'all';
$start_date = isset($_GET['start_date']) ? $_GET['start_date'] : date('Y-m-01');
$end_date = isset($_GET['end_date']) ? $_GET['end_date'] : date('Y-m-d');

// Get death records based on filter
if ($filter === 'date_range') {
    $death_records = getDeathRecordsByDateRange($start_date, $end_date);
} else {
    $death_records = getAllDeathRecords();
}

// Get statistics
$death_stats = getDeathStatistics($start_date, $end_date);
?>

<?php include __DIR__ . '/../../includes/header.php'; ?>

<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Death Records</h1>
    <p class="text-gray-600">View and manage all death records</p>
</div>

<!-- Filter Section -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-4">Filter Records</h2>
    <form method="get" action="view_death_records.php" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label for="filter" class="block text-gray-700 font-medium mb-2">Filter Type</label>
            <select id="filter" name="filter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleDateFields()">
                <option value="all" <?php echo $filter === 'all' ? 'selected' : ''; ?>>All Records</option>
                <option value="date_range" <?php echo $filter === 'date_range' ? 'selected' : ''; ?>>Date Range</option>
            </select>
        </div>
        
        <div id="start-date-field" class="<?php echo $filter !== 'date_range' ? 'hidden' : ''; ?>">
            <label for="start_date" class="block text-gray-700 font-medium mb-2">Start Date</label>
            <input type="date" id="start_date" name="start_date" value="<?php echo $start_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div id="end-date-field" class="<?php echo $filter !== 'date_range' ? 'hidden' : ''; ?>">
            <label for="end_date" class="block text-gray-700 font-medium mb-2">End Date</label>
            <input type="date" id="end_date" name="end_date" value="<?php echo $end_date; ?>" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                Apply Filter
            </button>
        </div>
    </form>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-500">
                <i class="fas fa-heart-broken text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Total Deaths</h2>
                <p class="text-2xl font-bold"><?php echo $death_stats['total_deaths'] ?: 0; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-500">
                <i class="fas fa-chart-line text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Average Age</h2>
                <p class="text-2xl font-bold"><?php echo $death_stats['avg_age_at_death'] ? round($death_stats['avg_age_at_death']) . ' years' : 'N/A'; ?></p>
            </div>
        </div>
    </div>
    
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-500">
                <i class="fas fa-search text-xl"></i>
            </div>
            <div class="ml-4">
                <h2 class="text-lg font-semibold text-gray-700">Autopsy Cases</h2>
                <p class="text-2xl font-bold"><?php echo $death_stats['autopsy_cases'] ?: 0; ?></p>
            </div>
        </div>
    </div>
</div>

<!-- Death Records Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="p-4 border-b border-gray-200 flex justify-between items-center">
        <h2 class="text-lg font-semibold text-gray-800">Death Records</h2>
        <div class="space-x-2">
            <a href="add_death_record.php" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 text-sm">
                <i class="fas fa-plus mr-1"></i> Add Death Record
            </a>
            <a href="birth_death_records.php" class="bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
                <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Certificate No</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deceased Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Father's Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Death</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Age</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Next of Kin</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                <?php if ($death_records->num_rows > 0): ?>
                    <?php while ($record = $death_records->fetch_assoc()): ?>
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium"><?php echo $record['certificate_number']; ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo htmlspecialchars($record['deceased_name']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap"><?php echo htmlspecialchars($record['father_name']); ?></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div><?php echo date('d M Y', strtotime($record['date_of_death'])); ?></div>
                                    <div class="text-gray-500"><?php echo date('h:i A', strtotime($record['time_of_death'])); ?></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-medium"><?php echo $record['age_at_death']; ?> years</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm">
                                    <div><strong><?php echo htmlspecialchars($record['next_of_kin']); ?></strong></div>
                                    <div class="text-gray-500"><?php echo htmlspecialchars($record['next_of_kin_relation']); ?></div>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                <a href="death_record_details.php?id=<?php echo $record['id']; ?>" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye mr-1"></i> View
                                </a>
                                <a href="death_certificates.php?id=<?php echo $record['id']; ?>" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-certificate mr-1"></i> Certificate
                                </a>
                                <?php if ($record['autopsy_required']): ?>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                        <i class="fas fa-search mr-1"></i> Autopsy
                                    </span>
                                <?php endif; ?>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                <?php else: ?>
                    <tr>
                        <td colspan="7" class="px-6 py-4 text-center text-gray-500">No death records found</td>
                    </tr>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</div>

<script>
function toggleDateFields() {
    const filter = document.getElementById('filter').value;
    const startField = document.getElementById('start-date-field');
    const endField = document.getElementById('end-date-field');
    
    if (filter === 'date_range') {
        startField.classList.remove('hidden');
        endField.classList.remove('hidden');
    } else {
        startField.classList.add('hidden');
        endField.classList.add('hidden');
    }
}
</script>

<?php include __DIR__ . '/../../includes/footer.php'; ?>
=== END: view_death_records.txt ===

=== START: bio_chemistry_2_1757762505.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #dc2626;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #dc2626; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Ayesha Khan &nbsp;&nbsp;&nbsp; Age: 32 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 13/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>BIO CHEMISTRY REPORT</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>BLOOD GLUCOSE LEVELS</strong></td></tr><tr class="category-header"><td colspan="4"><strong>CARDIAC ENZYMES</strong></td></tr><tr>
                        <td>SGOT (AST)</td>
                        <td class="result-value">werwer</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Upto: 38</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>LIVER FUNCTION TEST</strong></td></tr><tr class="category-header"><td colspan="4"><strong>RENAL FUNCTION TEST</strong></td></tr><tr class="category-header"><td colspan="4"><strong>LIPID PROFILE</strong></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 13/09/2025 at 01:21 PM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: bio_chemistry_2_1757762505.html ===

=== START: bio_chemistry_2_1757762571.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #dc2626;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #dc2626; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Ayesha Khan &nbsp;&nbsp;&nbsp; Age: 32 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 13/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>BIO CHEMISTRY REPORT</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>BLOOD GLUCOSE LEVELS</strong></td></tr><tr>
                        <td>Glucose (Fasting)</td>
                        <td class="result-value">f</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">60 - 110</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>CARDIAC ENZYMES</strong></td></tr><tr>
                        <td>SGOT (AST)</td>
                        <td class="result-value">f</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Upto: 38</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>LIVER FUNCTION TEST</strong></td></tr><tr>
                        <td>Bilirubin (Total)</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 1.0
After 1 Week: 5.0</td><td colspan="4"></td></tr><tr>
                        <td>Bilirubin (Indirect)</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 0.8</td><td colspan="4"></td></tr><tr>
                        <td>Alkaline Phosphatase</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Male: 80-306
Female: 64-306
Children: Upto: 644</td><td colspan="4"></td></tr><tr>
                        <td>Protein (Total)</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">G/dl</td>
                        <td style="font-size: 9px;">Premature: 3.6 - 7.0
Children: 5.1 - 7.5
Adults: 6.0 - 8.3</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>RENAL FUNCTION TEST</strong></td></tr><tr>
                        <td>Creatinine</td>
                        <td class="result-value">f</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 1.1</td><td colspan="4"></td></tr><tr>
                        <td>BUN</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">15 - 40</td><td colspan="4"></td></tr><tr>
                        <td>Calcium</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">8.1 - 10.4</td><td colspan="4"></td></tr><tr>
                        <td>CPK-MB</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">05-24</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>LIPID PROFILE</strong></td></tr><tr>
                        <td>HDL Cholesterol</td>
                        <td class="result-value">f</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Male: &gt;55
Female: &gt;65</td><td colspan="4"></td></tr><tr>
                        <td>LDL Cholesterol</td>
                        <td class="result-value">f</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Borderline: &lt;130
Suspicious: &lt;130
Elevated: &lt;190</td><td colspan="4"></td></tr><tr>
                        <td>VLDL Cholesterol</td>
                        <td class="result-value">s</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">03 - 32</td><td colspan="4"></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 13/09/2025 at 01:22 PM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: bio_chemistry_2_1757762571.html ===

=== START: bio_chemistry_2_1757762856.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #dc2626;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #dc2626; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Ayesha Khan &nbsp;&nbsp;&nbsp; Age: 32 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 13/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>BIO CHEMISTRY REPORT</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                    <th style="width: 15%">TEST</th>
                    <th style="width: 10%">RESULT</th>
                    <th style="width: 8%">UNIT</th>
                    <th style="width: 17%">REF. RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>BLOOD GLUCOSE LEVELS</strong></td></tr><tr>
                        <td>Glucose (Fasting)</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">60 - 110</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>CARDIAC ENZYMES</strong></td></tr><tr>
                        <td>SGOT (AST)</td>
                        <td class="result-value">123</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Upto: 38</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>LIVER FUNCTION TEST</strong></td></tr><tr>
                        <td>Bilirubin (Total)</td>
                        <td class="result-value">1231321</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 1.0
After 1 Week: 5.0</td><td colspan="4"></td></tr><tr>
                        <td>Bilirubin (Direct)</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 0.4</td><td colspan="4"></td></tr><tr>
                        <td>Bilirubin (Indirect)</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 0.8</td><td colspan="4"></td></tr><tr>
                        <td>Alkaline Phosphatase</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Male: 80-306
Female: 64-306
Children: Upto: 644</td><td colspan="4"></td></tr><tr>
                        <td>Gamma GT</td>
                        <td class="result-value">131231</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">Male: Upto: 51
Female: Upto: 30</td><td colspan="4"></td></tr><tr>
                        <td>Albumin</td>
                        <td class="result-value">12313</td>
                        <td style="text-align: center;">G/dl</td>
                        <td style="font-size: 9px;">3.5 - 5.5</td><td colspan="4"></td></tr><tr>
                        <td>Globulins</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">G/dl</td>
                        <td style="font-size: 9px;">1.5 - 3.0</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>RENAL FUNCTION TEST</strong></td></tr><tr>
                        <td>Blood Urea</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">up to : 50</td><td colspan="4"></td></tr><tr>
                        <td>Uric Acid</td>
                        <td class="result-value">13123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Male: 3.4 - 7.0
Female: 2.4 - 5.7
Children: 2.0 - 5.5</td><td colspan="4"></td></tr><tr>
                        <td>Sodium</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mmol/L</td>
                        <td style="font-size: 9px;">135 - 145</td><td colspan="4"></td></tr><tr>
                        <td>Calcium</td>
                        <td class="result-value">123132</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">8.1 - 10.4</td><td colspan="4"></td></tr><tr>
                        <td>Phosphorous</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Premature: 4.0-8.0
Children: 2.5-6.0
Adults: 2.7-4.5</td><td colspan="4"></td></tr><tr>
                        <td>CPK-MB</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">U/L</td>
                        <td style="font-size: 9px;">05-24</td><td colspan="4"></td></tr><tr class="category-header"><td colspan="4"><strong>LIPID PROFILE</strong></td></tr><tr>
                        <td>Cholesterol</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Adults: &lt; 190</td><td colspan="4"></td></tr><tr>
                        <td>HDL Cholesterol</td>
                        <td class="result-value">123123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Male: &gt;55
Female: &gt;65</td><td colspan="4"></td></tr><tr>
                        <td>LDL Cholesterol</td>
                        <td class="result-value">131231</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">Borderline: &lt;130
Suspicious: &lt;130
Elevated: &lt;190</td><td colspan="4"></td></tr><tr>
                        <td>VLDL Cholesterol</td>
                        <td class="result-value">13123</td>
                        <td style="text-align: center;">mg/dl</td>
                        <td style="font-size: 9px;">03 - 32</td><td colspan="4"></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 13/09/2025 at 01:27 PM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: bio_chemistry_2_1757762856.html ===

=== START: haematology_4_1757763100.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #dc2626;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #dc2626 0%, #dc2626 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #dc2626; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Fatima Zahra &nbsp;&nbsp;&nbsp; Age: 60 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 13/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>HAEMATOLOGY REPORT</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 30%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 15%">UNIT</th>
                    <th style="width: 30%">REFERENCE RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>HAEMATOLOGY REPORT</strong></td></tr><tr>
                        <td>R.B.C Count</td>
                        <td class="result-value">4564</td>
                        <td style="text-align: center;">Million/Cmm</td>
                        <td style="font-size: 9px;">4.25-5.9</td></tr><tr class="category-header"><td colspan="4"><strong>Different Leukocyte Count (DLC)</strong></td></tr><tr class="category-header"><td colspan="4"><strong>ESR</strong></td></tr><tr class="category-header"><td colspan="4"><strong>RBC MORPHOLOGY</strong></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 13/09/2025 at 01:31 PM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: haematology_4_1757763100.html ===

=== START: report_5_1757745345.txt ===
LAB REPORT
==========

Patient ID: 5
Patient Name: Bilal Ahmed
Test Name: CBC (Complete Blood Count)
Date: 2025-09-13 08:35:45
Lab Technician: admin

Test Results:
=============
Hemoglobin: _____ g/dL (Normal: 12-16 g/dL)
WBC: _____ /µL (Normal: 4,000-11,000/µL)
RBC: _____ million/µL (Normal: 4.0-5.5 million/µL)
Platelets: _____ /µL (Normal: 150,000-450,000/µL)
Hematocrit: _____ % (Normal: 36-46%)

Remarks: 


End of Report

=== END: report_5_1757745345.txt ===

=== START: report_7_1757746083.txt ===
LAB REPORT
==========

Patient ID: 7
Patient Name: haram 
Test Name: LFT (Liver Function Test)
Date: 2025-09-13 08:48:03
Lab Technician: admin

Test Results:
=============
Bilirubin Total: _____ mg/dL (Normal: 0.3-1.2 mg/dL)
Bilirubin Direct: _____ mg/dL (Normal: 0.0-0.3 mg/dL)
ALT (SGPT): _____ U/L (Normal: 7-56 U/L)
AST (SGOT): _____ U/L (Normal: 10-40 U/L)
ALP: _____ U/L (Normal: 44-147 U/L)
Albumin: _____ g/dL (Normal: 3.5-5.0 g/dL)

Remarks: 


End of Report

=== END: report_7_1757746083.txt ===

=== START: urine_analysis_8_1757765593.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #2563eb;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #2563eb; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Junaid  &nbsp;&nbsp;&nbsp; Age: 23 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 13/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>URINE ANALYSIS</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 30%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 15%">UNIT</th>
                    <th style="width: 30%">REFERENCE RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>PHYSICAL ANALYSIS</strong></td></tr><tr>
                        <td>Colour</td>
                        <td class="result-value">1</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Pale Yellow</td></tr><tr>
                        <td>Turbidity</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil</td></tr><tr>
                        <td>pH</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">5.0-6.0</td></tr><tr>
                        <td>Glucose</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil</td></tr><tr>
                        <td>Ketones</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil</td></tr><tr class="category-header"><td colspan="4"><strong>MICROSCOPIC ANALYSIS</strong></td></tr><tr>
                        <td>Amorphous Urates</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil / HPF</td></tr><tr>
                        <td>Spermatozoa</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil / HPF</td></tr><tr>
                        <td>Bacteria</td>
                        <td class="result-value">12</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;">Nil / HPF</td></tr><tr class="category-header"><td colspan="4"><strong>CRYSTALS</strong></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 13/09/2025 at 02:13 PM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: urine_analysis_8_1757765593.html ===

=== START: urine_analysis_9_1757812980.html ===
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Lab Report - Shahmir Laboratory</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 15px;
            font-size: 11px;
        }
        .shahmir-header {
            background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
            color: white;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        .shahmir-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-circle {
            width: 60px;
            height: 60px;
            border: 3px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            font-size: 24px;
        }
        .report-table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
            font-size: 10px;
        }
        .report-table th,
        .report-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
            vertical-align: top;
        }
        .report-table th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-align: center;
            font-size: 9px;
        }
        .category-header {
            background-color: #e5e5e5 !important;
            font-weight: bold;
            text-align: center;
            color: #2563eb;
            font-size: 10px;
        }
        .hospital-footer {
            background: linear-gradient(135deg, #2563eb 0%, #2563eb 100%);
            color: white;
            padding: 8px;
            text-align: center;
            border-radius: 0 0 8px 8px;
            font-size: 9px;
            margin-top: 15px;
        }
        .patient-info-row {
            margin: 10px 0;
            font-size: 11px;
        }
        h2 { color: #2563eb; font-size: 18px; margin: 20px 0; }
        @media print {
            body { margin: 0; padding: 10px; }
        }
        .result-value {
            font-weight: bold;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="shahmir-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div class="shahmir-logo">
                <div class="logo-circle">🔬</div>
                <div>
                    <h1 style="font-size: 24px; font-weight: bold; margin: 0;">Shahmir Laboratory</h1>
                    <p style="font-size: 12px; opacity: 0.9; margin: 0;">Facility Available for Multi Lab Collection</p>
                </div>
            </div>
            <div style="text-align: right; font-size: 12px;">
                <p><strong>Timings</strong></p>
                <p>Monday-Sunday: Open Round The Clock</p>
            </div>
        </div>
        <div class="patient-info-row">
            Name: Haram &nbsp;&nbsp;&nbsp; Age: 23 &nbsp;&nbsp;&nbsp; Sex: Female &nbsp;&nbsp;&nbsp; Date: 14/09/2025
        </div>
        <div style="font-size: 11px;">
            Referred By: .........................................................................................................................................
        </div>
    </div>
    
    <h2>URINE ANALYSIS</h2><table class="report-table">
                <thead><tr>
                    <th style="width: 30%">TEST</th>
                    <th style="width: 25%">RESULT</th>
                    <th style="width: 15%">UNIT</th>
                    <th style="width: 30%">REFERENCE RANGE</th>
                </tr></thead><tbody><tr class="category-header"><td colspan="4"><strong>PHYSICAL ANALYSIS</strong></td></tr><tr>
                        <td>Colour</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Turbidity</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>pH</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Specific Gravity</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Albumin (Protein)</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Blood</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Ketones</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Nitrate</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr>
                        <td>Bilirubin</td>
                        <td class="result-value">2</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr class="category-header"><td colspan="4"><strong>MICROSCOPIC ANALYSIS</strong></td></tr><tr>
                        <td>Epithelial Cells</td>
                        <td class="result-value">1</td>
                        <td style="text-align: center;"></td>
                        <td style="font-size: 9px;"></td></tr><tr class="category-header"><td colspan="4"><strong>CRYSTALS</strong></td></tr></tbody></table><div style="margin-top: 30px;">
        <p><strong>Technician:</strong> admin</p>
        <p><strong>Remarks:</strong> </p>
        <p><strong>Date & Time:</strong> 14/09/2025 at 03:23 AM</p>
    </div>
    
    <div style="font-size: 10px; color: #dc2626; margin: 20px 0;">
        <strong>Not for Medico legal / Court use</strong><br>
        <strong>Please Call For Free Repeat Blood Test Within 24 Hours.</strong>
    </div>
    
    <div class="hospital-footer">
        <p style="font-weight: bold;">LIFE CARE HOSPITAL Maternity Home & Pain Clinic Naseem Town Opposite Utman Marriage Hall Haripur</p>
        <p style="font-size: 8px;">Contact: 0332-2400010, 0346-5888603, Phone: 0995-321234</p>
    </div>
</body>
</html>
=== END: urine_analysis_9_1757812980.html ===

